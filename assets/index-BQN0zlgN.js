var j=Object.defineProperty;var U=(a,e,t)=>e in a?j(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var q=(a,e,t)=>U(a,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();function F(a){return!Number.isFinite(a)||a<0||a>127?440:440*Math.pow(2,(a-69)/12)}function Y(a,{attack:e=.01,decay:t=.1,sustain:s=.7,release:i=.3}={}){const n=a.createGain();return n.gain.value=0,{node:n,trigger(o=a.currentTime,c=1){const r=o;n.gain.cancelScheduledValues(r),n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(c,r+e),n.gain.linearRampToValueAtTime(s*c,r+e+t)},release(o=a.currentTime){const c=o;return n.gain.cancelScheduledValues(c),n.gain.setValueAtTime(n.gain.value,c),n.gain.exponentialRampToValueAtTime(.001,c+i),i}}}function H(a,{type:e="sine",rate:t=1,depth:s=1}={}){const i=a.createOscillator(),n=a.createGain();return i.type=e,i.frequency.value=t,n.gain.value=s,i.connect(n),i.start(),{output:n,setRate(o){i.frequency.value=o},setDepth(o){n.gain.value=o},connect(o){n.connect(o)},stop(){i.stop()}}}function z(a,{type:e="lowpass",frequency:t=2e3,Q:s=1,envAmount:i=0}={}){const n=a.createBiquadFilter();return n.type=e,n.frequency.value=t,n.Q.value=s,{node:n,baseFreq:t,envAmount:i,modulateWithEnvelope(o,c){const r=this.baseFreq+o*this.envAmount;n.frequency.setTargetAtTime(Math.max(20,Math.min(2e4,r)),c,.01)},setFrequency(o){this.baseFreq=o,n.frequency.value=o}}}function W(a,e,t={}){const{oscTypes:s=["sawtooth","sawtooth","square","triangle"],oscDetune:i=[0,7,-5,12],oscMix:n=[.4,.3,.2,.1],filterFreq:o=2e3,filterQ:c=2,filterEnvAmount:r=3e3,ampEnv:u={attack:.01,decay:.2,sustain:.6,release:.4},filterEnv:d={attack:.01,decay:.3,sustain:.3,release:.3},lfoRate:h=.5,lfoDepth:f=10,velocity:m=.8}=t,g=a.currentTime,y=s.map((T,V)=>{const E=a.createOscillator(),L=a.createGain();return E.type=T,E.frequency.value=e,E.detune.value=i[V]||0,L.gain.value=n[V]||.25,E.connect(L),E.start(g),{osc:E,gain:L}}),M=a.createGain();y.forEach(T=>T.gain.connect(M));const b=z(a,{frequency:o,Q:c,envAmount:r});M.connect(b.node);const x=Y(a,u);b.node.connect(x.node);const k=H(a,{rate:h,depth:f});y.forEach(T=>k.connect(T.osc.detune));const l=a.createGain();l.gain.setValueAtTime(0,g),l.gain.linearRampToValueAtTime(1,g+d.attack),l.gain.linearRampToValueAtTime(d.sustain,g+d.attack+d.decay),x.trigger(g,m*.5);const p=a.createGain();return p.gain.value=.7,x.node.connect(p),{output:p,release(T=0){const V=a.currentTime+T,E=x.release(V);return setTimeout(()=>{y.forEach(L=>{L.osc.stop(),L.osc.disconnect(),L.gain.disconnect()}),k.stop(),M.disconnect(),b.node.disconnect(),x.node.disconnect(),p.disconnect()},(E+.1)*1e3),E}}}function Q(a,e,t={}){const{algorithm:s=1,operators:i=[{ratio:1,level:1,env:{attack:.01,decay:.2,sustain:.6,release:.3}},{ratio:2,level:.5,env:{attack:.01,decay:.4,sustain:.2,release:.2}},{ratio:3,level:.3,env:{attack:.01,decay:.3,sustain:.1,release:.2}},{ratio:4,level:.2,env:{attack:.01,decay:.2,sustain:.05,release:.1}}],velocity:n=.8}=t,o=a.currentTime,c=.3+n*.4,r=i.map((h,f)=>{const m=a.createOscillator(),g=a.createGain(),y=a.createGain();return m.type="sine",m.frequency.value=e*h.ratio,g.gain.value=h.level*e,y.gain.setValueAtTime(0,o),y.gain.linearRampToValueAtTime(1,o+h.env.attack),y.gain.linearRampToValueAtTime(h.env.sustain,o+h.env.attack+h.env.decay),m.connect(g),g.connect(y),m.start(o),{osc:m,gain:g,env:y,params:h}}),u=a.createGain();switch(u.gain.value=c,s){case 1:r[3].env.connect(r[2].osc.frequency),r[2].env.connect(r[1].osc.frequency),r[1].env.connect(r[0].osc.frequency),r[0].env.connect(u);break;case 2:r[3].env.connect(r[2].osc.frequency),r[2].env.connect(r[0].osc.frequency),r[1].env.connect(r[0].osc.frequency),r[0].env.connect(u);break;case 3:r[3].env.connect(r[0].osc.frequency),r[2].env.connect(r[0].osc.frequency),r[1].env.connect(r[0].osc.frequency),r[0].env.connect(u);break;case 4:default:r[3].env.connect(r[2].osc.frequency),r[2].env.connect(u),r[1].env.connect(r[0].osc.frequency),r[0].env.connect(u);break}const d=a.createGain();return d.gain.value=.7,u.connect(d),{output:d,release(h=0){const f=a.currentTime+h,m=.3;return r.forEach(g=>{g.env.gain.cancelScheduledValues(f),g.env.gain.setValueAtTime(g.env.gain.value,f),g.env.gain.exponentialRampToValueAtTime(.001,f+m),g.osc.stop(f+m)}),setTimeout(()=>{r.forEach(g=>{g.osc.disconnect(),g.gain.disconnect(),g.env.disconnect()}),u.disconnect(),d.disconnect()},(m+.1)*1e3),m}}}function X(a,e,t={}){const{tineLevel:s=.6,barkLevel:i=.3,velocity:n=.8,hardness:o=.5}=t,c=a.currentTime,r=.3+n*.4,u=(.5+o)*n,d=a.createOscillator();d.type="sine",d.frequency.value=e;const h=a.createOscillator(),f=a.createGain();h.type="sine",h.frequency.value=e,f.gain.setValueAtTime(e*u*s,c),f.gain.exponentialRampToValueAtTime(e*.1*s,c+.5),h.connect(f),f.connect(d.frequency);const m=a.createOscillator(),g=a.createGain();m.type="sine",m.frequency.value=e*7,g.gain.setValueAtTime(e*.3*i*n,c),g.gain.exponentialRampToValueAtTime(.001,c+.15),m.connect(g),g.connect(d.frequency);const y=a.createOscillator(),M=a.createGain();y.type="sine",y.frequency.value=e*2,M.gain.value=.15,y.connect(M);const b=a.createGain();b.gain.setValueAtTime(0,c),b.gain.linearRampToValueAtTime(r,c+.005),b.gain.exponentialRampToValueAtTime(r*.6,c+.1),b.gain.setTargetAtTime(r*.4,c+.1,1.5),d.connect(b),M.connect(b);const x=a.createGain();return x.gain.value=.5,b.connect(x),d.start(c),h.start(c),m.start(c),y.start(c),{output:x,release(k=0){const l=a.currentTime+k,p=.4;return b.gain.cancelScheduledValues(l),b.gain.setValueAtTime(b.gain.value,l),b.gain.exponentialRampToValueAtTime(.001,l+p),d.stop(l+p),h.stop(l+p),m.stop(l+p),y.stop(l+p),setTimeout(()=>{d.disconnect(),h.disconnect(),m.disconnect(),y.disconnect(),f.disconnect(),g.disconnect(),M.disconnect(),b.disconnect(),x.disconnect()},(p+.1)*1e3),p}}}const Z={VA:W,FM:Q,EP:X},J={id:"orchid-ep",name:"Orchid EP",category:"keys",engine:"EP",params:{tineLevel:.6,barkLevel:.25,hardness:.5},createVoice(a,e,t=.8){return Z.EP(a,e,{...this.params,velocity:t})}},ee={id:"analog-flower",name:"Analog Flower",category:"pad",createVoice(a,e,t=.8){const s=a.currentTime,i=.25+t*.35,n=[],o=[-12,-5,5,12],c=a.createGain();c.gain.value=.4,o.forEach(m=>{const g=a.createOscillator();g.type="sawtooth",g.frequency.value=e,g.detune.value=m;const y=a.createGain();y.gain.value=.28,g.connect(y),y.connect(c),g.start(s),n.push({osc:g,gain:y})});const r=a.createBiquadFilter();r.type="lowpass",r.frequency.value=600,r.Q.value=.7,r.frequency.setValueAtTime(400,s),r.frequency.linearRampToValueAtTime(1200,s+.8),r.frequency.setTargetAtTime(900,s+.8,1),c.connect(r);const u=a.createGain();u.gain.setValueAtTime(0,s),u.gain.linearRampToValueAtTime(i,s+.4),u.gain.setTargetAtTime(i*.8,s+.5,.5),r.connect(u);const d=a.createOscillator(),h=a.createGain();d.type="triangle",d.frequency.value=.4,h.gain.value=3,d.connect(h),n.forEach(m=>h.connect(m.osc.detune)),d.start(s);const f=a.createGain();return f.gain.value=.8,u.connect(f),{output:f,release(m=0){const g=a.currentTime+m,y=1.2;return u.gain.cancelScheduledValues(g),u.gain.setValueAtTime(u.gain.value,g),u.gain.exponentialRampToValueAtTime(.001,g+y),r.frequency.setTargetAtTime(200,g,.3),n.forEach(M=>M.osc.stop(g+y)),d.stop(g+y),setTimeout(()=>{n.forEach(M=>{M.osc.disconnect(),M.gain.disconnect()}),d.disconnect(),h.disconnect(),c.disconnect(),r.disconnect(),u.disconnect(),f.disconnect()},(y+.1)*1e3),y}}}},te={id:"mellow-bells",name:"Mellow Bells",category:"keys",createVoice(a,e,t=.8){const s=a.currentTime,i=.2+t*.25,n=a.createOscillator();n.type="sine",n.frequency.value=e;const o=a.createOscillator(),c=a.createGain();o.type="sine",o.frequency.value=e*3;const r=e*.8*t;c.gain.setValueAtTime(r,s),c.gain.exponentialRampToValueAtTime(r*.1,s+.3),c.gain.setTargetAtTime(r*.02,s+.3,.8),o.connect(c),c.connect(n.frequency);const u=a.createOscillator(),d=a.createGain();u.type="sine",u.frequency.value=e*.5,d.gain.value=.15,u.connect(d);const h=a.createGain();h.gain.setValueAtTime(0,s),h.gain.linearRampToValueAtTime(i,s+.015),h.gain.exponentialRampToValueAtTime(i*.5,s+.2),h.gain.setTargetAtTime(i*.25,s+.2,1.5);const f=a.createBiquadFilter();f.type="lowpass",f.frequency.value=2500,f.Q.value=.5,n.connect(f),d.connect(f),f.connect(h);const m=a.createGain();return m.gain.value=.5,h.connect(m),n.start(s),o.start(s),u.start(s),{output:m,release(g=0){const y=a.currentTime+g,M=.8;return h.gain.cancelScheduledValues(y),h.gain.setValueAtTime(h.gain.value,y),h.gain.exponentialRampToValueAtTime(.001,y+M),n.stop(y+M),o.stop(y+M),u.stop(y+M),setTimeout(()=>{n.disconnect(),o.disconnect(),c.disconnect(),u.disconnect(),d.disconnect(),f.disconnect(),h.disconnect(),m.disconnect()},(M+.1)*1e3),M}}}},se={id:"warm-lead",name:"Warm Lead",category:"lead",createVoice(a,e,t=.8){const s=a.currentTime,i=.2+t*.25,n=a.createOscillator();n.type="square",n.frequency.value=e;const o=a.createOscillator();o.type="sine",o.frequency.value=e*.5;const c=a.createGain(),r=a.createGain();r.gain.value=.3,n.connect(r),r.connect(c);const u=a.createGain();u.gain.value=.2,o.connect(u),u.connect(c);const d=a.createBiquadFilter();d.type="lowpass",d.Q.value=2,d.frequency.setValueAtTime(300,s),d.frequency.linearRampToValueAtTime(1800*t,s+.08),d.frequency.setTargetAtTime(800,s+.1,.3),c.connect(d);const h=a.createGain();h.gain.setValueAtTime(0,s),h.gain.linearRampToValueAtTime(i,s+.02),h.gain.setTargetAtTime(i*.7,s+.1,.2),d.connect(h);const f=a.createOscillator(),m=a.createGain();f.type="sine",f.frequency.value=5,m.gain.setValueAtTime(0,s),m.gain.setTargetAtTime(6,s+.3,.2),f.connect(m),m.connect(n.detune),m.connect(o.detune),f.start(s);const g=a.createGain();return g.gain.value=.5,h.connect(g),n.start(s),o.start(s),{output:g,release(y=0){const M=a.currentTime+y,b=.25;return h.gain.cancelScheduledValues(M),h.gain.setValueAtTime(h.gain.value,M),h.gain.exponentialRampToValueAtTime(.001,M+b),d.frequency.setTargetAtTime(200,M,.1),n.stop(M+b),o.stop(M+b),f.stop(M+b),setTimeout(()=>{n.disconnect(),o.disconnect(),r.disconnect(),u.disconnect(),c.disconnect(),d.disconnect(),h.disconnect(),f.disconnect(),m.disconnect(),g.disconnect()},(b+.1)*1e3),b}}}},ie={id:"tape-strings",name:"Tape Strings",category:"pad",createVoice(a,e,t=.8){const s=a.currentTime,i=.3+t*.4,n=[],o=["sawtooth","sawtooth","triangle"],c=[-8,8,0],r=[.3,.3,.4],u=a.createGain();u.gain.value=.5,o.forEach((b,x)=>{const k=a.createOscillator();k.type=b,k.frequency.value=e,k.detune.value=c[x];const l=a.createGain();l.gain.value=r[x],k.connect(l),l.connect(u),k.start(s),n.push({osc:k,gain:l})});const d=a.createBiquadFilter();d.type="lowpass",d.frequency.value=1800,d.Q.value=.5,d.frequency.setValueAtTime(1200,s),d.frequency.linearRampToValueAtTime(2e3,s+.3),d.frequency.setTargetAtTime(1600,s+.4,.8),u.connect(d);const h=a.createOscillator(),f=a.createGain();h.type="sine",h.frequency.value=.3+Math.random()*.2,f.gain.value=4,h.connect(f),n.forEach(b=>f.connect(b.osc.detune)),h.start(s);const m=a.createOscillator(),g=a.createGain();m.type="sine",m.frequency.value=6,g.gain.value=1.5,m.connect(g),n.forEach(b=>g.connect(b.osc.detune)),m.start(s);const y=a.createGain();y.gain.setValueAtTime(0,s),y.gain.linearRampToValueAtTime(i*.7,s+.08),y.gain.linearRampToValueAtTime(i,s+.2),d.connect(y);const M=a.createGain();return M.gain.value=.5,y.connect(M),{output:M,release(b=0){const x=a.currentTime+b,k=.6;return y.gain.cancelScheduledValues(x),y.gain.setValueAtTime(y.gain.value,x),y.gain.exponentialRampToValueAtTime(.001,x+k),d.frequency.setTargetAtTime(400,x,.2),n.forEach(l=>l.osc.stop(x+k)),h.stop(x+k),m.stop(x+k),setTimeout(()=>{n.forEach(l=>{l.osc.disconnect(),l.gain.disconnect()}),h.disconnect(),f.disconnect(),m.disconnect(),g.disconnect(),u.disconnect(),d.disconnect(),y.disconnect(),M.disconnect()},(k+.1)*1e3),k}}}},ne={id:"fm-harp",name:"FM Harp",category:"pluck",createVoice(a,e,t=.8){const s=a.currentTime,i=.3+t*.5,n=3.5,o=4+t*3,c=a.createOscillator();c.type="sine",c.frequency.value=e;const r=a.createOscillator();r.type="sine",r.frequency.value=e*n;const u=a.createGain();u.gain.value=o*e,u.gain.setValueAtTime(o*e,s),u.gain.exponentialRampToValueAtTime(e*.5,s+.08),u.gain.exponentialRampToValueAtTime(e*.1,s+.4),r.connect(u),u.connect(c.frequency);const d=a.createOscillator();d.type="sine",d.frequency.value=e*1.002;const h=a.createOscillator();h.type="sine",h.frequency.value=e*n*.998;const f=a.createGain();f.gain.value=o*e*.8,f.gain.setValueAtTime(o*e*.8,s),f.gain.exponentialRampToValueAtTime(e*.3,s+.1),f.gain.exponentialRampToValueAtTime(e*.05,s+.5),h.connect(f),f.connect(d.frequency);const m=a.createGain();m.gain.value=.4;const g=a.createGain();g.gain.value=.6;const y=a.createGain();y.gain.value=.4,c.connect(g),d.connect(y),g.connect(m),y.connect(m);const M=a.createBiquadFilter();M.type="highpass",M.frequency.value=80;const b=a.createBiquadFilter();b.type="lowpass",b.frequency.value=8e3,b.Q.value=.5,m.connect(M),M.connect(b);const x=a.createGain();x.gain.setValueAtTime(0,s),x.gain.linearRampToValueAtTime(i,s+.005),x.gain.exponentialRampToValueAtTime(i*.4,s+.15),x.gain.exponentialRampToValueAtTime(i*.15,s+.8),x.gain.setTargetAtTime(i*.08,s+.8,1.5),b.connect(x),c.start(s),d.start(s),r.start(s),h.start(s);const k=a.createGain();return k.gain.value=.7,x.connect(k),{output:k,release(l=0){const p=a.currentTime+l,T=.8;x.gain.cancelScheduledValues(p),x.gain.setValueAtTime(x.gain.value,p),x.gain.exponentialRampToValueAtTime(.001,p+T);const V=p+T+.1;return c.stop(V),d.stop(V),r.stop(V),h.stop(V),setTimeout(()=>{try{c.disconnect(),d.disconnect(),r.disconnect(),h.disconnect(),u.disconnect(),f.disconnect(),m.disconnect(),M.disconnect(),b.disconnect(),x.disconnect(),k.disconnect()}catch{}},(T+.2)*1e3),T}}}},ae={id:"cathedral-organ",name:"Cathedral Organ",category:"keys",drawbars:{16:.8,8:1,4:.7,"2-2/3":.5,2:.6,"1-3/5":.3,"1-1/3":.25,1:.15},createVoice(a,e,t=.8){const s=a.currentTime,i=.25+t*.25,n=[{ratio:.5,level:this.drawbars[16]},{ratio:1,level:this.drawbars[8]},{ratio:2,level:this.drawbars[4]},{ratio:3,level:this.drawbars["2-2/3"]},{ratio:4,level:this.drawbars[2]},{ratio:5,level:this.drawbars["1-3/5"]},{ratio:6,level:this.drawbars["1-1/3"]},{ratio:8,level:this.drawbars[1]}],o=a.createGain();o.gain.value=.15;const c=[];n.forEach(({ratio:T,level:V})=>{if(V<=0)return;const E=a.createOscillator();E.type="sine",E.frequency.value=e*T,E.detune.value=(Math.random()-.5)*4;const L=a.createGain(),G=1/Math.sqrt(T);L.gain.value=V*G*.3,E.connect(L),L.connect(o),E.start(s),c.push({osc:E,gain:L})});const r=a.createOscillator();r.type="square",r.frequency.value=e*8;const u=a.createGain();u.gain.setValueAtTime(.15,s),u.gain.exponentialRampToValueAtTime(.001,s+.008);const d=a.createBiquadFilter();d.type="bandpass",d.frequency.value=2e3,d.Q.value=2,r.connect(d),d.connect(u),u.connect(o),r.start(s),r.stop(s+.02);const h=a.createBuffer(1,a.sampleRate*.1,a.sampleRate),f=h.getChannelData(0);for(let T=0;T<f.length;T++)f[T]=(Math.random()*2-1)*.02;const m=a.createBufferSource();m.buffer=h,m.loop=!0;const g=a.createBiquadFilter();g.type="bandpass",g.frequency.value=400,g.Q.value=.5;const y=a.createGain();y.gain.value=.03,m.connect(g),g.connect(y),y.connect(o),m.start(s);const M=a.createOscillator();M.type="sine",M.frequency.value=5.5;const b=a.createGain();b.gain.value=.08;const x=a.createGain();x.gain.value=1,M.connect(b),b.connect(x.gain),M.start(s),o.connect(x);const k=a.createBiquadFilter();k.type="lowpass",k.frequency.value=4e3,k.Q.value=.5,x.connect(k);const l=a.createGain();l.gain.setValueAtTime(0,s),l.gain.linearRampToValueAtTime(i,s+.01),k.connect(l);const p=a.createGain();return p.gain.value=.9,l.connect(p),{output:p,release(T=0){const V=a.currentTime+T,E=.3;l.gain.cancelScheduledValues(V),l.gain.setValueAtTime(l.gain.value,V),l.gain.exponentialRampToValueAtTime(.001,V+E);const L=V+E+.1;c.forEach(({osc:G})=>{try{G.stop(L)}catch{}});try{m.stop(L),M.stop(L)}catch{}return setTimeout(()=>{try{c.forEach(({osc:G,gain:w})=>{G.disconnect(),w.disconnect()}),m.disconnect(),g.disconnect(),y.disconnect(),M.disconnect(),b.disconnect(),x.disconnect(),o.disconnect(),k.disconnect(),l.disconnect(),p.disconnect()}catch{}},(E+.2)*1e3),E}}}},O={"orchid-ep":J,"analog-flower":ee,"mellow-bells":te,"warm-lead":se,"tape-strings":ie,"fm-harp":ne,"cathedral-organ":ae},N=["orchid-ep","analog-flower","mellow-bells","warm-lead","tape-strings","fm-harp","cathedral-organ"],I="orchid-ep";function oe(a,e=1){const s=(N.indexOf(a)+e+N.length)%N.length;return N[s]}class re{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.wetGain=e.createGain(),this.dryGain=e.createGain(),this.preDelay=e.createDelay(.1),this.preDelay.delayTime.value=.02,this.delays=[],this.feedbacks=[];const t=[.037,.041,.053,.067];for(let s=0;s<4;s++){const i=e.createDelay(.1);i.delayTime.value=t[s];const n=e.createGain();n.gain.value=.7;const o=e.createBiquadFilter();o.type="lowpass",o.frequency.value=4e3-s*500,this.preDelay.connect(i),i.connect(o),o.connect(n),n.connect(i),o.connect(this.wetGain),this.delays.push(i),this.feedbacks.push(n)}this.input.connect(this.preDelay),this.input.connect(this.dryGain),this.wetGain.connect(this.output),this.dryGain.connect(this.output),this.setLevel(0)}setLevel(e){const t=e/99;this.wetGain.gain.value=t*.7,this.dryGain.gain.value=1-t*.4;const s=.25+t*.4;this.feedbacks.forEach(i=>{i.gain.value=s})}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class ce{constructor(e){this.ctx=e,this.bpm=120,this.input=e.createGain(),this.output=e.createGain(),this.wetGain=e.createGain(),this.dryGain=e.createGain(),this.delayL=e.createDelay(2),this.delayR=e.createDelay(2),this.feedbackL=e.createGain(),this.feedbackR=e.createGain(),this.filterL=e.createBiquadFilter(),this.filterL.type="lowpass",this.filterL.frequency.value=3e3,this.filterR=e.createBiquadFilter(),this.filterR.type="lowpass",this.filterR.frequency.value=3e3,this.panL=e.createStereoPanner(),this.panL.pan.value=-.5,this.panR=e.createStereoPanner(),this.panR.pan.value=.5,this.input.connect(this.delayL),this.delayL.connect(this.filterL),this.filterL.connect(this.feedbackL),this.feedbackL.connect(this.delayL),this.filterL.connect(this.panL),this.panL.connect(this.wetGain),this.input.connect(this.delayR),this.delayR.connect(this.filterR),this.filterR.connect(this.feedbackR),this.feedbackR.connect(this.delayR),this.filterR.connect(this.panR),this.panR.connect(this.wetGain),this.input.connect(this.dryGain),this.wetGain.connect(this.output),this.dryGain.connect(this.output),this.feedbackL.gain.value=.4,this.feedbackR.gain.value=.4,this.updateDelayTime(),this.setLevel(0)}setBpm(e){this.bpm=e,this.updateDelayTime()}updateDelayTime(){const t=60/this.bpm/2;this.delayL.delayTime.value=t,this.delayR.delayTime.value=t*1.03}setLevel(e){const t=e/99;this.wetGain.gain.value=t,this.dryGain.gain.value=1-t*.2;const s=t===0?0:.15+t*.35;this.feedbackL.gain.value=s,this.feedbackR.gain.value=s;const i=2200+t*1200;this.filterL.frequency.value=i,this.filterR.frequency.value=i}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class le{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.wetGain=e.createGain(),this.dryGain=e.createGain(),this.delayL=e.createDelay(.05),this.delayL.delayTime.value=.012,this.delayR=e.createDelay(.05),this.delayR.delayTime.value=.015,this.lfoL=e.createOscillator(),this.lfoL.type="sine",this.lfoL.frequency.value=.8,this.lfoR=e.createOscillator(),this.lfoR.type="sine",this.lfoR.frequency.value=.9,this.depthL=e.createGain(),this.depthL.gain.value=.003,this.depthR=e.createGain(),this.depthR.gain.value=.003,this.lfoL.connect(this.depthL),this.depthL.connect(this.delayL.delayTime),this.lfoR.connect(this.depthR),this.depthR.connect(this.delayR.delayTime),this.lfoL.start(),this.lfoR.start(),this.panL=e.createStereoPanner(),this.panL.pan.value=-.3,this.panR=e.createStereoPanner(),this.panR.pan.value=.3,this.input.connect(this.delayL),this.input.connect(this.delayR),this.input.connect(this.dryGain),this.delayL.connect(this.panL),this.delayR.connect(this.panR),this.panL.connect(this.wetGain),this.panR.connect(this.wetGain),this.wetGain.connect(this.output),this.dryGain.connect(this.output),this.setLevel(0)}setLevel(e){const t=e/99;this.wetGain.gain.value=t*.5,this.dryGain.gain.value=1-t*.2,this.depthL.gain.value=5e-4+t*.0035,this.depthR.gain.value=5e-4+t*.0035}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class he{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.wetGain=e.createGain(),this.dryGain=e.createGain(),this.lfo=e.createOscillator(),this.lfo.type="sine",this.lfo.frequency.value=.3,this.depth=e.createGain(),this.depth.gain.value=800,this.lfo.connect(this.depth),this.lfo.start(),this.filters=[];let t=this.input;for(let s=0;s<4;s++){const i=e.createBiquadFilter();i.type="allpass",i.frequency.value=1e3,i.Q.value=.5,this.depth.connect(i.frequency),t.connect(i),t=i,this.filters.push(i)}this.feedback=e.createGain(),this.feedback.gain.value=.4,t.connect(this.feedback),this.feedback.connect(this.filters[0]),t.connect(this.wetGain),this.input.connect(this.dryGain),this.wetGain.connect(this.output),this.dryGain.connect(this.output),this.setLevel(0)}setLevel(e){const t=e/99;this.wetGain.gain.value=t*.6,this.dryGain.gain.value=1-t*.3,this.depth.gain.value=200+t*600,this.feedback.gain.value=.1+t*.35}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class ue{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.wetGain=e.createGain(),this.dryGain=e.createGain(),this.delay=e.createDelay(.02),this.delay.delayTime.value=.003,this.lfo=e.createOscillator(),this.lfo.type="sine",this.lfo.frequency.value=.2,this.depth=e.createGain(),this.depth.gain.value=.002,this.lfo.connect(this.depth),this.depth.connect(this.delay.delayTime),this.lfo.start(),this.feedback=e.createGain(),this.feedback.gain.value=.6,this.input.connect(this.delay),this.delay.connect(this.feedback),this.feedback.connect(this.delay),this.delay.connect(this.wetGain),this.input.connect(this.dryGain),this.wetGain.connect(this.output),this.dryGain.connect(this.output),this.setLevel(0)}setLevel(e){const t=e/99;this.wetGain.gain.value=t*.7,this.dryGain.gain.value=1-t*.3,this.depth.gain.value=5e-4+t*.0025,this.feedback.gain.value=.2+t*.4}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class de{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.preGain=e.createGain(),this.preGain.gain.value=1,this.waveshaper=e.createWaveShaper(),this.waveshaper.curve=this.createSaturationCurve(.4),this.waveshaper.oversample="2x",this.postGain=e.createGain(),this.postGain.gain.value=.8,this.toneFilter=e.createBiquadFilter(),this.toneFilter.type="lowpass",this.toneFilter.frequency.value=8e3,this.toneFilter.Q.value=.5,this.input.connect(this.preGain),this.preGain.connect(this.waveshaper),this.waveshaper.connect(this.toneFilter),this.toneFilter.connect(this.postGain),this.postGain.connect(this.output),this.setLevel(0)}createSaturationCurve(e){const s=new Float32Array(256);for(let i=0;i<256;i++){const n=i*2/256-1;s[i]=(Math.PI+e)*n/(Math.PI+e*Math.abs(n))}return s}setLevel(e){const t=e/99,s=.2+t*1.2;this.waveshaper.curve=this.createSaturationCurve(s),this.preGain.gain.value=1+t*1.5,this.postGain.gain.value=.85/(1+t*.8),this.toneFilter.frequency.value=1e4-t*5e3}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class pe{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.modulatedGain=e.createGain(),this.lfo=e.createOscillator(),this.lfo.type="sine",this.lfo.frequency.value=5,this.depth=e.createGain(),this.depth.gain.value=0,this.offset=e.createConstantSource(),this.offset.offset.value=1,this.lfo.connect(this.depth),this.depth.connect(this.modulatedGain.gain),this.offset.connect(this.modulatedGain.gain),this.lfo.start(),this.offset.start(),this.input.connect(this.modulatedGain),this.modulatedGain.connect(this.output),this.setLevel(0)}setLevel(e){const t=e/99;this.depth.gain.value=t*.6,this.offset.offset.value=1-t*.3,this.lfo.frequency.value=2+t*10}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class fe{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.wetGain=e.createGain(),this.dryGain=e.createGain(),this.delays=[],this.lfos=[],this.depths=[];const t=[.3,.5,.7,.9,1.1,1.3],s=[.015,.018,.021,.024,.027,.03],i=[-.8,-.4,-.1,.1,.4,.8];for(let n=0;n<6;n++){const o=e.createDelay(.05);o.delayTime.value=s[n];const c=e.createOscillator();c.type="triangle",c.frequency.value=t[n];const r=e.createGain();r.gain.value=.002,c.connect(r),r.connect(o.delayTime),c.start();const u=e.createStereoPanner();u.pan.value=i[n],this.input.connect(o),o.connect(u),u.connect(this.wetGain),this.delays.push(o),this.lfos.push(c),this.depths.push(r)}this.input.connect(this.dryGain),this.wetGain.connect(this.output),this.dryGain.connect(this.output),this.setLevel(0)}setLevel(e){const t=e/99;this.wetGain.gain.value=t*.5,this.dryGain.gain.value=1-t*.25;for(let s=0;s<this.depths.length;s++)this.depths[s].gain.value=8e-4+t*.0025}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class ge{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.chainGain=e.createGain(),this.bypassGain=e.createGain(),this.chainGain.gain.value=1,this.bypassGain.gain.value=0,this.input.connect(this.bypassGain),this.bypassGain.connect(this.output),this.effects={reverb:new re(e),delay:new ce(e),chorus:new le(e),phaser:new he(e),flanger:new ue(e),drive:new de(e),tremolo:new pe(e),ensemble:new fe(e)};const t=["drive","phaser","flanger","chorus","ensemble","tremolo","delay","reverb"];let s=this.input;for(const i of t){const n=this.effects[i];s.connect(n.input),s=n.output}s.connect(this.chainGain),this.chainGain.connect(this.output)}setLevel(e,t){this.effects[e]&&this.effects[e].setLevel(t)}setLevels(e){for(const[t,s]of Object.entries(e))this.setLevel(t,s)}setBpm(e){this.effects.delay.setBpm(e)}setBypass(e){this.chainGain.gain.value=e?0:1,this.bypassGain.gain.value=e?1:0}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class me{constructor(){try{this.ctx=new(window.AudioContext||window.webkitAudioContext)}catch(e){console.error("Web Audio API not supported:",e),this.ctx=null;return}this.currentPatch=O[I],this.patchId=I,this.masterGain=this.ctx.createGain(),this.masterGain.gain.value=.5,this.flavourEnabled=!0,this.flavourInput=this.ctx.createGain(),this.flavourOutput=this.ctx.createGain(),this.flavourBypassGain=this.ctx.createGain(),this.flavourBypassGain.gain.value=0,this.flavourHighpass=this.ctx.createBiquadFilter(),this.flavourHighpass.type="highpass",this.flavourHighpass.frequency.value=24,this.flavourHighpass.Q.value=.55,this.flavourLowShelf=this.ctx.createBiquadFilter(),this.flavourLowShelf.type="lowshelf",this.flavourLowShelf.frequency.value=90,this.flavourLowShelf.gain.value=.35,this.flavourHighShelf=this.ctx.createBiquadFilter(),this.flavourHighShelf.type="highshelf",this.flavourHighShelf.frequency.value=11e3,this.flavourHighShelf.gain.value=.4,this.flavourDryGain=this.ctx.createGain(),this.flavourDryGain.gain.value=.9,this.flavourWetGain=this.ctx.createGain(),this.flavourWetGain.gain.value=.1,this.flavourMix=this.ctx.createGain(),this.flavourSaturation=this.ctx.createWaveShaper(),this.flavourSaturation.curve=this.createSaturationCurve(.08),this.flavourSaturation.oversample="4x",this.flavourLimiter=this.ctx.createDynamicsCompressor(),this.flavourLimiter.threshold.value=-.5,this.flavourLimiter.ratio.value=1.8,this.flavourLimiter.knee.value=14,this.flavourLimiter.attack.value=.005,this.flavourLimiter.release.value=.25,this.flavourTrim=this.ctx.createGain(),this.flavourTrim.gain.value=.95,this.compressor=this.ctx.createDynamicsCompressor(),this.compressor.threshold.value=-18,this.compressor.ratio.value=3,this.compressor.knee.value=10,this.compressor.attack.value=.03,this.compressor.release.value=.25,this.masterFilter=this.ctx.createBiquadFilter(),this.masterFilter.type="lowpass",this.masterFilter.frequency.value=3e3,this.masterFilter.Q.value=.7,this.fxChain=new ge(this.ctx),this.voiceInput=this.ctx.createGain(),this.voiceInput.gain.value=1,this.voiceInput.connect(this.fxChain.input),this.fxChain.connect(this.masterFilter),this.masterFilter.connect(this.compressor),this.compressor.connect(this.flavourInput),this.compressor.connect(this.flavourBypassGain),this.flavourInput.connect(this.flavourHighpass),this.flavourHighpass.connect(this.flavourLowShelf),this.flavourLowShelf.connect(this.flavourHighShelf),this.flavourHighShelf.connect(this.flavourSaturation),this.flavourHighShelf.connect(this.flavourDryGain),this.flavourSaturation.connect(this.flavourWetGain),this.flavourWetGain.connect(this.flavourMix),this.flavourDryGain.connect(this.flavourMix),this.flavourMix.connect(this.flavourLimiter),this.flavourLimiter.connect(this.flavourTrim),this.flavourTrim.connect(this.flavourOutput),this.flavourOutput.connect(this.masterGain),this.flavourBypassGain.connect(this.masterGain),this.masterGain.connect(this.ctx.destination),this.recordDestination=this.ctx.createMediaStreamDestination(),this.masterGain.connect(this.recordDestination),this.mediaRecorder=null,this.recordedChunks=[],this.isRecording=!1,this.setFlavourEnabled(this.flavourEnabled),this.driftLFO=this.ctx.createOscillator(),this.driftLFO.frequency.value=.4,this.driftGain=this.ctx.createGain(),this.driftGain.gain.value=8,this.driftLFO.connect(this.driftGain),this.driftLFO.start(),this.activeOscillators=new Map,this.liveVoices=new Map,this.bassGain=this.ctx.createGain(),this.bassGain.gain.value=.6,this.bassGain.connect(this.compressor),this.bassVoice=null}setFxLevel(e,t){this.fxChain&&this.fxChain.setLevel(e,t)}setFxLevels(e){this.fxChain&&this.fxChain.setLevels(e)}setFxBpm(e){this.fxChain&&this.fxChain.setBpm(e)}setFxBypass(e){this.fxChain&&this.fxChain.setBypass(e)}setFlavourEnabled(e){if(this.flavourEnabled=!!e,!this.flavourOutput||!this.flavourBypassGain)return;const t=this.ctx.currentTime,s=this.flavourEnabled?1:0,i=this.flavourEnabled?0:1;this.flavourOutput.gain.setTargetAtTime(s,t,.02),this.flavourBypassGain.gain.setTargetAtTime(i,t,.02)}resume(){this.ctx.state==="suspended"&&this.ctx.resume()}setPatch(e){return O[e]?(this.currentPatch=O[e],this.patchId=e,!0):!1}getPatchId(){return this.patchId}playNote(e,t=.8,s=0){const i=F(e);if(this.currentPatch&&this.currentPatch.createVoice){const d=this.currentPatch.createVoice(this.ctx,i,t);d.output.connect(this.voiceInput);const h={patchVoice:d,note:e,osc:null,gain:d.output};return this.activeOscillators.has(e)||this.activeOscillators.set(e,new Set),this.activeOscillators.get(e).add(h),h}const n=this.ctx.createOscillator(),o=this.ctx.createGain();n.type="sawtooth",n.frequency.value=i,this.driftGain.connect(n.detune);const c=Math.random()*10-5;n.detune.value=c;const r=this.ctx.currentTime+s;o.gain.setValueAtTime(0,r),o.gain.linearRampToValueAtTime(.4,r+.1),o.gain.exponentialRampToValueAtTime(.2,r+.4),n.connect(o),o.connect(this.voiceInput),n.start(r);const u={osc:n,gain:o,note:e};return this.activeOscillators.has(e)||this.activeOscillators.set(e,new Set),this.activeOscillators.get(e).add(u),u}stopNote(e,t=0){if(!e)return;if(e.patchVoice&&e.patchVoice.release){e.patchVoice.release(t);const n=this.activeOscillators.get(e.note);n&&(n.delete(e),n.size===0&&this.activeOscillators.delete(e.note));return}if(!e.osc)return;const s=this.ctx.currentTime+t;e.gain.gain.cancelScheduledValues(s),e.gain.gain.setValueAtTime(e.gain.gain.value,s),e.gain.gain.exponentialRampToValueAtTime(.001,s+.2),e.osc.stop(s+.2),setTimeout(()=>{e.osc.disconnect(),e.gain.disconnect()},250);const i=this.activeOscillators.get(e.note);i&&(i.delete(e),i.size===0&&this.activeOscillators.delete(e.note))}playBass(e,t=0){this.bassVoice&&this.stopBass(t);const s=F(e),i=this.ctx.createOscillator(),n=this.ctx.createGain(),o=this.ctx.createBiquadFilter();i.type="square",i.frequency.value=s,o.type="lowpass",o.frequency.value=320,o.Q.value=1.2;const c=this.ctx.currentTime+t;n.gain.setValueAtTime(0,c),n.gain.linearRampToValueAtTime(.55,c+.03),n.gain.exponentialRampToValueAtTime(.38,c+.22),n.gain.setValueAtTime(.38,c+.22),o.frequency.setValueAtTime(340,c),o.frequency.exponentialRampToValueAtTime(190,c+.24),i.connect(o),o.connect(n),n.connect(this.bassGain),i.start(c),this.bassVoice={osc:i,gain:n,filter:o,note:e}}stopBass(e=0){if(!this.bassVoice)return;const t=this.bassVoice,s=this.ctx.currentTime+e;t.gain.gain.cancelScheduledValues(s),t.gain.gain.setValueAtTime(t.gain.gain.value,s),t.gain.gain.exponentialRampToValueAtTime(.001,s+.1),t.osc.stop(s+.1),setTimeout(()=>{t.osc.disconnect(),t.gain.disconnect(),t.filter.disconnect()},150),this.bassVoice=null}setBassVolume(e){const t=e/100;this.bassGain.gain.setTargetAtTime(t,this.ctx.currentTime,.1)}playChord(e){this.resume();for(const[t,s]of this.liveVoices)e.includes(t)||(this.stopNote(s),this.liveVoices.delete(t));e.forEach(t=>{if(!this.liveVoices.has(t)){const s=this.playNote(t);this.liveVoices.set(t,s)}})}stopAll(){this.stopBass(),this.stopArpNote();for(const e of this.activeOscillators.values())for(const t of e)this.stopNote(t);this.liveVoices.clear(),this.activeOscillators.clear()}playArpNote(e,t=80){const s=this.ctx.currentTime;this.arpVoice&&(this.arpVoice.patchVoice&&this.arpVoice.patchVoice.release?this.arpVoice.patchVoice.release(0):this.arpVoice.gain&&(this.arpVoice.gain.gain.cancelScheduledValues(s),this.arpVoice.gain.gain.setValueAtTime(this.arpVoice.gain.gain.value,s),this.arpVoice.gain.gain.linearRampToValueAtTime(0,s+.01),this.arpVoice.osc&&this.arpVoice.osc.stop(s+.02)),this.arpVoice=null);const i=F(e),n=t/127;if(this.currentPatch&&this.currentPatch.createVoice){const r=this.currentPatch.createVoice(this.ctx,i,n);return r.output.connect(this.voiceInput),this.arpVoice={patchVoice:r,note:e},this.arpVoice}const o=this.ctx.createOscillator(),c=this.ctx.createGain();return o.type="sawtooth",o.frequency.value=i,this.driftGain.connect(o.detune),o.detune.value=Math.random()*10-5,c.gain.setValueAtTime(0,s),c.gain.linearRampToValueAtTime(.3*n,s+.015),o.connect(c),c.connect(this.voiceInput),o.start(s),this.arpVoice={osc:o,gain:c,note:e},this.arpVoice}stopArpNote(){if(!this.arpVoice)return;const e=this.ctx.currentTime,t=this.arpVoice;if(t.patchVoice&&t.patchVoice.release){t.patchVoice.release(0),this.arpVoice=null;return}t.gain&&(t.gain.gain.cancelScheduledValues(e),t.gain.gain.setValueAtTime(t.gain.gain.value,e),t.gain.gain.exponentialRampToValueAtTime(.001,e+.08)),t.osc&&(t.osc.stop(e+.1),setTimeout(()=>{try{t.osc.disconnect(),t.gain&&t.gain.disconnect()}catch{}},150)),this.arpVoice=null}setFilterCutoff(e){if(this.masterFilter){const t=Math.max(20,Math.min(2e4,e));this.masterFilter.frequency.setTargetAtTime(t,this.ctx.currentTime,.1)}}setVolume(e){const t=Math.pow(e/99,2);this.masterGain.gain.setTargetAtTime(t,this.ctx.currentTime,.02)}isRecordingSupported(){return typeof MediaRecorder<"u"&&!!this.recordDestination}startRecording(){if(!this.isRecordingSupported()||this.isRecording)return!1;try{this.resume(),this.recordedChunks=[];const e={},t="audio/webm;codecs=opus";return MediaRecorder.isTypeSupported(t)?e.mimeType=t:MediaRecorder.isTypeSupported("audio/webm")&&(e.mimeType="audio/webm"),this.mediaRecorder=new MediaRecorder(this.recordDestination.stream,e),this.mediaRecorder.ondataavailable=s=>{s.data&&s.data.size>0&&this.recordedChunks.push(s.data)},this.mediaRecorder.start(),this.isRecording=!0,!0}catch(e){return console.error("Failed to start recording",e),this.mediaRecorder=null,this.isRecording=!1,!1}}async stopRecording(){return!this.mediaRecorder||!this.isRecording?null:new Promise(e=>{const t=this.mediaRecorder;t.onstop=()=>{const s=t.mimeType||"audio/webm",i=new Blob(this.recordedChunks,{type:s});this.mediaRecorder=null,this.isRecording=!1,this.recordedChunks=[],e(i)},t.stop()})}createSaturationCurve(e=1){const t=Math.max(.01,e)*12,s=1024,i=new Float32Array(s);for(let n=0;n<s;n++){const o=n*2/s-1;i[n]=(1+t)*o/(1+t*Math.abs(o))}return i}playClick(e,t){const s=this.ctx.createOscillator(),i=this.ctx.createGain();s.connect(i),i.connect(this.masterGain),s.frequency.value=t?1200:800,s.type="square",i.gain.setValueAtTime(.3,e),i.gain.exponentialRampToValueAtTime(.001,e+.05),s.start(e),s.stop(e+.05)}}class ye{constructor(){this.baseOctave=4,this.noteMap={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11},this.intervals={major:[0,4,7],minor:[0,3,7],suspended:[0,5,7],diminished:[0,3,6]},this.extensionIntervals={6:9,7:10,maj7:11,9:14},this.reverseNoteMap=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],this.scaleIntervals={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],dorian:[0,2,3,5,7,9,10],phrygian:[0,1,3,5,7,8,10],lydian:[0,2,4,6,7,9,11],mixolydian:[0,2,4,5,7,9,10],locrian:[0,1,3,5,6,8,10]}}getMidiRoot(e){const t=this.noteMap[e];if(t===void 0)throw new Error(`Invalid note name: ${e}`);return 60+t}getNoteName(e){return this.reverseNoteMap[e%12]}getNotes(e,t="major",s=[]){const i=this.getMidiRoot(e);let o=(this.intervals[t]||this.intervals.major).map(c=>i+c);return s.forEach(c=>{this.extensionIntervals[c]&&o.push(i+this.extensionIntervals[c])}),o.sort((c,r)=>c-r)}getScaleNotes(e,t="major"){const s=this.noteMap[e]||0;return(this.scaleIntervals[t]||this.scaleIntervals.major).map(n=>(s+n)%12)}quantizeToScale(e,t,s="major"){const i=this.getScaleNotes(t,s),n=e%12,o=Math.floor(e/12);if(i.includes(n))return e;let c=12,r=n;for(const d of i){const h=Math.abs(n-d),f=12-h,m=Math.min(h,f);m<c&&(c=m,r=d)}let u=o*12+r;return r>n&&r-n>6?u-=12:n>r&&n-r>6&&(u+=12),u}quantizeRoot(e,t,s="major"){const i=this.getMidiRoot(e),n=this.quantizeToScale(i,t,s);return this.getNoteName(n)}getDiatonicChordType(e,t,s="major"){const i=this.scaleIntervals[s]||this.scaleIntervals.major,n=this.noteMap[e],o=this.noteMap[t]||0;if(n===void 0)return"major";const c=(n-o+12)%12,r=i.indexOf(c);if(r===-1)return"major";const u=["major","minor","minor","major","major","minor","diminished"],h=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"].indexOf(s),f=h===-1?0:h;return[...u.slice(f),...u.slice(0,f)][r]||"major"}}class ve{getVoicing(e,t){if(!e||e.length===0)return[];const s=Math.max(24,Math.min(96,t||60)),i=[...e].sort((u,d)=>u-d),n=7;let o=0;for(;o<24;){const u=i[0],d=i[i.length-1];if(u<s-n)i[0]=u+12,i.sort((h,f)=>h-f);else if(d>s+n)i[i.length-1]=d-12,i.sort((h,f)=>h-f);else break;o++}const c=i.reduce((u,d)=>u+d,0)/i.length,r=Math.round((s-c)/12);return i.map(u=>u+r*12).sort((u,d)=>u-d)}}class be{constructor(e){this.callbacks=e||{},this.access=null,this.inputs=new Map}async init(){if(!navigator.requestMIDIAccess)return console.warn("Web MIDI API not supported in this browser."),!1;try{this.access=await navigator.requestMIDIAccess(),this.access.onstatechange=e=>this.handleStateChange(e);for(const e of this.access.inputs.values())this.bindInput(e);return!0}catch(e){return console.error("Web MIDI Access failed:",e),!1}}bindInput(e){this.inputs.has(e.id)||(console.log(`MIDI Input Connected: ${e.name}`),e.onmidimessage=t=>this.handleMessage(t),this.inputs.set(e.id,e),this.callbacks.onConnection&&this.callbacks.onConnection(e.name,!0))}handleStateChange(e){const t=e.port;t.type==="input"&&(t.state==="connected"?this.bindInput(t):(this.inputs.delete(t.id),this.callbacks.onConnection&&this.callbacks.onConnection(t.name,!1)))}handleMessage(e){const[t,s,i]=e.data;switch(t&240){case 144:i>0?this.callbacks.onNoteOn&&this.callbacks.onNoteOn(s,i):this.callbacks.onNoteOff&&this.callbacks.onNoteOff(s);break;case 128:this.callbacks.onNoteOff&&this.callbacks.onNoteOff(s);break;case 176:this.callbacks.onControlChange&&this.callbacks.onControlChange(s,i);break;case 224:this.callbacks.onPitchBend&&this.callbacks.onPitchBend(s,i);break}}destroy(){for(const e of this.inputs.values())e.onmidimessage=null;this.inputs.clear(),this.access&&(this.access.onstatechange=null)}}class Te{constructor(e,t){this.context=e,this.callbacks=t,this.state="idle",this.layers=[],this.currentLayerIndex=-1,this.activeNotes=new Set,this.startTime=0,this.loopDuration=0,this.loopStartContextTime=0,this.playbackInterval=null,this.lastTickTime=0,this.bpm=120,this.bars=0}setBpm(e){this.bpm=e}record(e=0,t=null){if(this.state==="idle")if(this.state="recording",this.startTime=t||this.context.currentTime,this.layers=[{events:[]}],this.currentLayerIndex=0,this.bars=e,e>0){const s=60/this.bpm,i=e*4*s;if(this.loopDuration=i,this.callbacks.onMetronome)for(let r=0;r<e*4;r++){const u=this.startTime+r*s,d=r%4===0;this.callbacks.onMetronome(u,d)}const n=()=>{if(this.state!=="recording")return;const r=this.context.currentTime;if(r<this.startTime){requestAnimationFrame(n);return}const u=r-this.startTime,d=Math.min(1,u/this.loopDuration),h=this.bars,f=Math.min(h,Math.floor(d*h)+1);this.callbacks.onProgress&&this.callbacks.onProgress(d,f,h),d<1&&requestAnimationFrame(n)};requestAnimationFrame(n);const o=this.context.currentTime,c=(this.startTime+this.loopDuration-o)*1e3;setTimeout(()=>{this.state==="recording"&&this.play()},Math.max(0,c))}else this.loopDuration=0,this.bars=0}play(e=null){if(this.state==="recording"){if(this.loopDuration===0){const t=this.context.currentTime-this.startTime,s=60/this.bpm,i=Math.round(t/s),n=Math.max(1,i);this.loopDuration=n*s}this.state="playing",this.startPlayback(e)}else this.state==="overdubbing"?this.state="playing":this.state==="idle"&&this.layers.length>0?(this.state="playing",this.startPlayback(e)):this.state==="playing"&&this.stop()}overdub(){this.state==="playing"&&(this.state="overdubbing",this.layers.push({events:[]}),this.currentLayerIndex=this.layers.length-1)}stop(){this.state="idle",this.playbackInterval&&(cancelAnimationFrame(this.playbackInterval),this.playbackInterval=null),this.activeNotes.forEach(e=>{this.callbacks.onStop&&this.callbacks.onStop(e)}),this.activeNotes.clear(),this.lastTickTime=0}undo(){this.layers.length>1?(this.layers.pop(),this.currentLayerIndex=this.layers.length-1):this.layers.length===1&&(this.layers=[],this.stop())}addEvent(e){if(this.state!=="recording"&&this.state!=="overdubbing")return;const t=(this.context.currentTime-this.startTime)%(this.loopDuration||1/0);this.layers[this.currentLayerIndex].events.push({...e,time:t})}startPlayback(e=null){const t=this.context.currentTime,s=e||t;if(s>t){setTimeout(()=>{this.state==="playing"&&this.startPlayback(s)},(s-t)*1e3);return}this.loopStartContextTime=s,this.lastTickTime=-Number.EPSILON;const i=()=>{if(this.state!=="playing"&&this.state!=="overdubbing")return;const c=(this.context.currentTime-this.loopStartContextTime)%this.loopDuration;if(c<this.lastTickTime&&(this.tick(this.loopDuration),this.lastTickTime=-.01),this.callbacks.onProgress){const r=this.bars||Math.max(1,Math.round(this.loopDuration/(60/this.bpm*4))),u=Math.floor(c/this.loopDuration*r)+1;this.callbacks.onProgress(c/this.loopDuration,u,r)}this.tick(c),this.lastTickTime=c,this.playbackInterval=requestAnimationFrame(i)};this.playbackInterval=requestAnimationFrame(i)}tick(e){this.layers.forEach(t=>{t.events.forEach(s=>{s.time>this.lastTickTime&&s.time<=e&&this.triggerEvent(s)})})}triggerEvent(e){e.type==="noteOn"?(this.callbacks.onPlay(e.note,e.velocity),this.activeNotes.add(e.note)):e.type==="noteOff"&&(this.callbacks.onStop(e.note),this.activeNotes.delete(e.note))}}class Me{constructor(e){this.context=e,this.bpm=120,this.isPlaying=!1,this.currentBeat=0,this.nextNoteTime=0,this.timerID=null,this.lookahead=25,this.scheduleAheadTime=.1,this.patternName="rock",this.patterns={rock:{length:16,kick:[1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0]},house:{length:16,kick:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0]},hiphop:{length:16,kick:[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1]},techno:{length:16,kick:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],snare:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],hat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0]}},this.output=this.context.createGain(),this.output.gain.value=.6}setBpm(e){this.bpm=e}setPattern(e){this.patterns[e]&&(this.patternName=e)}start(){this.isPlaying||(this.isPlaying=!0,this.currentBeat=0,this.nextNoteTime=this.context.currentTime+.05,this.scheduler())}stop(){this.isPlaying=!1,this.timerID&&(clearTimeout(this.timerID),this.timerID=null)}scheduler(){for(;this.nextNoteTime<this.context.currentTime+this.scheduleAheadTime;)this.scheduleNote(this.currentBeat,this.nextNoteTime),this.nextNote();this.isPlaying&&(this.timerID=setTimeout(()=>this.scheduler(),this.lookahead))}nextNote(){const e=60/this.bpm;this.nextNoteTime+=.25*e,this.currentBeat=(this.currentBeat+1)%16}scheduleNote(e,t){const s=this.patterns[this.patternName];s&&(s.kick[e]&&this.playKick(t),s.snare[e]&&this.playSnare(t),s.hat[e]&&this.playHiHat(t))}playKick(e){const t=this.context.createOscillator(),s=this.context.createGain();t.connect(s),s.connect(this.output),t.frequency.setValueAtTime(150,e),t.frequency.exponentialRampToValueAtTime(.01,e+.5),s.gain.setValueAtTime(1,e),s.gain.exponentialRampToValueAtTime(.01,e+.5),t.start(e),t.stop(e+.5)}playSnare(e){const t=this.createNoiseBuffer(),s=this.context.createBufferSource();s.buffer=t;const i=this.context.createBiquadFilter();i.type="highpass",i.frequency.value=1e3;const n=this.context.createGain();s.connect(i),i.connect(n),n.connect(this.output),n.gain.setValueAtTime(1,e),n.gain.exponentialRampToValueAtTime(.01,e+.2),s.start(e),s.stop(e+.2);const o=this.context.createOscillator(),c=this.context.createGain();o.type="triangle",o.connect(c),c.connect(this.output),o.frequency.setValueAtTime(250,e),c.gain.setValueAtTime(.5,e),c.gain.exponentialRampToValueAtTime(.01,e+.1),o.start(e),o.stop(e+.1)}playHiHat(e){const t=[2,3,4.16,5.43,6.79,8.21],s=this.context.createBiquadFilter();s.type="bandpass",s.frequency.value=1e4;const i=this.context.createBiquadFilter();i.type="highpass",i.frequency.value=7e3;const n=this.context.createGain();t.forEach(o=>{const c=this.context.createOscillator();c.type="square",c.frequency.value=40*o,c.connect(s),c.start(e),c.stop(e+.05)}),s.connect(i),i.connect(n),n.connect(this.output),n.gain.setValueAtTime(.3,e),n.gain.exponentialRampToValueAtTime(.01,e+.05)}createNoiseBuffer(){const e=this.context.sampleRate*2,t=this.context.createBuffer(1,e,this.context.sampleRate),s=t.getChannelData(0);for(let i=0;i<e;i++)s[i]=Math.random()*2-1;return t}getNextNoteTime(){return this.isPlaying?this.nextNoteTime:this.context.currentTime}getNextBarTime(){if(!this.isPlaying)return this.context.currentTime;const e=(16-this.currentBeat)%16,t=60/this.bpm*.25;return this.nextNoteTime+e*t}}class xe{constructor(e,t={}){this.ctx=e,this.onNoteOn=t.onNoteOn||(()=>{}),this.onNoteOff=t.onNoteOff||(()=>{}),this.bpm=120,this.division="1/8",this.swingAmount=0,this.pattern="up",this.octaveRange=1,this.isRunning=!1,this.currentNotes=[],this.currentIndex=0,this.direction=1,this.lastPlayedNote=null,this.nextNoteTime=0,this.schedulerInterval=null,this.lookahead=25,this.scheduleAheadTime=.1,this.divisions={"1/1":4,"1/2":2,"1/4":1,"1/8":.5,"1/16":.25,"1/32":.125,"1/4T":1/1.5,"1/8T":.5/1.5,"1/16T":.25/1.5,"1/4D":1.5,"1/8D":.75,"1/16D":.375},this.divisionOrder=["1/1","1/2","1/4","1/8","1/16","1/32","1/4T","1/8T","1/16T","1/4D","1/8D","1/16D"]}setBpm(e){this.bpm=Math.max(20,Math.min(300,e))}setDivision(e){this.divisions[e]!==void 0&&(this.division=e)}setOctaveRange(e){this.octaveRange=Math.max(1,Math.min(3,e))}cycleDivision(e=1){const s=(this.divisionOrder.indexOf(this.division)+e+this.divisionOrder.length)%this.divisionOrder.length;return this.division=this.divisionOrder[s],this.division}setPattern(e){["up","down","updown","downup","random","order"].includes(e)&&(this.pattern=e,this.currentIndex=0,this.direction=e==="down"||e==="downup"?-1:1)}cyclePattern(){const e=["up","down","updown","random"],s=(e.indexOf(this.pattern)+1)%e.length;return this.setPattern(e[s]),this.pattern}setNotes(e=[]){if(this.currentNotes=[...e].sort((t,s)=>t-s),this.octaveRange>1){const t=[...this.currentNotes];for(let s=1;s<this.octaveRange;s++)this.currentNotes.forEach(i=>{t.push(i+s*12)});this.currentNotes=t}this.currentIndex>=this.currentNotes.length&&(this.currentIndex=0)}getNextNote(){if(this.currentNotes.length===0)return null;let e;switch(this.pattern){case"up":e=this.currentNotes[this.currentIndex],this.currentIndex=(this.currentIndex+1)%this.currentNotes.length;break;case"down":const t=this.currentNotes.length-1-this.currentIndex;e=this.currentNotes[t],this.currentIndex=(this.currentIndex+1)%this.currentNotes.length;break;case"updown":case"downup":e=this.currentNotes[this.currentIndex],this.currentIndex+=this.direction,this.currentIndex>=this.currentNotes.length-1?(this.currentIndex=this.currentNotes.length-1,this.direction=-1):this.currentIndex<=0&&(this.currentIndex=0,this.direction=1);break;case"random":const s=Math.floor(Math.random()*this.currentNotes.length);e=this.currentNotes[s];break;case"order":e=this.currentNotes[this.currentIndex],this.currentIndex=(this.currentIndex+1)%this.currentNotes.length;break;default:e=this.currentNotes[0]}return e}getStepDuration(){const e=this.divisions[this.division]||.5,t=60/this.bpm;return e*t}scheduleNote(e){this.lastPlayedNote!==null&&this.onNoteOff(this.lastPlayedNote);const t=this.getNextNote();if(t!==null){const i=this.getStepDuration()*.9;this.onNoteOn(t,100,e),this.lastPlayedNote=t,setTimeout(()=>{this.lastPlayedNote===t&&(this.onNoteOff(t),this.lastPlayedNote=null)},i*1e3)}}scheduler(){for(;this.nextNoteTime<this.ctx.currentTime+this.scheduleAheadTime;)this.scheduleNote(this.nextNoteTime),this.nextNoteTime+=this.getStepDuration()}start(e=[],t=null){e.length>0&&this.setNotes(e),this.currentNotes.length!==0&&(this.isRunning=!0,this.currentIndex=0,this.direction=this.pattern==="down"||this.pattern==="downup"?-1:1,this.nextNoteTime=t||this.ctx.currentTime,this.schedulerInterval||(this.schedulerInterval=setInterval(()=>this.scheduler(),this.lookahead)))}stop(){this.isRunning=!1,this.schedulerInterval&&(clearInterval(this.schedulerInterval),this.schedulerInterval=null),this.lastPlayedNote!==null&&(this.onNoteOff(this.lastPlayedNote),this.lastPlayedNote=null)}updateNotes(e){this.setNotes(e)}tapTempo(){const e=performance.now();if(this._tapTimes||(this._tapTimes=[]),this._tapTimes.length>0&&e-this._tapTimes[this._tapTimes.length-1]>2e3&&(this._tapTimes=[]),this._tapTimes.push(e),this._tapTimes.length>4&&this._tapTimes.shift(),this._tapTimes.length>=2){let t=0;for(let n=1;n<this._tapTimes.length;n++)t+=this._tapTimes[n]-this._tapTimes[n-1];const s=t/(this._tapTimes.length-1),i=Math.round(6e4/s);return this.setBpm(i),this.bpm}return this.bpm}}class Ee{constructor(e,t={}){this.ctx=e,this.onNoteOn=t.onNoteOn||(()=>{}),this.onNoteOff=t.onNoteOff||(()=>{}),this.bpm=120,this.patterns={straight:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],offbeat:[0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],pulse:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],tresillo:[1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0],clave:[1,0,0,1,0,0,1,0,0,0,1,0,1,0,0,0],shuffle:[1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,0],waltz:[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0],funk:[1,0,0,1,0,1,0,0,1,0,0,1,0,1,0,0]},this.patternOrder=["straight","offbeat","pulse","tresillo","clave","shuffle","waltz","funk"],this.currentPatternName="straight",this.isRunning=!1,this.currentNotes=[],this.stepIndex=0,this.noteIndex=0,this.lastPlayedNote=null,this.nextStepTime=0,this.schedulerInterval=null,this.lookahead=25,this.scheduleAheadTime=.1}setBpm(e){this.bpm=Math.max(20,Math.min(300,e))}get pattern(){return this.patterns[this.currentPatternName]}setPattern(e){this.patterns[e]&&(this.currentPatternName=e,this.stepIndex=0,this.noteIndex=0)}cyclePattern(e=1){const s=(this.patternOrder.indexOf(this.currentPatternName)+e+this.patternOrder.length)%this.patternOrder.length;return this.setPattern(this.patternOrder[s]),this.currentPatternName}getPatternDisplayName(){return{straight:"STRAIGHT",offbeat:"OFFBEAT",pulse:"PULSE",tresillo:"TRESILLO",clave:"CLAVE",shuffle:"SHUFFLE",waltz:"WALTZ",funk:"FUNK"}[this.currentPatternName]||this.currentPatternName.toUpperCase()}setNotes(e){this.currentNotes=[...e].sort((t,s)=>t-s)}getStepDuration(){return 60/this.bpm/4}getNextChordNote(){if(this.currentNotes.length===0)return null;const e=this.currentNotes[this.noteIndex%this.currentNotes.length];return this.noteIndex=(this.noteIndex+1)%this.currentNotes.length,e}scheduleStep(e){const t=this.pattern,s=t[this.stepIndex]===1;if(this.lastPlayedNote!==null&&(this.onNoteOff(this.lastPlayedNote),this.lastPlayedNote=null),s&&this.currentNotes.length>0){const i=this.getNextChordNote();if(i!==null){const n=90+Math.floor(Math.random()*20);this.onNoteOn(i,n,e),this.lastPlayedNote=i;const o=this.getStepDuration();setTimeout(()=>{this.lastPlayedNote===i&&(this.onNoteOff(i),this.lastPlayedNote=null)},o*.8*1e3)}}this.stepIndex=(this.stepIndex+1)%t.length}scheduler(){for(;this.nextStepTime<this.ctx.currentTime+this.scheduleAheadTime;)this.scheduleStep(this.nextStepTime),this.nextStepTime+=this.getStepDuration()}start(e=[],t=null){e.length>0&&this.setNotes(e),this.currentNotes.length!==0&&(this.isRunning=!0,this.stepIndex=0,this.noteIndex=0,this.nextStepTime=t||this.ctx.currentTime,this.schedulerInterval||(this.schedulerInterval=setInterval(()=>this.scheduler(),this.lookahead)))}stop(){this.isRunning=!1,this.schedulerInterval&&(clearInterval(this.schedulerInterval),this.schedulerInterval=null),this.lastPlayedNote!==null&&(this.onNoteOff(this.lastPlayedNote),this.lastPlayedNote=null)}updateNotes(e){this.setNotes(e)}}class Ve{constructor(e={}){this.onNoteOn=e.onNoteOn||(()=>{}),this.onNoteOff=e.onNoteOff||(()=>{}),this.strumTime=50,this.direction="down",this.mode="strum",this.activeNotes=new Set,this.pendingTimers=[]}setSpeed(e){this.strumTime=(99-e)/99*200}setDirection(e){(e==="down"||e==="up")&&(this.direction=e)}setMode(e){["strum","strum2","slop","harp"].includes(e)&&(this.mode=e)}toggleDirection(){return this.direction=this.direction==="down"?"up":"down",this.direction}strum(e,t=100){this.clearPending(),this.release();let s=[...e].sort((n,o)=>n-o);if(this.mode==="strum2"){const n=[...s];s.forEach(o=>n.push(o+12)),s=n}else if(this.mode==="harp"){const n=[...s];s.forEach(o=>n.push(o+12)),s.forEach(o=>n.push(o+24)),s=n}this.direction==="up"&&this.mode!=="harp"&&s.reverse();let i=this.strumTime;this.mode==="harp"&&(i=Math.min(this.strumTime,40)),s.forEach((n,o)=>{let c=o*i;if(this.mode==="slop"){const u=Math.random()*30-15;c=Math.max(0,c+u)}const r=setTimeout(()=>{const u=Math.max(60,t-o*2);this.onNoteOn(n,u),this.activeNotes.add(n)},c);this.pendingTimers.push(r)})}release(){this.clearPending(),this.activeNotes.forEach(e=>{this.onNoteOff(e)}),this.activeNotes.clear()}clearPending(){this.pendingTimers.forEach(e=>clearTimeout(e)),this.pendingTimers=[]}}const B=class B{constructor(e={}){this.state={powered:!0,root:"C",type:"major",extensions:new Set,voicingCenter:60,filterCutoff:2500,midiConnected:!1,activeMidiNotes:new Set,looperState:"idle",loopLength:"free",loopProgress:0,loopBarsRecorded:0,loopMenu:"play",isPlaying:!1,bassEnabled:!1,bassMode:"chords",bassVoicing:0,bassVolume:60,volume:70,flavourEnabled:!0,currentPatch:I,keyEnabled:!1,keyRoot:"C",keyScale:"major",keyAutoChords:!0,performMode:"direct",arpPattern:"up",arpDivision:"1/8",arpOctave:1,strumSpeed:50,rhythmPattern:"straight",playstyle:"advanced",bpm:120,metronomeOn:!1,beatEnabled:!1,beatPattern:"rock",currentEffect:"direct",fxLocked:!1,fxLevels:{reverb:0,delay:0,chorus:0,phaser:0,flanger:0,drive:0,tremolo:0,ensemble:0},recording:!1,...e},this.listeners=new Set}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(e=[]){this.listeners.forEach(t=>t(this.state,e))}get(e){return this.state[e]}setPower(e){this.state.powered!==e&&(this.state.powered=e,this.notify(["powered"]))}setRoot(e){this.state.root!==e&&(this.state.root=e,this.notify(["root"]))}setChordType(e){this.state.type!==e&&(this.state.type=e,this.notify(["type"]))}toggleExtension(e){const t=new Set(this.state.extensions);t.has(e)?t.delete(e):t.add(e),this.state.extensions=t,this.notify(["extensions"])}setExtension(e,t){const s=this.state.extensions.has(e);if(t&&!s){const i=new Set(this.state.extensions);i.add(e),this.state.extensions=i,this.notify(["extensions"])}else if(!t&&s){const i=new Set(this.state.extensions);i.delete(e),this.state.extensions=i,this.notify(["extensions"])}}setVoicingCenter(e){this.state.voicingCenter!==e&&(this.state.voicingCenter=e,this.notify(["voicingCenter"]))}setFilterCutoff(e){this.state.filterCutoff!==e&&(this.state.filterCutoff=e,this.notify(["filterCutoff"]))}setBassVoicing(e){const t=Math.max(-24,Math.min(24,e));this.state.bassVoicing!==t&&(this.state.bassVoicing=t,this.notify(["bassVoicing"]))}setBassVolume(e){const t=Math.max(0,Math.min(99,e));this.state.bassVolume!==t&&(this.state.bassVolume=t,this.notify(["bassVolume"]))}setVolume(e){const t=Math.max(0,Math.min(99,e));this.state.volume!==t&&(this.state.volume=t,this.notify(["volume"]))}setBassMode(e){["direct","chords","unison","single","solo"].includes(e)&&this.state.bassMode!==e&&(this.state.bassMode=e,this.notify(["bassMode"]))}setBassEnabled(e){this.state.bassEnabled!==e&&(this.state.bassEnabled=e,this.notify(["bassEnabled"]))}toggleBass(){const e=this.state.bassEnabled;this.setBassEnabled(!e),!e&&this.state.bassEnabled&&this.setBassVolume(10)}setLooperState(e){this.state.looperState!==e&&(this.state.looperState=e,this.notify(["looperState"]))}setLoopProgress(e){this.state.loopProgress=e,this.notify(["loopProgress"])}setLoopBarsRecorded(e){this.state.loopBarsRecorded!==e&&(this.state.loopBarsRecorded=e,this.notify(["loopBarsRecorded"]))}setMidiConnected(e){this.state.midiConnected!==e&&(this.state.midiConnected=e,this.notify(["midiConnected"]))}setIsPlaying(e){this.state.isPlaying!==e&&(this.state.isPlaying=e,this.notify(["isPlaying"]))}cycleBassMode(){const e=["direct","chords","unison","single","solo"],s=(e.indexOf(this.state.bassMode)+1)%e.length;this.setBassMode(e[s])}setPatch(e){this.state.currentPatch!==e&&(this.state.currentPatch=e,this.notify(["currentPatch"]))}cyclePatch(e=1){const t=oe(this.state.currentPatch,e);return this.setPatch(t),t}setKeyEnabled(e){this.state.keyEnabled!==e&&(this.state.keyEnabled=e,this.notify(["keyEnabled"]))}toggleKey(){this.setKeyEnabled(!this.state.keyEnabled)}setKeyAutoChords(e){this.state.keyAutoChords!==e&&(this.state.keyAutoChords=e,this.notify(["keyAutoChords"]))}toggleKeyAutoChords(){this.setKeyAutoChords(!this.state.keyAutoChords)}setKeyRoot(e){["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].includes(e)&&this.state.keyRoot!==e&&(this.state.keyRoot=e,this.notify(["keyRoot"]))}cycleKeyRoot(e=1){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],i=(t.indexOf(this.state.keyRoot)+e+t.length)%t.length;this.setKeyRoot(t[i])}setKeyScale(e){["major","minor","dorian","phrygian","lydian","mixolydian","locrian"].includes(e)&&this.state.keyScale!==e&&(this.state.keyScale=e,this.notify(["keyScale"]))}cycleKeyScale(){const e=["major","minor","dorian","phrygian","lydian","mixolydian","locrian"],s=(e.indexOf(this.state.keyScale)+1)%e.length;this.setKeyScale(e[s])}setPerformMode(e){["direct","arp","strum","strum2","slop","harp","pattern"].includes(e)&&this.state.performMode!==e&&(this.state.performMode=e,this.notify(["performMode"]))}cyclePerformMode(){const e=["direct","arp","strum","strum2","slop","harp","pattern"],s=(e.indexOf(this.state.performMode)+1)%e.length;return this.setPerformMode(e[s]),this.state.performMode}setArpPattern(e){["up","down","updown","random"].includes(e)&&this.state.arpPattern!==e&&(this.state.arpPattern=e,this.notify(["arpPattern"]))}cycleArpPattern(){const e=["up","down","updown","random"],s=(e.indexOf(this.state.arpPattern)+1)%e.length;return this.setArpPattern(e[s]),this.state.arpPattern}setArpDivision(e){["1/1","1/2","1/4","1/8","1/16","1/32","1/4T","1/8T","1/16T","1/4D","1/8D","1/16D"].includes(e)&&this.state.arpDivision!==e&&(this.state.arpDivision=e,this.notify(["arpDivision"]))}cycleArpDivision(){const e=["1/1","1/2","1/4","1/8","1/16","1/32","1/4T","1/8T","1/16T","1/4D","1/8D","1/16D"],s=(e.indexOf(this.state.arpDivision)+1)%e.length;return this.setArpDivision(e[s]),this.state.arpDivision}setArpOctave(e){const t=Math.max(1,Math.min(3,parseInt(e)));this.state.arpOctave!==t&&(this.state.arpOctave=t,this.notify(["arpOctave"]))}cycleArpOctave(){let e=this.state.arpOctave+1;return e>3&&(e=1),this.setArpOctave(e),this.state.arpOctave}setStrumSpeed(e){const t=Math.max(0,Math.min(99,e));this.state.strumSpeed!==t&&(this.state.strumSpeed=t,this.notify(["strumSpeed"]))}setRhythmPattern(e){["straight","offbeat","pulse","tresillo","clave","shuffle","waltz","funk"].includes(e)&&this.state.rhythmPattern!==e&&(this.state.rhythmPattern=e,this.notify(["rhythmPattern"]))}cycleRhythmPattern(e=1){const t=["straight","offbeat","pulse","tresillo","clave","shuffle","waltz","funk"],i=(t.indexOf(this.state.rhythmPattern)+e+t.length)%t.length;return this.setRhythmPattern(t[i]),this.state.rhythmPattern}setBpm(e){const t=Math.max(20,Math.min(300,e));this.state.bpm!==t&&(this.state.bpm=t,this.notify(["bpm"]))}adjustBpm(e){this.setBpm(this.state.bpm+e)}toggleMetronome(){this.state.metronomeOn=!this.state.metronomeOn,this.notify(["metronomeOn"])}setPlaystyle(e){["simple","advanced","free"].includes(e)&&this.state.playstyle!==e&&(this.state.playstyle=e,this.notify(["playstyle"]))}cyclePlaystyle(e=1){const t=["simple","advanced","free"],i=(t.indexOf(this.state.playstyle)+e+t.length)%t.length;return this.setPlaystyle(t[i]),this.state.playstyle}setCurrentEffect(e){B.FX_TYPES.includes(e)&&this.state.currentEffect!==e&&(this.state.currentEffect=e,this.notify(["currentEffect"]))}cycleCurrentEffect(e=1){const t=B.FX_TYPES,i=(t.indexOf(this.state.currentEffect)+e+t.length)%t.length;return this.setCurrentEffect(t[i]),this.state.currentEffect}setFxLevel(e,t){if(!B.FX_TYPES.includes(e))return;const s=Math.max(0,Math.min(99,t));this.state.fxLevels[e]!==s&&(this.state.fxLevels[e]=s,this.notify(["fxLevels",e]))}adjustFxLevel(e,t){const s=this.state.fxLevels[e]||0;this.setFxLevel(e,s+t)}getFxLevel(e){return this.state.fxLevels[e]||0}toggleFxLock(){return this.state.fxLocked=!this.state.fxLocked,this.notify(["fxLocked"]),this.state.fxLocked}setFxLocked(e){this.state.fxLocked!==e&&(this.state.fxLocked=e,this.notify(["fxLocked"]))}setFlavourEnabled(e){this.state.flavourEnabled!==e&&(this.state.flavourEnabled=e,this.notify(["flavourEnabled"]))}toggleFlavour(){this.setFlavourEnabled(!this.state.flavourEnabled)}setRecording(e){this.state.recording!==e&&(this.state.recording=e,this.notify(["recording"]))}toggleRecording(){this.setRecording(!this.state.recording)}setLoopLength(e){["free",1,2,4,8,16].includes(e)&&this.state.loopLength!==e&&(this.state.loopLength=e,this.notify(["loopLength"]))}cycleLoopLength(e=1){const t=["free",1,2,4,8,16],i=(t.indexOf(this.state.loopLength)+e+t.length)%t.length;return this.setLoopLength(t[i]),this.state.loopLength}setLoopMenu(e){["play","overdub","undo","clear","stop"].includes(e)&&this.state.loopMenu!==e&&(this.state.loopMenu=e,this.notify(["loopMenu"]))}cycleLoopMenu(e=1){const t=["play","overdub","undo","clear","stop"],i=(t.indexOf(this.state.loopMenu)+e+t.length)%t.length;return this.setLoopMenu(t[i]),this.state.loopMenu}setBeatEnabled(e){this.state.beatEnabled!==e&&(this.state.beatEnabled=e,this.notify(["beatEnabled"]))}setBeatPattern(e){this.state.beatPattern!==e&&(this.state.beatPattern=e,this.notify(["beatPattern"]))}cycleBeatPattern(e=1){const t=["rock","house","hiphop","techno"],i=(t.indexOf(this.state.beatPattern)+e+t.length)%t.length;return this.setBeatPattern(t[i]),this.state.beatPattern}};q(B,"FX_TYPES",["direct","reverb","delay","chorus","phaser","flanger","drive","tremolo","ensemble"]);let D=B;class ke{constructor(e,t){this.container=e,this.actions=t,this.encoderRotations={},this._bassVolumeFlashUntil=0,this._fxStateSnapshot=null,this._currentBpmValue=36,this._currentPerformValue=50,this.encoderEngaged=new Map([["fx",!1]]),this.state=null,this.attachEvents()}mount(e){this.state=e,this.container.innerHTML=`
      <!-- ROW 1: Configuration & Display -->
      <div class="config-row">
        <!-- Left Encoders -->
        <div class="encoder-group left-encoders">
          <div class="encoder yellow" data-encoder="sound">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Sound</span>
          </div>
          <div class="encoder yellow ${e.performMode!=="direct"?"active":""}" data-encoder="perform" title="Click to cycle mode, rotate for division/speed, hold for pattern">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Perform</span>
          </div>
          <div class="encoder yellow" data-encoder="fx">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">FX</span>
          </div>
          <div class="encoder charcoal ${e.keyEnabled?"active":""}" data-encoder="key" title="Click to toggle key lock, rotate to select key">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Key</span>
          </div>
        </div>

        <!-- OLED Display -->
        <div class="oled-display">
          <div class="oled-screen">
            <!-- Top Bar: Status & Volume -->
            <div class="oled-header">
              <div class="oled-status-icons">
                <span class="status-icon ${e.powered?"active":""}" title="Power">PWR</span>
                <span class="status-icon ${e.midiConnected?"active":""}" title="MIDI">MIDI</span>
                <span class="status-icon ${e.looperState!=="idle"?"active":""}" title="Looper">
                  ${e.looperState==="recording"?`REC ${e.loopBarsRecorded||""}`:e.looperState==="overdubbing"?`DUB ${e.loopBarsRecorded||""}`:e.looperState==="playing"?`PLAY ${e.loopBarsRecorded||""}`:"LOOP"}
                </span>
              </div>
              <span class="oled-volume" data-volume="${e.volume}">VOL ${e.volume}</span>
            </div>

            <!-- Main Content: Patch & Chord -->
            <div class="oled-main-section">
              <div class="oled-patch-name">${this.getPatchDisplayName(e.currentPatch)}</div>
              <div class="oled-chord-display">
                <span class="oled-chord-root">${e.root}</span>
                <span class="oled-chord-type">${e.type}</span>
              </div>
              <div class="oled-extensions">${e.extensions.size>0?Array.from(e.extensions).join(" "):""}</div>
            </div>

            <!-- Bottom Grid: Parameters -->
            <div class="oled-grid">
              <!-- Row 1: Key & Bass -->
              <div class="oled-grid-cell">
                <span class="oled-label">KEY</span>
                <span class="oled-value oled-key-value ${e.keyEnabled?"active":""}">${this.getKeyDisplay(e)}</span>
              </div>
              <div class="oled-grid-cell">
                <span class="oled-label">BASS</span>
                <span class="oled-value oled-bass-value ${e.bassEnabled?"active":""}">${e.bassEnabled?e.bassMode.toUpperCase():"OFF"}</span>
              </div>

              <!-- Row 2: Perform & BPM -->
              <div class="oled-grid-cell">
                <span class="oled-label">MODE</span>
                <span class="oled-value oled-mode-value ${e.performMode!=="direct"?"active":""}">${this.getPerformModeDisplay(e)}</span>
              </div>
              <div class="oled-grid-cell">
                <span class="oled-label">BPM</span>
                <span class="oled-value oled-bpm-value ${e.beatEnabled?"active":""}">${e.beatEnabled?e.beatPattern.toUpperCase():e.bpm}</span>
              </div>

              <!-- Row 3: FX & Style -->
              <div class="oled-grid-cell">
                <span class="oled-label">FX</span>
                <span class="oled-value oled-fx-value ${e.currentEffect!=="direct"?"active":""}">${this.getFxDisplay(e)} ${e.currentEffect!=="direct"?this.getFxLevel(e):""}</span>
              </div>
              <div class="oled-grid-cell">
                <span class="oled-label">STYLE</span>
                <span class="oled-value oled-style-value">${e.playstyle.toUpperCase()}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Encoders -->
        <div class="encoder-group right-encoders">
          <div class="encoder red ${e.bassEnabled?"active":""}" data-encoder="bass" title="Click to toggle bass, hold for mode">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Bass</span>
          </div>
          <div class="encoder charcoal" data-encoder="loop">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Loop</span>
          </div>
          <div class="encoder charcoal ${e.beatEnabled?"yellow active":""}" data-encoder="bpm" title="Click to toggle beats, rotate for BPM/Pattern">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">BPM</span>
          </div>
          <div class="encoder charcoal" data-encoder="options">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Options</span>
          </div>
          <div class="encoder charcoal" data-encoder="volume">
            <div class="encoder-knob" style="transform: rotate(${e.volume/99*270-135}deg)">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Volume</span>
          </div>
        </div>
      </div>

      <!-- ROW 2: Performance Controls -->
      <div class="performance-row">
        <!-- Left: Chord Type & Extensions -->
        <div class="performance-controls">
          <div class="button-grid">
            <div class="button-row">
              <button class="perf-btn" data-type="diminished" id="btn-dim">Dim</button>
              <button class="perf-btn" data-type="minor" id="btn-min">Min</button>
              <button class="perf-btn" data-type="major" id="btn-maj">Maj</button>
              <button class="perf-btn" data-type="suspended" id="btn-sus">Sus</button>
            </div>
            <div class="button-row">
              <button class="perf-btn" data-ext="6" id="btn-6">6</button>
              <button class="perf-btn" data-ext="7" id="btn-m7">m7</button>
              <button class="perf-btn" data-ext="maj7" id="btn-M7">M7</button>
              <button class="perf-btn" data-ext="9" id="btn-9">9</button>
            </div>
          </div>

          <!-- Voicing & Bass Dials -->
          <div class="dial-stack">
            <div class="stacked-dial voicing-dial">
              <div class="dial-knob" id="voicing-knob" data-value="60">
                <div class="dial-indicator"></div>
              </div>
              <span class="dial-label">Voicing</span>
            </div>
            <div class="stacked-dial bass-dial">
              <div class="dial-knob small" id="bass-knob" data-value="0">
                <div class="dial-indicator"></div>
              </div>
              <span class="dial-label">Bass</span>
            </div>
          </div>
        </div>

        <!-- Right: Keyboard -->
        <div class="keyboard" id="keyboard">
          <!-- Keys generated dynamically -->
        </div>
      </div>
    `,this.renderKeyboard(e.root)}getPatchDisplayName(e){const t=O[e];return t?t.name:e}getVoicingRotation(e){return(Math.max(36,Math.min(84,e||60))-36)/48*270-135}getBassVoicingRotation(e){return(Math.max(-24,Math.min(24,e||0))- -24)/48*270-135}getPerformModeDisplay(e){return e.performMode==="direct"?"DIRECT":e.performMode==="arp"?`ARP ${e.arpPattern.toUpperCase()} ${e.arpDivision}`:["strum","strum2","slop","harp"].includes(e.performMode)?`${e.performMode.toUpperCase()} ${e.strumSpeed}`:e.performMode==="pattern"?`PATTERN ${{straight:"STRAIGHT",offbeat:"OFFBEAT",pulse:"PULSE",tresillo:"TRESILLO",clave:"CLAVE",shuffle:"SHUFFLE",waltz:"WALTZ",funk:"FUNK"}[e.rhythmPattern]||e.rhythmPattern.toUpperCase()}`:e.performMode.toUpperCase()}getKeyDisplay(e){if(!e.keyEnabled)return"KEY: OFF";const t=e.keyAutoChords?e.keyScale.toUpperCase().slice(0,3):{diminished:"DIM",minor:"MIN",major:"MAJ",suspended:"SUS"}[e.type]||e.type.toUpperCase().slice(0,3),s=e.keyAutoChords?"AUTO":"MAN";return`KEY: ${e.keyRoot} ${t} ${s}`}getFxDisplay(e){const t=e.currentEffect||"reverb",s=t.toUpperCase();return t==="direct"?"FX DIRECT":`FX ${s}`}getFxLevel(e){const t=e.currentEffect||"reverb";if(t==="direct")return"";const s=(e.fxLevels&&e.fxLevels[t])??0,i=e.fxLocked?" LOCK":"";return`${s}${i}`}update(e){this.state=e;const t=this.container.querySelector(".oled-patch-name");t&&(t.textContent=this.getPatchDisplayName(e.currentPatch));const s=this.container.querySelector(".oled-main-text");s&&(s.textContent=`${e.root} ${e.type}`);const i=this.container.querySelector(".oled-sub-text");i&&(i.textContent=e.extensions.size>0?Array.from(e.extensions).join(" "):"No extensions");const n=this.container.querySelector(".oled-volume");n&&(Date.now()<this._bassVolumeFlashUntil?n.textContent=`BASS ${e.bassVolume}`:n.textContent=`VOL ${e.volume}`,n.dataset.volume=e.volume);const o=this.container.querySelectorAll(".status-icon");if(o.length>=3){o[0].classList.toggle("active",e.powered),o[1].classList.toggle("active",e.midiConnected);const v=o[2];v.classList.toggle("active",e.looperState!=="idle");let S="LOOP";e.looperState==="idle"?S=e.loopLength==="free"?"FREE":`${e.loopLength}B`:e.looperState==="recording"?S="REC":e.looperState==="overdubbing"?S="DUB":e.looperState==="playing"&&(e.loopMenu!=="play"?S=e.loopMenu.toUpperCase():S="PLAY"),v.textContent=S}const c=this.container.querySelector(".oled-fx-value");if(c){const v=`${this.getFxDisplay(e)} ${e.currentEffect!=="direct"?this.getFxLevel(e):""}`;c.textContent=v,c.classList.toggle("active",e.currentEffect!=="direct")}const r=this.container.querySelector(".oled-bass-value");r&&(r.textContent=e.bassEnabled?e.bassMode.toUpperCase():"OFF",r.classList.toggle("active",e.bassEnabled));const u=this.container.querySelector(".oled-key-value");u&&(u.textContent=this.getKeyDisplay(e),u.classList.toggle("active",e.keyEnabled));const d=this.container.querySelector('.encoder[data-encoder="key"]');d&&d.classList.toggle("active",e.keyEnabled);const h=this.container.querySelector('.encoder[data-encoder="loop"]');if(h){const v=e.looperState!=="idle";h.classList.toggle("active",v),h.classList.remove("charcoal","red","yellow","green"),e.looperState==="recording"?h.classList.add("red"):e.looperState==="overdubbing"?h.classList.add("yellow"):e.looperState==="playing"?h.classList.add("green"):h.classList.add("charcoal")}const f=this.container.querySelector(".oled-style-value");f&&(f.textContent=e.playstyle.toUpperCase());const m=this.container.querySelector(".oled-mode-value");m&&(m.textContent=this.getPerformModeDisplay(e),m.classList.toggle("active",e.performMode!=="direct"));const g=this.container.querySelector(".oled-bpm-value");g&&(e.beatEnabled?(g.textContent=e.beatPattern.toUpperCase(),g.classList.add("active")):(g.textContent=`${e.bpm}`,g.classList.remove("active")));const y=this.container.querySelector('.encoder[data-encoder="bpm"]');y&&(y.classList.toggle("active",e.beatEnabled),e.beatEnabled?(y.classList.remove("charcoal"),y.classList.add("yellow")):(y.classList.remove("yellow"),y.classList.add("charcoal")));const M=this.container.querySelector('.encoder[data-encoder="perform"]');if(M){const v=e.performMode!=="direct";if(this.encoderEngaged.set("perform",v),M.classList.toggle("active",v),e.performMode==="arp"){const A=["1/1","1/2","1/4","1/8","1/16","1/32","1/4T","1/8T","1/16T"].indexOf(e.arpDivision);A!==-1&&(this._currentPerformValue=Math.round(A*11+5))}else if(["strum","strum2","slop","harp"].includes(e.performMode))this._currentPerformValue=e.strumSpeed;else if(e.performMode==="pattern"){const A=["straight","offbeat","pulse","tresillo","clave","shuffle","waltz","funk"].indexOf(e.rhythmPattern);A!==-1&&(this._currentPerformValue=Math.round(A*12.5+6))}const S=M.querySelector(".encoder-knob");if(S){const C=v?this._currentPerformValue/99*270-135:0;S.style.transform=`rotate(${C}deg)`}}const b=this.container.querySelector('.encoder[data-encoder="fx"]');if(b){const v=this.encoderEngaged.get("fx")===!0&&e.currentEffect!=="direct";this.encoderEngaged.set("fx",v),b.classList.toggle("active",v);const S=b.querySelector(".encoder-knob");if(S){this._currentFxValue=e.fxLevels[e.currentEffect]??0;const C=v?this._currentFxValue/99*270-135:0;S.style.transform=`rotate(${C}deg)`}}this._currentBpmValue=Math.round((e.bpm-20)/280*99),this._fxStateSnapshot={currentEffect:e.currentEffect,fxLevels:{...e.fxLevels},fxLocked:e.fxLocked},this._lastFxEffect=e.currentEffect;const x=this.container.querySelector('.encoder[data-encoder="bass"]');if(x){const v=e.bassEnabled&&e.bassMode!=="direct";this.encoderEngaged.set("bass",v),x.classList.toggle("active",v);const S=x.querySelector(".encoder-knob");if(S){const C=v?e.bassVolume/99*270-135:0;S.style.transform=`rotate(${C}deg)`}this._currentBassVolume=e.bassVolume}const k=this.container.querySelector('.encoder[data-encoder="volume"]');if(k){const v=k.querySelector(".encoder-knob");if(v){const C=this.encoderEngaged.get("volume")===!0?e.volume/99*270-135:0;v.style.transform=`rotate(${C}deg)`}this._currentVolume=e.volume}const l=document.getElementById("flavour-toggle");l&&(l.classList.toggle("active",e.flavourEnabled),l.textContent=e.flavourEnabled?"Flavour On":"Flavour Off",l.title=e.flavourEnabled?"Secret flavour chain enabled":"Secret flavour chain bypassed");const p=document.getElementById("record-btn");p&&(p.classList.toggle("active",e.recording),p.textContent=e.recording?"Recording...":"Record",p.title=e.recording?"Recording live output":"Record live output to file");const T=this.container.querySelector("#power-btn");T&&(e.powered?T.classList.add("active"):T.classList.remove("active"),T.textContent=e.powered?"PWR ON":"PWR OFF");const V=this.container.querySelector("#midi-status");V&&(e.midiConnected?V.classList.add("connected"):V.classList.remove("connected")),this.container.querySelectorAll("#type-controls button").forEach(v=>{v.dataset.type===e.type?v.classList.add("active"):v.classList.remove("active")}),this.container.querySelectorAll("#ext-controls button").forEach(v=>{e.extensions.has(v.dataset.ext)?v.classList.add("active"):v.classList.remove("active")}),this.container.querySelectorAll(".perf-btn[data-type]").forEach(v=>{v.classList.toggle("active",v.dataset.type===e.type)}),this.container.querySelectorAll(".perf-btn[data-ext]").forEach(v=>{v.classList.toggle("active",e.extensions.has(v.dataset.ext))});const E=this.container.querySelector("#bass-mode-btn");E&&(E.textContent=`BASS: ${e.bassMode.toUpperCase()}`);const L=this.container.querySelector("#loop-rec-btn");L&&(e.looperState==="recording"||e.looperState==="overdubbing"?L.classList.add("active","recording"):L.classList.remove("active","recording"),L.textContent=e.looperState==="recording"?"REC":e.looperState==="overdubbing"?"DUB":"REC");const G=this.container.querySelector("#loop-play-btn");G&&(e.looperState==="playing"?G.classList.add("active"):G.classList.remove("active"),G.textContent=e.looperState==="playing"?"STOP":"PLAY");const w=(v,S)=>{const C=this.container.querySelector(`#${v}`);C&&document.activeElement!==C&&(C.value=S)};w("voicing-dial",e.voicingCenter),w("filter-dial",e.filterCutoff),w("bass-voicing-dial",e.bassVoicing),w("bass-vol-dial",e.bassVolume);const P=this.container.querySelector("#voicing-knob");if(P){const v=this.getVoicingRotation(e.voicingCenter);P.style.setProperty("--dial-rotation",`${v}deg`),this._voicingDialValue=e.voicingCenter}const R=this.container.querySelector("#bass-knob");if(R){const v=this.getBassVoicingRotation(e.bassVoicing);R.style.setProperty("--dial-rotation",`${v}deg`),this._bassVoicingDialValue=e.bassVoicing}}renderKeyboard(e){const t=[{note:"C",type:"white"},{note:"C#",type:"black"},{note:"D",type:"white"},{note:"D#",type:"black"},{note:"E",type:"white"},{note:"F",type:"white"},{note:"F#",type:"black"},{note:"G",type:"white"},{note:"G#",type:"black"},{note:"A",type:"white"},{note:"A#",type:"black"},{note:"B",type:"white"}],s=document.getElementById("keyboard");s&&(s.innerHTML=t.map(i=>`
        <div class="key ${i.type}" data-note="${i.note}"></div>
      `).join(""))}attachEvents(){let e=null,t=!1,s=null,i=!1,n=null,o=!1,c=null,r=!1,u=null,d=!1,h=!1;this.container.addEventListener("pointerdown",l=>{const p=l.target.closest("[data-type]");p&&(p.classList.contains("perf-btn")||p.closest("#type-controls"))&&(l.preventDefault(),this.actions.pressChordType(p.dataset.type))}),this.container.addEventListener("pointerup",l=>{const p=l.target.closest("[data-type]");p&&(p.classList.contains("perf-btn")||p.closest("#type-controls"))&&(l.preventDefault(),this.actions.releaseChordType(p.dataset.type))}),this.container.addEventListener("mousedown",l=>{l.target.closest('.encoder[data-encoder="bass"]')&&(t=!1,e=setTimeout(()=>{t=!0,this.actions.cycleBassMode()},500)),l.target.closest('.encoder[data-encoder="key"]')&&(i=!1,s=setTimeout(()=>{i=!0,this.actions.cycleKeyScale()},500)),l.target.closest('.encoder[data-encoder="perform"]')&&(o=!1,n=setTimeout(()=>{o=!0,this.actions.cycleArpPattern()},500)),l.target.closest('.encoder[data-encoder="bpm"]')&&(r=!1,c=setTimeout(()=>{r=!0,this.actions.toggleMetronome()},500)),l.target.closest('.encoder[data-encoder="loop"]')&&(d=!1,u=setTimeout(()=>{d=!0,this.actions.loopStop()},500))}),this.container.addEventListener("mouseup",l=>{e&&(clearTimeout(e),e=null),s&&(clearTimeout(s),s=null),n&&(clearTimeout(n),n=null),c&&(clearTimeout(c),c=null),u&&(clearTimeout(u),u=null),h=!1}),this.container.addEventListener("mouseleave",l=>{e&&(clearTimeout(e),e=null),s&&(clearTimeout(s),s=null),n&&(clearTimeout(n),n=null),c&&(clearTimeout(c),c=null),u&&(clearTimeout(u),u=null)}),this.container.addEventListener("click",l=>{var R;const p=l.target,T=l.target.closest('.encoder[data-encoder="key"]');if(T&&l.shiftKey){this.actions.toggleKeyAutoChords();return}if(T&&!i){this.actions.toggleKey();return}if(l.target.closest('.encoder[data-encoder="bass"]')&&!t){(R=this.state)!=null&&R.bassEnabled?this.actions.cycleBassMode():this.actions.toggleBass(),this.encoderEngaged.set("bass",!0);return}if(l.target.closest('.encoder[data-encoder="perform"]')&&!o){this.actions.cyclePerformMode(),this.encoderEngaged.set("perform",!0);return}if(l.target.closest('.encoder[data-encoder="bpm"]')&&!r){this.actions.toggleBeatEngine(),this.encoderEngaged.set("bpm",!0);return}if(l.target.closest('.encoder[data-encoder="loop"]')&&!d){l.shiftKey?this.actions.undoLoop():this.actions.clickLoopEncoder(),this.encoderEngaged.set("loop",!0);return}if(l.target.closest('.encoder[data-encoder="fx"]')){this.encoderEngaged.set("fx",!0),this._currentFxValue===void 0&&(this._currentFxValue=0),l.shiftKey?this.actions.toggleFxLock():this.actions.cycleFxType();return}if(l.target.closest('.encoder[data-encoder="options"]')){this.actions.cyclePlaystyle();return}if(p.id==="power-btn"&&this.actions.togglePower(),p.closest("#ext-controls button")){const v=p.closest("button").dataset.ext;this.actions.toggleExtension(v)}if(p.classList.contains("perf-btn")&&p.dataset.ext&&this.actions.toggleExtension(p.dataset.ext),p.classList.contains("key")){const v=p.dataset.note;this.actions.setRoot(v)}p.id==="loop-rec-btn"&&this.actions.toggleLoopRecord(),p.id==="loop-play-btn"&&this.actions.toggleLoopPlay(),p.id==="loop-undo-btn"&&this.actions.undoLoop(),p.id==="bass-mode-btn"&&this.actions.cycleBassMode()}),this.container.addEventListener("input",l=>{l.target.id==="voicing-dial"&&this.actions.setVoicing(parseInt(l.target.value)),l.target.id==="filter-dial"&&this.actions.setFilter(parseInt(l.target.value)),l.target.id==="bass-voicing-dial"&&this.actions.setBassVoicing(parseInt(l.target.value)),l.target.id==="bass-vol-dial"&&this.actions.setBassVolume(parseInt(l.target.value))});let f=null;const m=(l,p,T,{fine:V=!1}={})=>{const E=V?1:3,L=(w,P,R)=>Math.max(P,Math.min(R,w));if(this.encoderEngaged.set(l,!0),l==="volume")if(h){this._currentBassVolume===void 0&&(this._currentBassVolume=60);const P=L(this._currentBassVolume+p*E,0,99);if(P!==this._currentBassVolume){this._currentBassVolume=P,this._bassVolumeFlashUntil=Date.now()+1200,this.actions.setBassVolume(this._currentBassVolume);const R=this._currentBassVolume/99*270-135,v=T.querySelector(".encoder-knob");v&&(v.style.transform=`rotate(${R}deg)`);const S=this.container.querySelector(".oled-volume");S&&(S.textContent=`BASS ${this._currentBassVolume}`)}return}else{this._currentVolume===void 0&&(this._currentVolume=70);const P=L(this._currentVolume+p*E,0,99);if(P!==this._currentVolume){this._currentVolume=P,this.actions.setVolume(this._currentVolume);const R=this._currentVolume/99*270-135,v=T.querySelector(".encoder-knob");v&&(v.style.transform=`rotate(${R}deg)`)}return}if(l==="bass"){this._currentBassVolume===void 0&&(this._currentBassVolume=60);const w=L(this._currentBassVolume+p*E,0,99);if(w!==this._currentBassVolume){this._currentBassVolume=w,this._bassVolumeFlashUntil=Date.now()+1200,this.actions.setBassVolume(this._currentBassVolume);const P=this._currentBassVolume/99*270-135,R=T.querySelector(".encoder-knob");R&&(R.style.transform=`rotate(${P}deg)`);const v=this.container.querySelector(".oled-volume");v&&(v.textContent=`BASS ${this._currentBassVolume}`)}return}if(l==="fx"){this._currentFxValue===void 0&&(this._currentFxValue=0);const w=L(this._currentFxValue+p*E,0,99);if(w!==this._currentFxValue){this._currentFxValue=w;const P=this._fxStateSnapshot&&this._fxStateSnapshot.currentEffect||this._lastFxEffect||"reverb";P!=="direct"&&this.actions.setFxLevel(P,this._currentFxValue);const R=T.querySelector(".encoder-knob");if(R){const S=this._currentFxValue/99*270-135;R.style.transform=`rotate(${S}deg)`}const v=this.container.querySelector(".oled-fx-value");if(v){const S=this._fxStateSnapshot||{},C={...S.fxLevels||{},[P]:this._currentFxValue},A={currentEffect:P,fxLevels:C,fxLocked:S.fxLocked||!1};v.textContent=`${this.getFxDisplay(A)} ${this.getFxLevel(A)}`}}return}if(l==="perform"){this._currentPerformValue===void 0&&(this._currentPerformValue=50);const w=L(this._currentPerformValue+p*E,0,99);if(w!==this._currentPerformValue){this._currentPerformValue=w,this.actions.setPerformValue(this._currentPerformValue);const P=this._currentPerformValue/99*270-135,R=T.querySelector(".encoder-knob");R&&(R.style.transform=`rotate(${P}deg)`)}return}if(l==="bpm"){if(this.state&&this.state.beatEnabled){this.encoderRotations[l]||(this.encoderRotations[l]=0),this.encoderRotations[l]+=p*3;const P=T.querySelector(".encoder-knob");if(P&&(P.style.transform=`rotate(${this.encoderRotations[l]}deg)`),Math.abs(p)>=1){const R=p>0?1:-1;this.actions.cycleBeatPattern(R)}return}this._currentBpmValue===void 0&&(this._currentBpmValue=36);const w=L(this._currentBpmValue+p*E,0,99);if(w!==this._currentBpmValue){this._currentBpmValue=w;const P=Math.round(20+this._currentBpmValue/99*280);this.actions.setBpm(P);const R=this._currentBpmValue/99*270-135,v=T.querySelector(".encoder-knob");v&&(v.style.transform=`rotate(${R}deg)`)}return}this.encoderRotations[l]||(this.encoderRotations[l]=0),this.encoderRotations[l]+=p*3;const G=T.querySelector(".encoder-knob");if(G&&(G.style.transform=`rotate(${this.encoderRotations[l]}deg)`),Math.abs(p)>=1){const w=p>0?1:-1;l==="sound"&&this.actions.cyclePatch(-w),l==="key"&&this.actions.cycleKeyRoot(w),l==="options"&&this.actions.cyclePlaystyle(w),l==="loop"&&this.actions.cycleLoopEncoder(w)}};this.container.addEventListener("mousedown",l=>{const p=l.target.closest(".encoder[data-encoder]");if(p){const T=p.dataset.encoder;l.preventDefault(),p.classList.add("dragging"),document.body.style.cursor="ns-resize",T==="volume"&&(h=!0),T==="fx"&&this._currentFxValue===void 0&&(this._currentFxValue=0),f={encoder:p,encoderName:T,startY:l.clientY,lastY:l.clientY,fine:l.shiftKey}}}),document.addEventListener("mousemove",l=>{if(!f)return;const V=(f.lastY-l.clientY)/2;Math.abs(V)>=1&&(m(f.encoderName,V,f.encoder,{fine:f.fine}),f.lastY=l.clientY)}),document.addEventListener("mouseup",()=>{f&&(f.encoder.classList.remove("dragging"),document.body.style.cursor="",f=null),h=!1}),this.container.addEventListener("wheel",l=>{const p=l.target.closest(".encoder[data-encoder]");if(p){l.preventDefault();const T=p.dataset.encoder,V=l.deltaY>0?-5:5,E=h;T==="volume"&&(h=l.shiftKey||E),m(T,V,p,{fine:l.shiftKey}),this.encoderEngaged.set(T,!0),h=E}},{passive:!1});const g=(l,p,T)=>Math.max(p,Math.min(T,l)),y=l=>l?1:2,M=(l,p,T)=>{var V,E;if(l==="voicing"){const L=this._voicingDialValue??((V=this.state)==null?void 0:V.voicingCenter)??60,G=g(L+p*y(T),36,84);G!==L&&(this._voicingDialValue=G,this.actions.setVoicing(G))}else if(l==="bassVoicing"){const L=this._bassVoicingDialValue??((E=this.state)==null?void 0:E.bassVoicing)??0,G=g(L+p*y(T),-24,24);G!==L&&(this._bassVoicingDialValue=G,this.actions.setBassVoicing(G))}};let b=null;this.container.addEventListener("mousedown",l=>{const p=l.target.closest("#voicing-knob, #bass-knob");p&&(l.preventDefault(),b={knob:p,type:p.id==="voicing-knob"?"voicing":"bassVoicing",lastY:l.clientY,fine:l.shiftKey},document.body.style.cursor="ns-resize")}),document.addEventListener("mousemove",l=>{if(!b)return;const V=(b.lastY-l.clientY)/3;Math.abs(V)>=1&&(M(b.type,V,b.fine),b.lastY=l.clientY)}),document.addEventListener("mouseup",()=>{b&&(b=null,document.body.style.cursor="")}),this.container.addEventListener("wheel",l=>{const p=l.target.closest("#voicing-knob, #bass-knob");if(p){l.preventDefault();const T=p.id==="voicing-knob"?"voicing":"bassVoicing",V=l.deltaY>0?-1:1;M(T,V,l.shiftKey)}},{passive:!1});const x=document.getElementById("flavour-toggle");x&&x.addEventListener("click",()=>this.actions.toggleFlavour());const k=document.getElementById("record-btn");k&&k.addEventListener("click",()=>this.actions.toggleRecording())}}const _={h:"C",u:"C#",j:"D",i:"D#",k:"E",l:"F",o:"F#",";":"G",p:"G#","'":"A","[":"A#","]":"B"},$={12:"6",14:"7",16:"maj7",17:"9"},K={q:"6",w:"7",e:"maj7",r:"9"},Le={a:"major",s:"minor",d:"suspended",f:"diminished"},we={ArrowUp:1,ArrowDown:-1};class Se{constructor(){this.audio=new me,this.logic=new ye,this.voicing=new ve,this.stateManager=new D,this.midi=new be({onNoteOn:(t,s)=>this.handleMidiNoteOn(t,s),onNoteOff:t=>this.handleMidiNoteOff(t),onControlChange:(t,s)=>this.handleMidiControlChange(t,s),onPitchBend:(t,s)=>this.handleMidiPitchBend(t,s),onConnection:(t,s)=>this.stateManager.setMidiConnected(s)}),this.looper=new Te(this.audio.ctx,{onPlay:(t,s)=>this.audio.playNote(t),onStop:t=>this.stopNoteFromLooper(t),onProgress:(t,s,i)=>this.updateLoopProgress(t,s,i),onMetronome:(t,s)=>this.audio.playClick(t,s)}),this.beatEngine=new Me(this.audio.ctx),this.beatEngine.output.connect(this.audio.masterGain),this.arpeggiator=new xe(this.audio.ctx,{onNoteOn:(t,s)=>this.audio.playArpNote(t,s),onNoteOff:t=>{}}),this.patternPlayer=new Ee(this.audio.ctx,{onNoteOn:(t,s)=>this.audio.playArpNote(t,s),onNoteOff:t=>{}}),this.strumVoices=new Map,this.strummer=new Ve({onNoteOn:(t,s)=>{const i=this.audio.playNote(t,s/127);this.strumVoices.set(t,i)},onNoteOff:t=>{const s=this.strumVoices.get(t);s&&(this.audio.stopNote(s),this.strumVoices.delete(t))}}),this.currentRecordedNotes=new Set,this.heldChordType=null,this.playstyleForceSingle=!1,this.playstyleOverrideType=null,this._boundKeyDown=t=>this.handleKeyDown(t),this._boundKeyUp=t=>this.handleKeyUp(t);const e=document.querySelector("#synth-interface");this.ui=new ke(e,{togglePower:()=>this.stateManager.setPower(!this.stateManager.get("powered")),setChordType:t=>this.stateManager.setChordType(t),toggleExtension:t=>this.stateManager.toggleExtension(t),setRoot:t=>this.stateManager.setRoot(t),setVoicing:t=>this.stateManager.setVoicingCenter(t),setFilter:t=>this.stateManager.setFilterCutoff(t),setBassVoicing:t=>this.stateManager.setBassVoicing(t),setBassVolume:t=>this.stateManager.setBassVolume(t),setVolume:t=>this.stateManager.setVolume(t),toggleFlavour:()=>this.stateManager.toggleFlavour(),toggleBass:()=>this.stateManager.toggleBass(),cycleBassMode:()=>this.stateManager.cycleBassMode(),cyclePatch:t=>this.stateManager.cyclePatch(t),toggleRecording:()=>this.toggleRecording(),toggleKey:()=>this.stateManager.toggleKey(),toggleKeyAutoChords:()=>this.stateManager.toggleKeyAutoChords(),cycleKeyRoot:t=>this.stateManager.cycleKeyRoot(t),cycleKeyScale:()=>this.stateManager.cycleKeyScale(),setPlaystyle:t=>this.stateManager.setPlaystyle(t),cyclePlaystyle:()=>this.stateManager.cyclePlaystyle(),pressChordType:t=>this.handleChordTypePress(t),releaseChordType:t=>this.handleChordTypeRelease(t),cyclePerformMode:()=>this.stateManager.cyclePerformMode(),cycleArpPattern:()=>this.stateManager.cycleArpPattern(),setPerformValue:t=>this.setPerformValue(t),setBpm:t=>this.stateManager.setBpm(t),tapTempo:()=>this.tapTempo(),toggleMetronome:()=>this.stateManager.toggleMetronome(),toggleBeatEngine:()=>{const t=!this.stateManager.get("beatEnabled");this.stateManager.setBeatEnabled(t)},cycleBeatPattern:t=>this.stateManager.cycleBeatPattern(t),cycleFxType:()=>this.stateManager.cycleCurrentEffect(),setFxLevel:(t,s)=>this.stateManager.setFxLevel(t,s),adjustFxLevel:(t,s)=>this.stateManager.adjustFxLevel(t,s),toggleFxLock:()=>this.stateManager.toggleFxLock(),toggleLoopRecord:()=>this.toggleLoopRecord(),toggleLoopPlay:()=>this.toggleLoopPlay(),loopRecord:()=>{if(this.looper.state==="idle"){const t=this.stateManager.state.loopLength==="free"?0:this.stateManager.state.loopLength;let s=null;this.stateManager.state.beatEnabled&&t!==0&&(s=this.beatEngine.getNextBarTime()),this.looper.record(t,s)}this.stateManager.setLooperState(this.looper.state)},loopOverdub:()=>{this.looper.state==="playing"&&this.looper.overdub(),this.stateManager.setLooperState(this.looper.state)},loopStop:()=>{this.looper.stop(),this.stateManager.setLooperState(this.looper.state)},loopClear:()=>{this.looper.stop(),this.looper.layers=[],this.stateManager.setLooperState(this.looper.state)},undoLoop:()=>{this.looper.undo(),this.stateManager.setLooperState(this.looper.state)},cycleLoopEncoder:t=>{this.looper.state==="idle"?this.stateManager.cycleLoopLength(t):this.stateManager.cycleLoopMenu(t)},clickLoopEncoder:()=>this.handleClickLoopEncoder()}),this.init()}get state(){return this.stateManager.state}async init(){this.ui.mount(this.stateManager.state),this.audio.setVolume(this.stateManager.state.volume),this.audio.setBassVolume(this.stateManager.state.bassVolume),this.audio.setFilterCutoff(this.stateManager.state.filterCutoff),this.audio.setFxLevels(this.stateManager.state.fxLevels),this.audio.setFxBpm(this.stateManager.state.bpm),this.audio.setFxBypass(this.stateManager.state.currentEffect==="direct"),this.audio.setFlavourEnabled(this.stateManager.state.flavourEnabled),this.stateManager.subscribe((e,t)=>{this.ui.update(e),this.handleStateChange(e,t)}),window.addEventListener("keydown",this._boundKeyDown),window.addEventListener("keyup",this._boundKeyUp),await this.midi.init()}destroy(){window.removeEventListener("keydown",this._boundKeyDown),window.removeEventListener("keyup",this._boundKeyUp),this.midi.destroy(),this.looper.stop(),this.audio.stopAll()}setKeyPressed(e,t){const s=document.querySelector(`.key[data-note="${e}"]`);s&&s.classList.toggle("pressed",t)}getPlaybackOptions(){const e=this.stateManager.state,t=e.keyEnabled&&e.keyAutoChords;return{forceSingle:t?!1:this.playstyleForceSingle,overrideType:t?null:this.playstyleOverrideType}}handleChordTypePress(e){this.stateManager.get("keyEnabled")&&this.stateManager.get("keyAutoChords")&&this.stateManager.setKeyAutoChords(!1),this.heldChordType=e;const t=this.stateManager.get("playstyle"),s=this.stateManager.state.activeMidiNotes.size>0;t==="simple"&&s||(this.stateManager.setChordType(e),(t==="advanced"||t==="free")&&s&&(this.playstyleForceSingle=!1,this.playstyleOverrideType=e,this.playCurrentChord({forceSingle:!1,overrideType:e})))}handleChordTypeRelease(e){this.heldChordType===e&&(this.heldChordType=null);const t=this.stateManager.get("playstyle"),s=this.stateManager.state.activeMidiNotes.size>0;t==="free"&&s&&(this.playstyleForceSingle=!0,this.playstyleOverrideType=null,this.playCurrentChord({forceSingle:!0}))}handleStateChange(e,t){const s=["powered","root","type","extensions","voicingCenter","filterCutoff","midiConnected","activeMidiNotes","looperState","isPlaying","bassEnabled","bassMode","bassVoicing","bassVolume","volume","flavourEnabled","currentPatch","keyEnabled","keyRoot","keyScale","keyAutoChords","performMode","arpPattern","arpDivision","arpOctave","strumSpeed","rhythmPattern","playstyle","bpm","metronomeOn","currentEffect","fxLocked","fxLevels","recording"];for(const n of t)s.includes(n)||console.warn(`[Poorchid] Unknown state key changed: '${n}'`);if(t.includes("filterCutoff")&&this.audio.setFilterCutoff(e.filterCutoff),t.includes("bassVolume")&&this.audio.setBassVolume(e.bassVolume),t.includes("volume")&&this.audio.setVolume(e.volume),t.includes("flavourEnabled")&&this.audio.setFlavourEnabled(e.flavourEnabled),t.includes("currentPatch")&&this.audio.setPatch(e.currentPatch),t.includes("bpm")&&(this.arpeggiator.setBpm(e.bpm),this.patternPlayer.setBpm(e.bpm),this.audio.setFxBpm(e.bpm),this.looper.setBpm(e.bpm)),t.includes("arpPattern")&&this.arpeggiator.setPattern(e.arpPattern),t.includes("arpDivision")&&this.arpeggiator.setDivision(e.arpDivision),t.includes("arpOctave")&&this.arpeggiator.setOctaveRange(e.arpOctave),t.includes("strumSpeed")&&this.strummer.setSpeed(e.strumSpeed),t.includes("rhythmPattern")&&this.patternPlayer.setPattern(e.rhythmPattern),t.includes("performMode")&&(e.performMode!=="arp"&&this.arpeggiator.stop(),e.performMode!=="pattern"&&this.patternPlayer.stop(),["strum","strum2","slop","harp"].includes(e.performMode)?this.strummer.setMode(e.performMode):this.strummer.release()),t.includes("fxLevels")&&this.audio.setFxLevels(e.fxLevels),t.includes("currentEffect")){const n=e.currentEffect==="direct";this.audio.setFxBypass(n)}t.includes("fxLocked"),t.includes("playstyle")&&(e.playstyle==="simple"&&!this.heldChordType&&(this.playstyleForceSingle=!0,this.playstyleOverrideType=null),e.isPlaying&&this.playCurrentChord(this.getPlaybackOptions())),t.includes("powered")&&(e.powered?this.audio.resume():(this.audio.stopAll(),this.arpeggiator.stop(),this.strummer.release(),this.stateManager.setIsPlaying(!1))),t.includes("bassEnabled")&&!e.bassEnabled&&this.audio.stopBass(),t.includes("bassMode")&&e.bassMode==="direct"&&this.audio.stopBass();const i=["type","extensions","voicingCenter","bassMode","bassVoicing","bassEnabled","keyAutoChords"];e.powered&&(t.includes("root")?this.playCurrentChord(this.getPlaybackOptions()):e.isPlaying&&t.some(n=>i.includes(n))&&this.playCurrentChord(this.getPlaybackOptions())),t.includes("beatEnabled")&&(e.beatEnabled?this.beatEngine.start():this.beatEngine.stop()),t.includes("beatPattern")&&this.beatEngine.setPattern(e.beatPattern),t.includes("bpm")&&this.beatEngine.setBpm(e.bpm)}playCurrentChord(e={}){const t=this.stateManager.state;let s=t.root,i=e.overrideType||t.type,n=!!e.forceSingle;["strum","strum2","slop","harp"].includes(t.performMode)&&(n=!1),t.keyEnabled&&t.keyAutoChords&&(s=this.logic.quantizeRoot(s,t.keyRoot,t.keyScale),i=this.logic.getDiatonicChordType(s,t.keyRoot,t.keyScale),n=!1);const c=n?[this.logic.getMidiRoot(s)]:this.logic.getNotes(s,i,Array.from(t.extensions)),r=this.voicing.getVoicing(c,t.voicingCenter),d=this.logic.getMidiRoot(t.root)-24+t.bassVoicing;if(t.performMode==="arp"){if(this.arpeggiator.updateNotes(r),!this.arpeggiator.isRunning){let h=null;t.beatEnabled&&(h=this.beatEngine.getNextNoteTime()),this.arpeggiator.start(r,h)}t.bassEnabled&&this.audio.playBass(d),this.stateManager.setIsPlaying(!0);return}else if(["strum","strum2","slop","harp"].includes(t.performMode)){this.strummer.release(),this.strummer.setMode(t.performMode),this.strummer.strum(r),t.bassEnabled&&this.audio.playBass(d),this.stateManager.setIsPlaying(!0);return}else if(t.performMode==="pattern"){if(this.patternPlayer.updateNotes(r),!this.patternPlayer.isRunning){let h=null;t.beatEnabled&&(h=this.beatEngine.getNextNoteTime()),this.patternPlayer.start(r,h)}t.bassEnabled&&this.audio.playBass(d),this.stateManager.setIsPlaying(!0);return}if(this.arpeggiator.isRunning&&this.arpeggiator.stop(),this.patternPlayer.isRunning&&this.patternPlayer.stop(),!t.bassEnabled)this.audio.playChord(r),this.audio.stopBass();else switch(t.bassMode){case"direct":this.audio.playChord(r),this.audio.stopBass();break;case"solo":this.audio.playChord([]),this.audio.playBass(d);break;case"unison":if(this.audio.playChord(r),r.length>0){const h=Math.min(...r);this.audio.playBass(h-12+t.bassVoicing)}break;case"single":this.audio.playChord(r),this.audio.playBass(d);break;case"chords":default:this.audio.playChord(r),r.length>0?this.audio.playBass(d):this.audio.stopBass();break}if(this.stateManager.setIsPlaying(!0),this.looper.state==="recording"||this.looper.state==="overdubbing"){for(const h of this.currentRecordedNotes)r.includes(h)||(this.looper.addEvent({type:"noteOff",note:h}),this.currentRecordedNotes.delete(h));for(const h of r)this.currentRecordedNotes.has(h)||(this.looper.addEvent({type:"noteOn",note:h,velocity:100}),this.currentRecordedNotes.add(h))}}handleClickLoopEncoder(){const e=this.stateManager.state;if(this.looper.state==="idle"){const t=e.loopLength==="free"?0:e.loopLength;let s=null;e.beatEnabled&&t!==0&&(s=this.beatEngine.getNextBarTime()),this.looper.record(t,s)}else if(this.looper.state==="recording")this.looper.play();else switch(e.loopMenu){case"play":if(this.looper.state!=="playing"){let t=null;e.beatEnabled&&(t=this.beatEngine.getNextBarTime()),this.looper.play(t)}break;case"overdub":if(this.looper.state==="playing")this.looper.overdub();else{let t=null;e.beatEnabled&&(t=this.beatEngine.getNextBarTime()),this.looper.play(t)}break;case"stop":this.looper.stop();break;case"undo":this.looper.undo();break;case"clear":this.looper.stop(),this.looper.layers=[];break}this.stateManager.setLooperState(this.looper.state)}toggleLoopRecord(){if(this.looper.state==="idle"){const e=this.stateManager.state.loopLength==="free"?0:this.stateManager.state.loopLength;let t=null;this.stateManager.state.beatEnabled&&e!==0&&(t=this.beatEngine.getNextBarTime()),this.looper.record(e,t)}else this.looper.state==="recording"?this.looper.play():this.looper.state==="playing"?this.looper.overdub():this.looper.state==="overdubbing"&&this.looper.play();this.stateManager.setLooperState(this.looper.state)}toggleLoopPlay(){if(this.looper.state==="playing"||this.looper.state==="overdubbing")this.looper.stop();else{let e=null;this.stateManager.state.beatEnabled&&(e=this.beatEngine.getNextBarTime()),this.looper.play(e)}this.stateManager.setLooperState(this.looper.state)}async toggleRecording(){if(!this.audio.isRecordingSupported()){alert("Recording is not supported in this browser.");return}if(!this.stateManager.get("recording"))this.audio.startRecording()?this.stateManager.setRecording(!0):alert("Could not start recording.");else{this.stateManager.setRecording(!1);const t=await this.audio.stopRecording();t&&this.saveRecording(t)}}saveRecording(e){const t=new Date().toISOString().replace(/[:.]/g,"-"),s=e.type.includes("wav")?"wav":e.type.includes("ogg")?"ogg":"webm",i=`poorchid-${t}.${s}`,n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=i,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(n),1e3)}stopNoteFromLooper(e){const t=this.audio.activeOscillators.get(e);t&&Array.from(t).forEach(s=>this.audio.stopNote(s))}updateLoopProgress(e,t,s){const i=document.querySelector(".reel-progress");if(i){i.style.strokeDashoffset=1-e;const n=document.querySelector(".tape-reel svg");n&&(n.style.transform=`rotate(${e*360}deg)`)}t!==void 0&&s!==void 0&&this.stateManager.setLoopBarsRecorded(`${t}/${s}`)}handleMidiNoteOn(e,t){if(!this.stateManager.get("powered"))return;const s=$[e];if(s){this.stateManager.setExtension(s,!0);return}const i=this.logic.getNoteName(e);if(!i)return;const n=this.stateManager.get("playstyle"),o=this.stateManager.get("keyEnabled")&&this.stateManager.get("keyAutoChords"),c=!!this.heldChordType;let r=o||c,u=c?this.heldChordType:null;!r&&n==="advanced"&&this.playstyleOverrideType&&this.stateManager.state.activeMidiNotes.size>0&&(r=!0,u=this.playstyleOverrideType),this.playstyleForceSingle=!r,this.playstyleOverrideType=r?u:null,r&&u&&this.stateManager.setChordType(u),this.stateManager.state.activeMidiNotes.add(e);const d=this.stateManager.get("root")!==i;this.stateManager.setRoot(i),d||this.playCurrentChord(this.getPlaybackOptions()),this.setKeyPressed(i,!0)}handleMidiNoteOff(e){if(!this.stateManager.get("powered"))return;const t=$[e];if(t){this.stateManager.setExtension(t,!1);return}const s=this.logic.getNoteName(e);if(s&&this.setKeyPressed(s,!1),this.stateManager.state.activeMidiNotes.delete(e),this.stateManager.state.activeMidiNotes.size===0){if(this.audio.stopAll(),this.arpeggiator.stop(),this.patternPlayer.stop(),this.strummer.release(),this.stateManager.setIsPlaying(!1),this.playstyleForceSingle=!1,this.playstyleOverrideType=null,this.currentRecordedNotes){for(const i of this.currentRecordedNotes)this.looper.addEvent({type:"noteOff",note:i});this.currentRecordedNotes.clear()}}else if(this.logic.getNoteName(e)===this.stateManager.get("root")&&this.stateManager.state.activeMidiNotes.size>0){const n=Array.from(this.stateManager.state.activeMidiNotes).pop(),o=this.logic.getNoteName(n);this.stateManager.setRoot(o)}}handleMidiControlChange(e,t){if(e===1){const n=100*Math.pow(100,t/127);this.stateManager.setFilterCutoff(Math.round(n))}}handleMidiPitchBend(e,t){}handleKeyDown(e){if(e.repeat||e.ctrlKey||e.metaKey||e.altKey)return;const t=e.key.toLowerCase(),s=K[t];if(s){this.stateManager.setExtension(s,!0);return}const i=Le[t];if(i){this.stateManager.get("keyEnabled")&&this.stateManager.get("keyAutoChords")&&this.stateManager.setKeyAutoChords(!1),this.stateManager.setChordType(i);return}const n=we[t];if(n){const c=this.stateManager.get("voicingCenter"),r=Math.max(36,Math.min(84,c+n));this.stateManager.setVoicingCenter(r);return}const o=_[t];if(o){const c=this.logic.getMidiRoot(o);this.handleMidiNoteOn(c,100)}}handleKeyUp(e){const t=e.key.toLowerCase(),s=K[t];if(s){this.stateManager.setExtension(s,!1);return}const i=_[t];if(i){const n=this.logic.getMidiRoot(i);this.handleMidiNoteOff(n)}}setPerformValue(e){const t=this.stateManager.get("performMode");if(t==="arp"){const s=["1/1","1/2","1/4","1/8","1/16","1/32","1/4T","1/8T","1/16T"],i=Math.min(8,Math.floor(e/11));this.stateManager.setArpDivision(s[i])}else if(["strum","strum2","slop","harp"].includes(t))this.stateManager.setStrumSpeed(e),this.strummer.setSpeed(e);else if(t==="pattern"){const s=["straight","offbeat","pulse","tresillo","clave","shuffle","waltz","funk"],i=Math.min(7,Math.floor(e/12.5));this.stateManager.setRhythmPattern(s[i])}}tapTempo(){const e=this.arpeggiator.tapTempo();this.stateManager.setBpm(e)}}document.querySelector("#synth-interface")&&new Se;
