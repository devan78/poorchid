var U=Object.defineProperty;var Y=(a,e,t)=>e in a?U(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var _=(a,e,t)=>Y(a,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();function I(a){return!Number.isFinite(a)||a<0||a>127?440:440*Math.pow(2,(a-69)/12)}function H(a,{attack:e=.01,decay:t=.1,sustain:s=.7,release:i=.3}={}){const n=a.createGain();return n.gain.value=0,{node:n,trigger(o=a.currentTime,r=1){const c=o;n.gain.cancelScheduledValues(c),n.gain.setValueAtTime(0,c),n.gain.linearRampToValueAtTime(r,c+e),n.gain.linearRampToValueAtTime(s*r,c+e+t)},release(o=a.currentTime){const r=o;return n.gain.cancelScheduledValues(r),n.gain.setValueAtTime(n.gain.value,r),n.gain.exponentialRampToValueAtTime(.001,r+i),i}}}function z(a,{type:e="sine",rate:t=1,depth:s=1}={}){const i=a.createOscillator(),n=a.createGain();return i.type=e,i.frequency.value=t,n.gain.value=s,i.connect(n),i.start(),{output:n,setRate(o){i.frequency.value=o},setDepth(o){n.gain.value=o},connect(o){n.connect(o)},stop(){i.stop()}}}function W(a,{type:e="lowpass",frequency:t=2e3,Q:s=1,envAmount:i=0}={}){const n=a.createBiquadFilter();return n.type=e,n.frequency.value=t,n.Q.value=s,{node:n,baseFreq:t,envAmount:i,modulateWithEnvelope(o,r){const c=this.baseFreq+o*this.envAmount;n.frequency.setTargetAtTime(Math.max(20,Math.min(2e4,c)),r,.01)},setFrequency(o){this.baseFreq=o,n.frequency.value=o}}}function Q(a,e,t={}){const{oscTypes:s=["sawtooth","sawtooth","square","triangle"],oscDetune:i=[0,7,-5,12],oscMix:n=[.4,.3,.2,.1],filterFreq:o=2e3,filterQ:r=2,filterEnvAmount:c=3e3,ampEnv:u={attack:.01,decay:.2,sustain:.6,release:.4},filterEnv:h={attack:.01,decay:.3,sustain:.3,release:.3},lfoRate:p=.5,lfoDepth:g=10,velocity:d=.8}=t,m=a.currentTime,y=s.map((f,v)=>{const E=a.createOscillator(),L=a.createGain();return E.type=f,E.frequency.value=e,E.detune.value=i[v]||0,L.gain.value=n[v]||.25,E.connect(L),E.start(m),{osc:E,gain:L}}),T=a.createGain();y.forEach(f=>f.gain.connect(T));const x=W(a,{frequency:o,Q:r,envAmount:c});T.connect(x.node);const M=H(a,u);x.node.connect(M.node);const V=z(a,{rate:p,depth:g});y.forEach(f=>V.connect(f.osc.detune));const k=a.createGain();k.gain.setValueAtTime(0,m),k.gain.linearRampToValueAtTime(1,m+h.attack),k.gain.linearRampToValueAtTime(h.sustain,m+h.attack+h.decay),M.trigger(m,d*.5);const l=a.createGain();return l.gain.value=.7,M.node.connect(l),{output:l,release(f=0){const v=a.currentTime+f,E=M.release(v);return setTimeout(()=>{y.forEach(L=>{L.osc.stop(),L.osc.disconnect(),L.gain.disconnect()}),V.stop(),T.disconnect(),x.node.disconnect(),M.node.disconnect(),l.disconnect()},(E+.1)*1e3),E}}}function X(a,e,t={}){const{algorithm:s=1,operators:i=[{ratio:1,level:1,env:{attack:.01,decay:.2,sustain:.6,release:.3}},{ratio:2,level:.5,env:{attack:.01,decay:.4,sustain:.2,release:.2}},{ratio:3,level:.3,env:{attack:.01,decay:.3,sustain:.1,release:.2}},{ratio:4,level:.2,env:{attack:.01,decay:.2,sustain:.05,release:.1}}],velocity:n=.8}=t,o=a.currentTime,r=.3+n*.4,c=i.map((p,g)=>{const d=a.createOscillator(),m=a.createGain(),y=a.createGain();return d.type="sine",d.frequency.value=e*p.ratio,m.gain.value=p.level*e,y.gain.setValueAtTime(0,o),y.gain.linearRampToValueAtTime(1,o+p.env.attack),y.gain.linearRampToValueAtTime(p.env.sustain,o+p.env.attack+p.env.decay),d.connect(m),m.connect(y),d.start(o),{osc:d,gain:m,env:y,params:p}}),u=a.createGain();switch(u.gain.value=r,s){case 1:c[3].env.connect(c[2].osc.frequency),c[2].env.connect(c[1].osc.frequency),c[1].env.connect(c[0].osc.frequency),c[0].env.connect(u);break;case 2:c[3].env.connect(c[2].osc.frequency),c[2].env.connect(c[0].osc.frequency),c[1].env.connect(c[0].osc.frequency),c[0].env.connect(u);break;case 3:c[3].env.connect(c[0].osc.frequency),c[2].env.connect(c[0].osc.frequency),c[1].env.connect(c[0].osc.frequency),c[0].env.connect(u);break;case 4:default:c[3].env.connect(c[2].osc.frequency),c[2].env.connect(u),c[1].env.connect(c[0].osc.frequency),c[0].env.connect(u);break}const h=a.createGain();return h.gain.value=.7,u.connect(h),{output:h,release(p=0){const g=a.currentTime+p,d=.3;return c.forEach(m=>{m.env.gain.cancelScheduledValues(g),m.env.gain.setValueAtTime(m.env.gain.value,g),m.env.gain.exponentialRampToValueAtTime(.001,g+d),m.osc.stop(g+d)}),setTimeout(()=>{c.forEach(m=>{m.osc.disconnect(),m.gain.disconnect(),m.env.disconnect()}),u.disconnect(),h.disconnect()},(d+.1)*1e3),d}}}function Z(a,e,t={}){const{tineLevel:s=.6,barkLevel:i=.3,velocity:n=.8,hardness:o=.5}=t,r=a.currentTime,c=.3+n*.4,u=(.5+o)*n,h=a.createOscillator();h.type="sine",h.frequency.value=e;const p=a.createOscillator(),g=a.createGain();p.type="sine",p.frequency.value=e,g.gain.setValueAtTime(e*u*s,r),g.gain.exponentialRampToValueAtTime(e*.1*s,r+.5),p.connect(g),g.connect(h.frequency);const d=a.createOscillator(),m=a.createGain();d.type="sine",d.frequency.value=e*7,m.gain.setValueAtTime(e*.3*i*n,r),m.gain.exponentialRampToValueAtTime(.001,r+.15),d.connect(m),m.connect(h.frequency);const y=a.createOscillator(),T=a.createGain();y.type="sine",y.frequency.value=e*2,T.gain.value=.15,y.connect(T);const x=a.createGain();x.gain.setValueAtTime(0,r),x.gain.linearRampToValueAtTime(c,r+.005),x.gain.exponentialRampToValueAtTime(c*.6,r+.1),x.gain.setTargetAtTime(c*.4,r+.1,1.5),h.connect(x),T.connect(x);const M=a.createGain();return M.gain.value=.5,x.connect(M),h.start(r),p.start(r),d.start(r),y.start(r),{output:M,release(V=0){const k=a.currentTime+V,l=.4;return x.gain.cancelScheduledValues(k),x.gain.setValueAtTime(x.gain.value,k),x.gain.exponentialRampToValueAtTime(.001,k+l),h.stop(k+l),p.stop(k+l),d.stop(k+l),y.stop(k+l),setTimeout(()=>{h.disconnect(),p.disconnect(),d.disconnect(),y.disconnect(),g.disconnect(),m.disconnect(),T.disconnect(),x.disconnect(),M.disconnect()},(l+.1)*1e3),l}}}const J={VA:Q,FM:X,EP:Z},ee={id:"orchid-ep",name:"Orchid EP",category:"keys",engine:"EP",params:{tineLevel:.6,barkLevel:.25,hardness:.5},createVoice(a,e,t=.8){return J.EP(a,e,{...this.params,velocity:t})}},te={id:"analog-flower",name:"Analog Flower",category:"pad",createVoice(a,e,t=.8){const s=a.currentTime,i=.25+t*.35,n=[],o=[-12,-5,5,12],r=a.createGain();r.gain.value=.4,o.forEach(d=>{const m=a.createOscillator();m.type="sawtooth",m.frequency.value=e,m.detune.value=d;const y=a.createGain();y.gain.value=.28,m.connect(y),y.connect(r),m.start(s),n.push({osc:m,gain:y})});const c=a.createBiquadFilter();c.type="lowpass",c.frequency.value=600,c.Q.value=.7,c.frequency.setValueAtTime(400,s),c.frequency.linearRampToValueAtTime(1200,s+.8),c.frequency.setTargetAtTime(900,s+.8,1),r.connect(c);const u=a.createGain();u.gain.setValueAtTime(0,s),u.gain.linearRampToValueAtTime(i,s+.4),u.gain.setTargetAtTime(i*.8,s+.5,.5),c.connect(u);const h=a.createOscillator(),p=a.createGain();h.type="triangle",h.frequency.value=.4,p.gain.value=3,h.connect(p),n.forEach(d=>p.connect(d.osc.detune)),h.start(s);const g=a.createGain();return g.gain.value=.8,u.connect(g),{output:g,release(d=0){const m=a.currentTime+d,y=1.2;return u.gain.cancelScheduledValues(m),u.gain.setValueAtTime(u.gain.value,m),u.gain.exponentialRampToValueAtTime(.001,m+y),c.frequency.setTargetAtTime(200,m,.3),n.forEach(T=>T.osc.stop(m+y)),h.stop(m+y),setTimeout(()=>{n.forEach(T=>{T.osc.disconnect(),T.gain.disconnect()}),h.disconnect(),p.disconnect(),r.disconnect(),c.disconnect(),u.disconnect(),g.disconnect()},(y+.1)*1e3),y}}}},se={id:"mellow-bells",name:"Mellow Bells",category:"keys",createVoice(a,e,t=.8){const s=a.currentTime,i=.2+t*.25,n=a.createOscillator();n.type="sine",n.frequency.value=e;const o=a.createOscillator(),r=a.createGain();o.type="sine",o.frequency.value=e*3;const c=e*.8*t;r.gain.setValueAtTime(c,s),r.gain.exponentialRampToValueAtTime(c*.1,s+.3),r.gain.setTargetAtTime(c*.02,s+.3,.8),o.connect(r),r.connect(n.frequency);const u=a.createOscillator(),h=a.createGain();u.type="sine",u.frequency.value=e*.5,h.gain.value=.15,u.connect(h);const p=a.createGain();p.gain.setValueAtTime(0,s),p.gain.linearRampToValueAtTime(i,s+.015),p.gain.exponentialRampToValueAtTime(i*.5,s+.2),p.gain.setTargetAtTime(i*.25,s+.2,1.5);const g=a.createBiquadFilter();g.type="lowpass",g.frequency.value=2500,g.Q.value=.5,n.connect(g),h.connect(g),g.connect(p);const d=a.createGain();return d.gain.value=.5,p.connect(d),n.start(s),o.start(s),u.start(s),{output:d,release(m=0){const y=a.currentTime+m,T=.8;return p.gain.cancelScheduledValues(y),p.gain.setValueAtTime(p.gain.value,y),p.gain.exponentialRampToValueAtTime(.001,y+T),n.stop(y+T),o.stop(y+T),u.stop(y+T),setTimeout(()=>{n.disconnect(),o.disconnect(),r.disconnect(),u.disconnect(),h.disconnect(),g.disconnect(),p.disconnect(),d.disconnect()},(T+.1)*1e3),T}}}},ie={id:"warm-lead",name:"Warm Lead",category:"lead",createVoice(a,e,t=.8){const s=a.currentTime,i=.2+t*.25,n=a.createOscillator();n.type="square",n.frequency.value=e;const o=a.createOscillator();o.type="sine",o.frequency.value=e*.5;const r=a.createGain(),c=a.createGain();c.gain.value=.3,n.connect(c),c.connect(r);const u=a.createGain();u.gain.value=.2,o.connect(u),u.connect(r);const h=a.createBiquadFilter();h.type="lowpass",h.Q.value=2,h.frequency.setValueAtTime(300,s),h.frequency.linearRampToValueAtTime(1800*t,s+.08),h.frequency.setTargetAtTime(800,s+.1,.3),r.connect(h);const p=a.createGain();p.gain.setValueAtTime(0,s),p.gain.linearRampToValueAtTime(i,s+.02),p.gain.setTargetAtTime(i*.7,s+.1,.2),h.connect(p);const g=a.createOscillator(),d=a.createGain();g.type="sine",g.frequency.value=5,d.gain.setValueAtTime(0,s),d.gain.setTargetAtTime(6,s+.3,.2),g.connect(d),d.connect(n.detune),d.connect(o.detune),g.start(s);const m=a.createGain();return m.gain.value=.5,p.connect(m),n.start(s),o.start(s),{output:m,release(y=0){const T=a.currentTime+y,x=.25;return p.gain.cancelScheduledValues(T),p.gain.setValueAtTime(p.gain.value,T),p.gain.exponentialRampToValueAtTime(.001,T+x),h.frequency.setTargetAtTime(200,T,.1),n.stop(T+x),o.stop(T+x),g.stop(T+x),setTimeout(()=>{n.disconnect(),o.disconnect(),c.disconnect(),u.disconnect(),r.disconnect(),h.disconnect(),p.disconnect(),g.disconnect(),d.disconnect(),m.disconnect()},(x+.1)*1e3),x}}}},ne={id:"tape-strings",name:"Tape Strings",category:"pad",createVoice(a,e,t=.8){const s=a.currentTime,i=.3+t*.4,n=[],o=["sawtooth","sawtooth","triangle"],r=[-8,8,0],c=[.3,.3,.4],u=a.createGain();u.gain.value=.5,o.forEach((x,M)=>{const V=a.createOscillator();V.type=x,V.frequency.value=e,V.detune.value=r[M];const k=a.createGain();k.gain.value=c[M],V.connect(k),k.connect(u),V.start(s),n.push({osc:V,gain:k})});const h=a.createBiquadFilter();h.type="lowpass",h.frequency.value=1800,h.Q.value=.5,h.frequency.setValueAtTime(1200,s),h.frequency.linearRampToValueAtTime(2e3,s+.3),h.frequency.setTargetAtTime(1600,s+.4,.8),u.connect(h);const p=a.createOscillator(),g=a.createGain();p.type="sine",p.frequency.value=.3+Math.random()*.2,g.gain.value=4,p.connect(g),n.forEach(x=>g.connect(x.osc.detune)),p.start(s);const d=a.createOscillator(),m=a.createGain();d.type="sine",d.frequency.value=6,m.gain.value=1.5,d.connect(m),n.forEach(x=>m.connect(x.osc.detune)),d.start(s);const y=a.createGain();y.gain.setValueAtTime(0,s),y.gain.linearRampToValueAtTime(i*.7,s+.08),y.gain.linearRampToValueAtTime(i,s+.2),h.connect(y);const T=a.createGain();return T.gain.value=.5,y.connect(T),{output:T,release(x=0){const M=a.currentTime+x,V=.6;return y.gain.cancelScheduledValues(M),y.gain.setValueAtTime(y.gain.value,M),y.gain.exponentialRampToValueAtTime(.001,M+V),h.frequency.setTargetAtTime(400,M,.2),n.forEach(k=>k.osc.stop(M+V)),p.stop(M+V),d.stop(M+V),setTimeout(()=>{n.forEach(k=>{k.osc.disconnect(),k.gain.disconnect()}),p.disconnect(),g.disconnect(),d.disconnect(),m.disconnect(),u.disconnect(),h.disconnect(),y.disconnect(),T.disconnect()},(V+.1)*1e3),V}}}},ae={id:"fm-harp",name:"FM Harp",category:"pluck",createVoice(a,e,t=.8){const s=a.currentTime,i=.3+t*.5,n=3.5,o=4+t*3,r=a.createOscillator();r.type="sine",r.frequency.value=e;const c=a.createOscillator();c.type="sine",c.frequency.value=e*n;const u=a.createGain();u.gain.value=o*e,u.gain.setValueAtTime(o*e,s),u.gain.exponentialRampToValueAtTime(e*.5,s+.08),u.gain.exponentialRampToValueAtTime(e*.1,s+.4),c.connect(u),u.connect(r.frequency);const h=a.createOscillator();h.type="sine",h.frequency.value=e*1.002;const p=a.createOscillator();p.type="sine",p.frequency.value=e*n*.998;const g=a.createGain();g.gain.value=o*e*.8,g.gain.setValueAtTime(o*e*.8,s),g.gain.exponentialRampToValueAtTime(e*.3,s+.1),g.gain.exponentialRampToValueAtTime(e*.05,s+.5),p.connect(g),g.connect(h.frequency);const d=a.createGain();d.gain.value=.4;const m=a.createGain();m.gain.value=.6;const y=a.createGain();y.gain.value=.4,r.connect(m),h.connect(y),m.connect(d),y.connect(d);const T=a.createBiquadFilter();T.type="highpass",T.frequency.value=80;const x=a.createBiquadFilter();x.type="lowpass",x.frequency.value=8e3,x.Q.value=.5,d.connect(T),T.connect(x);const M=a.createGain();M.gain.setValueAtTime(0,s),M.gain.linearRampToValueAtTime(i,s+.005),M.gain.exponentialRampToValueAtTime(i*.4,s+.15),M.gain.exponentialRampToValueAtTime(i*.15,s+.8),M.gain.setTargetAtTime(i*.08,s+.8,1.5),x.connect(M),r.start(s),h.start(s),c.start(s),p.start(s);const V=a.createGain();return V.gain.value=.7,M.connect(V),{output:V,release(k=0){const l=a.currentTime+k,f=.8;M.gain.cancelScheduledValues(l),M.gain.setValueAtTime(M.gain.value,l),M.gain.exponentialRampToValueAtTime(.001,l+f);const v=l+f+.1;return r.stop(v),h.stop(v),c.stop(v),p.stop(v),setTimeout(()=>{try{r.disconnect(),h.disconnect(),c.disconnect(),p.disconnect(),u.disconnect(),g.disconnect(),d.disconnect(),T.disconnect(),x.disconnect(),M.disconnect(),V.disconnect()}catch{}},(f+.2)*1e3),f}}}},oe={id:"cathedral-organ",name:"Cathedral Organ",category:"keys",drawbars:{16:.8,8:1,4:.7,"2-2/3":.5,2:.6,"1-3/5":.3,"1-1/3":.25,1:.15},createVoice(a,e,t=.8){const s=a.currentTime,i=.25+t*.25,n=[{ratio:.5,level:this.drawbars[16]},{ratio:1,level:this.drawbars[8]},{ratio:2,level:this.drawbars[4]},{ratio:3,level:this.drawbars["2-2/3"]},{ratio:4,level:this.drawbars[2]},{ratio:5,level:this.drawbars["1-3/5"]},{ratio:6,level:this.drawbars["1-1/3"]},{ratio:8,level:this.drawbars[1]}],o=a.createGain();o.gain.value=.15;const r=[];n.forEach(({ratio:f,level:v})=>{if(v<=0)return;const E=a.createOscillator();E.type="sine",E.frequency.value=e*f,E.detune.value=(Math.random()-.5)*4;const L=a.createGain(),w=1/Math.sqrt(f);L.gain.value=v*w*.3,E.connect(L),L.connect(o),E.start(s),r.push({osc:E,gain:L})});const c=a.createOscillator();c.type="square",c.frequency.value=e*8;const u=a.createGain();u.gain.setValueAtTime(.15,s),u.gain.exponentialRampToValueAtTime(.001,s+.008);const h=a.createBiquadFilter();h.type="bandpass",h.frequency.value=2e3,h.Q.value=2,c.connect(h),h.connect(u),u.connect(o),c.start(s),c.stop(s+.02);const p=a.createBuffer(1,a.sampleRate*.1,a.sampleRate),g=p.getChannelData(0);for(let f=0;f<g.length;f++)g[f]=(Math.random()*2-1)*.02;const d=a.createBufferSource();d.buffer=p,d.loop=!0;const m=a.createBiquadFilter();m.type="bandpass",m.frequency.value=400,m.Q.value=.5;const y=a.createGain();y.gain.value=.03,d.connect(m),m.connect(y),y.connect(o),d.start(s);const T=a.createOscillator();T.type="sine",T.frequency.value=5.5;const x=a.createGain();x.gain.value=.08;const M=a.createGain();M.gain.value=1,T.connect(x),x.connect(M.gain),T.start(s),o.connect(M);const V=a.createBiquadFilter();V.type="lowpass",V.frequency.value=4e3,V.Q.value=.5,M.connect(V);const k=a.createGain();k.gain.setValueAtTime(0,s),k.gain.linearRampToValueAtTime(i,s+.01),V.connect(k);const l=a.createGain();return l.gain.value=.9,k.connect(l),{output:l,release(f=0){const v=a.currentTime+f,E=.3;k.gain.cancelScheduledValues(v),k.gain.setValueAtTime(k.gain.value,v),k.gain.exponentialRampToValueAtTime(.001,v+E);const L=v+E+.1;r.forEach(({osc:w})=>{try{w.stop(L)}catch{}});try{d.stop(L),T.stop(L)}catch{}return setTimeout(()=>{try{r.forEach(({osc:w,gain:C})=>{w.disconnect(),C.disconnect()}),d.disconnect(),m.disconnect(),y.disconnect(),T.disconnect(),x.disconnect(),M.disconnect(),o.disconnect(),V.disconnect(),k.disconnect(),l.disconnect()}catch{}},(E+.2)*1e3),E}}}},F={"orchid-ep":ee,"analog-flower":te,"mellow-bells":se,"warm-lead":ie,"tape-strings":ne,"fm-harp":ae,"cathedral-organ":oe},O=["orchid-ep","analog-flower","mellow-bells","warm-lead","tape-strings","fm-harp","cathedral-organ"],D="orchid-ep";function re(a,e=1){const s=(O.indexOf(a)+e+O.length)%O.length;return O[s]}class ce{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.wetGain=e.createGain(),this.dryGain=e.createGain(),this.preDelay=e.createDelay(.1),this.preDelay.delayTime.value=.02,this.delays=[],this.feedbacks=[];const t=[.037,.041,.053,.067];for(let s=0;s<4;s++){const i=e.createDelay(.1);i.delayTime.value=t[s];const n=e.createGain();n.gain.value=.7;const o=e.createBiquadFilter();o.type="lowpass",o.frequency.value=4e3-s*500,this.preDelay.connect(i),i.connect(o),o.connect(n),n.connect(i),o.connect(this.wetGain),this.delays.push(i),this.feedbacks.push(n)}this.input.connect(this.preDelay),this.input.connect(this.dryGain),this.wetGain.connect(this.output),this.dryGain.connect(this.output),this.setLevel(0)}setLevel(e){const t=e/99;this.wetGain.gain.value=t*.7,this.dryGain.gain.value=1-t*.4;const s=.25+t*.4;this.feedbacks.forEach(i=>{i.gain.value=s})}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class le{constructor(e){this.ctx=e,this.bpm=120,this.input=e.createGain(),this.output=e.createGain(),this.wetGain=e.createGain(),this.dryGain=e.createGain(),this.delayL=e.createDelay(2),this.delayR=e.createDelay(2),this.feedbackL=e.createGain(),this.feedbackR=e.createGain(),this.filterL=e.createBiquadFilter(),this.filterL.type="lowpass",this.filterL.frequency.value=3e3,this.filterR=e.createBiquadFilter(),this.filterR.type="lowpass",this.filterR.frequency.value=3e3,this.panL=e.createStereoPanner(),this.panL.pan.value=-.5,this.panR=e.createStereoPanner(),this.panR.pan.value=.5,this.input.connect(this.delayL),this.delayL.connect(this.filterL),this.filterL.connect(this.feedbackL),this.feedbackL.connect(this.delayL),this.filterL.connect(this.panL),this.panL.connect(this.wetGain),this.input.connect(this.delayR),this.delayR.connect(this.filterR),this.filterR.connect(this.feedbackR),this.feedbackR.connect(this.delayR),this.filterR.connect(this.panR),this.panR.connect(this.wetGain),this.input.connect(this.dryGain),this.wetGain.connect(this.output),this.dryGain.connect(this.output),this.feedbackL.gain.value=.4,this.feedbackR.gain.value=.4,this.updateDelayTime(),this.setLevel(0)}setBpm(e){this.bpm=e,this.updateDelayTime()}updateDelayTime(){const t=60/this.bpm/2;this.delayL.delayTime.value=t,this.delayR.delayTime.value=t*1.03}setLevel(e){const t=e/99;this.wetGain.gain.value=t,this.dryGain.gain.value=1-t*.2;const s=t===0?0:.15+t*.35;this.feedbackL.gain.value=s,this.feedbackR.gain.value=s;const i=2200+t*1200;this.filterL.frequency.value=i,this.filterR.frequency.value=i}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class he{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.wetGain=e.createGain(),this.dryGain=e.createGain(),this.delayL=e.createDelay(.05),this.delayL.delayTime.value=.012,this.delayR=e.createDelay(.05),this.delayR.delayTime.value=.015,this.lfoL=e.createOscillator(),this.lfoL.type="sine",this.lfoL.frequency.value=.8,this.lfoR=e.createOscillator(),this.lfoR.type="sine",this.lfoR.frequency.value=.9,this.depthL=e.createGain(),this.depthL.gain.value=.003,this.depthR=e.createGain(),this.depthR.gain.value=.003,this.lfoL.connect(this.depthL),this.depthL.connect(this.delayL.delayTime),this.lfoR.connect(this.depthR),this.depthR.connect(this.delayR.delayTime),this.lfoL.start(),this.lfoR.start(),this.panL=e.createStereoPanner(),this.panL.pan.value=-.3,this.panR=e.createStereoPanner(),this.panR.pan.value=.3,this.input.connect(this.delayL),this.input.connect(this.delayR),this.input.connect(this.dryGain),this.delayL.connect(this.panL),this.delayR.connect(this.panR),this.panL.connect(this.wetGain),this.panR.connect(this.wetGain),this.wetGain.connect(this.output),this.dryGain.connect(this.output),this.setLevel(0)}setLevel(e){const t=e/99;this.wetGain.gain.value=t*.5,this.dryGain.gain.value=1-t*.2,this.depthL.gain.value=5e-4+t*.0035,this.depthR.gain.value=5e-4+t*.0035}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class ue{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.wetGain=e.createGain(),this.dryGain=e.createGain(),this.lfo=e.createOscillator(),this.lfo.type="sine",this.lfo.frequency.value=.3,this.depth=e.createGain(),this.depth.gain.value=800,this.lfo.connect(this.depth),this.lfo.start(),this.filters=[];let t=this.input;for(let s=0;s<4;s++){const i=e.createBiquadFilter();i.type="allpass",i.frequency.value=1e3,i.Q.value=.5,this.depth.connect(i.frequency),t.connect(i),t=i,this.filters.push(i)}this.feedback=e.createGain(),this.feedback.gain.value=.4,t.connect(this.feedback),this.feedback.connect(this.filters[0]),t.connect(this.wetGain),this.input.connect(this.dryGain),this.wetGain.connect(this.output),this.dryGain.connect(this.output),this.setLevel(0)}setLevel(e){const t=e/99;this.wetGain.gain.value=t*.6,this.dryGain.gain.value=1-t*.3,this.depth.gain.value=200+t*600,this.feedback.gain.value=.1+t*.35}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class de{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.wetGain=e.createGain(),this.dryGain=e.createGain(),this.delay=e.createDelay(.02),this.delay.delayTime.value=.003,this.lfo=e.createOscillator(),this.lfo.type="sine",this.lfo.frequency.value=.2,this.depth=e.createGain(),this.depth.gain.value=.002,this.lfo.connect(this.depth),this.depth.connect(this.delay.delayTime),this.lfo.start(),this.feedback=e.createGain(),this.feedback.gain.value=.6,this.input.connect(this.delay),this.delay.connect(this.feedback),this.feedback.connect(this.delay),this.delay.connect(this.wetGain),this.input.connect(this.dryGain),this.wetGain.connect(this.output),this.dryGain.connect(this.output),this.setLevel(0)}setLevel(e){const t=e/99;this.wetGain.gain.value=t*.7,this.dryGain.gain.value=1-t*.3,this.depth.gain.value=5e-4+t*.0025,this.feedback.gain.value=.2+t*.4}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class pe{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.preGain=e.createGain(),this.preGain.gain.value=1,this.waveshaper=e.createWaveShaper(),this.waveshaper.curve=this.createSaturationCurve(.4),this.waveshaper.oversample="2x",this.postGain=e.createGain(),this.postGain.gain.value=.8,this.toneFilter=e.createBiquadFilter(),this.toneFilter.type="lowpass",this.toneFilter.frequency.value=8e3,this.toneFilter.Q.value=.5,this.input.connect(this.preGain),this.preGain.connect(this.waveshaper),this.waveshaper.connect(this.toneFilter),this.toneFilter.connect(this.postGain),this.postGain.connect(this.output),this.setLevel(0)}createSaturationCurve(e){const s=new Float32Array(256);for(let i=0;i<256;i++){const n=i*2/256-1;s[i]=(Math.PI+e)*n/(Math.PI+e*Math.abs(n))}return s}setLevel(e){const t=e/99,s=.2+t*1.2;this.waveshaper.curve=this.createSaturationCurve(s),this.preGain.gain.value=1+t*1.5,this.postGain.gain.value=.85/(1+t*.8),this.toneFilter.frequency.value=1e4-t*5e3}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class fe{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.modulatedGain=e.createGain(),this.lfo=e.createOscillator(),this.lfo.type="sine",this.lfo.frequency.value=5,this.depth=e.createGain(),this.depth.gain.value=0,this.offset=e.createConstantSource(),this.offset.offset.value=1,this.lfo.connect(this.depth),this.depth.connect(this.modulatedGain.gain),this.offset.connect(this.modulatedGain.gain),this.lfo.start(),this.offset.start(),this.input.connect(this.modulatedGain),this.modulatedGain.connect(this.output),this.setLevel(0)}setLevel(e){const t=e/99;this.depth.gain.value=t*.6,this.offset.offset.value=1-t*.3,this.lfo.frequency.value=2+t*10}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class ge{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.wetGain=e.createGain(),this.dryGain=e.createGain(),this.delays=[],this.lfos=[],this.depths=[];const t=[.3,.5,.7,.9,1.1,1.3],s=[.015,.018,.021,.024,.027,.03],i=[-.8,-.4,-.1,.1,.4,.8];for(let n=0;n<6;n++){const o=e.createDelay(.05);o.delayTime.value=s[n];const r=e.createOscillator();r.type="triangle",r.frequency.value=t[n];const c=e.createGain();c.gain.value=.002,r.connect(c),c.connect(o.delayTime),r.start();const u=e.createStereoPanner();u.pan.value=i[n],this.input.connect(o),o.connect(u),u.connect(this.wetGain),this.delays.push(o),this.lfos.push(r),this.depths.push(c)}this.input.connect(this.dryGain),this.wetGain.connect(this.output),this.dryGain.connect(this.output),this.setLevel(0)}setLevel(e){const t=e/99;this.wetGain.gain.value=t*.5,this.dryGain.gain.value=1-t*.25;for(let s=0;s<this.depths.length;s++)this.depths[s].gain.value=8e-4+t*.0025}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class me{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain(),this.chainGain=e.createGain(),this.bypassGain=e.createGain(),this.chainGain.gain.value=1,this.bypassGain.gain.value=0,this.input.connect(this.bypassGain),this.bypassGain.connect(this.output),this.effects={reverb:new ce(e),delay:new le(e),chorus:new he(e),phaser:new ue(e),flanger:new de(e),drive:new pe(e),tremolo:new fe(e),ensemble:new ge(e)};const t=["drive","phaser","flanger","chorus","ensemble","tremolo","delay","reverb"];let s=this.input;for(const i of t){const n=this.effects[i];s.connect(n.input),s=n.output}s.connect(this.chainGain),this.chainGain.connect(this.output)}setLevel(e,t){this.effects[e]&&this.effects[e].setLevel(t)}setLevels(e){for(const[t,s]of Object.entries(e))this.setLevel(t,s)}setBpm(e){this.effects.delay.setBpm(e)}setBypass(e){this.chainGain.gain.value=e?0:1,this.bypassGain.gain.value=e?1:0}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}}class ye{constructor(){try{this.ctx=new(window.AudioContext||window.webkitAudioContext)}catch(e){console.error("Web Audio API not supported:",e),this.ctx=null;return}this.currentPatch=F[D],this.patchId=D,this.masterGain=this.ctx.createGain(),this.masterGain.gain.value=.5,this.flavourEnabled=!0,this.flavourInput=this.ctx.createGain(),this.flavourOutput=this.ctx.createGain(),this.flavourBypassGain=this.ctx.createGain(),this.flavourBypassGain.gain.value=0,this.flavourHighpass=this.ctx.createBiquadFilter(),this.flavourHighpass.type="highpass",this.flavourHighpass.frequency.value=24,this.flavourHighpass.Q.value=.55,this.flavourLowShelf=this.ctx.createBiquadFilter(),this.flavourLowShelf.type="lowshelf",this.flavourLowShelf.frequency.value=90,this.flavourLowShelf.gain.value=.35,this.flavourHighShelf=this.ctx.createBiquadFilter(),this.flavourHighShelf.type="highshelf",this.flavourHighShelf.frequency.value=11e3,this.flavourHighShelf.gain.value=.4,this.flavourDryGain=this.ctx.createGain(),this.flavourDryGain.gain.value=.9,this.flavourWetGain=this.ctx.createGain(),this.flavourWetGain.gain.value=.1,this.flavourMix=this.ctx.createGain(),this.flavourSaturation=this.ctx.createWaveShaper(),this.flavourSaturation.curve=this.createSaturationCurve(.08),this.flavourSaturation.oversample="4x",this.flavourLimiter=this.ctx.createDynamicsCompressor(),this.flavourLimiter.threshold.value=-.5,this.flavourLimiter.ratio.value=1.8,this.flavourLimiter.knee.value=14,this.flavourLimiter.attack.value=.005,this.flavourLimiter.release.value=.25,this.flavourTrim=this.ctx.createGain(),this.flavourTrim.gain.value=.95,this.compressor=this.ctx.createDynamicsCompressor(),this.compressor.threshold.value=-18,this.compressor.ratio.value=3,this.compressor.knee.value=10,this.compressor.attack.value=.03,this.compressor.release.value=.25,this.masterFilter=this.ctx.createBiquadFilter(),this.masterFilter.type="lowpass",this.masterFilter.frequency.value=3e3,this.masterFilter.Q.value=.7,this.fxChain=new me(this.ctx),this.voiceInput=this.ctx.createGain(),this.voiceInput.gain.value=1,this.voiceInput.connect(this.fxChain.input),this.fxChain.connect(this.masterFilter),this.masterFilter.connect(this.compressor),this.compressor.connect(this.flavourInput),this.compressor.connect(this.flavourBypassGain),this.flavourInput.connect(this.flavourHighpass),this.flavourHighpass.connect(this.flavourLowShelf),this.flavourLowShelf.connect(this.flavourHighShelf),this.flavourHighShelf.connect(this.flavourSaturation),this.flavourHighShelf.connect(this.flavourDryGain),this.flavourSaturation.connect(this.flavourWetGain),this.flavourWetGain.connect(this.flavourMix),this.flavourDryGain.connect(this.flavourMix),this.flavourMix.connect(this.flavourLimiter),this.flavourLimiter.connect(this.flavourTrim),this.flavourTrim.connect(this.flavourOutput),this.flavourOutput.connect(this.masterGain),this.flavourBypassGain.connect(this.masterGain),this.masterGain.connect(this.ctx.destination),this.recordDestination=this.ctx.createMediaStreamDestination(),this.masterGain.connect(this.recordDestination),this.mediaRecorder=null,this.recordedChunks=[],this.isRecording=!1,this.setFlavourEnabled(this.flavourEnabled),this.driftLFO=this.ctx.createOscillator(),this.driftLFO.frequency.value=.4,this.driftGain=this.ctx.createGain(),this.driftGain.gain.value=8,this.driftLFO.connect(this.driftGain),this.driftLFO.start(),this.activeOscillators=new Map,this.liveVoices=new Map,this.bassGain=this.ctx.createGain(),this.bassGain.gain.value=.6,this.bassGain.connect(this.compressor),this.bassVoice=null}setFxLevel(e,t){this.fxChain&&this.fxChain.setLevel(e,t)}setFxLevels(e){this.fxChain&&this.fxChain.setLevels(e)}setFxBpm(e){this.fxChain&&this.fxChain.setBpm(e)}setFxBypass(e){this.fxChain&&this.fxChain.setBypass(e)}setFlavourEnabled(e){if(this.flavourEnabled=!!e,!this.flavourOutput||!this.flavourBypassGain)return;const t=this.ctx.currentTime,s=this.flavourEnabled?1:0,i=this.flavourEnabled?0:1;this.flavourOutput.gain.setTargetAtTime(s,t,.02),this.flavourBypassGain.gain.setTargetAtTime(i,t,.02)}resume(){this.ctx.state==="suspended"&&this.ctx.resume()}setPatch(e){return F[e]?(this.currentPatch=F[e],this.patchId=e,!0):!1}getPatchId(){return this.patchId}playNote(e,t=.8,s=0){const i=I(e);if(this.currentPatch&&this.currentPatch.createVoice){const h=this.currentPatch.createVoice(this.ctx,i,t);h.output.connect(this.voiceInput);const p={patchVoice:h,note:e,osc:null,gain:h.output};return this.activeOscillators.has(e)||this.activeOscillators.set(e,new Set),this.activeOscillators.get(e).add(p),p}const n=this.ctx.createOscillator(),o=this.ctx.createGain();n.type="sawtooth",n.frequency.value=i,this.driftGain.connect(n.detune);const r=Math.random()*10-5;n.detune.value=r;const c=this.ctx.currentTime+s;o.gain.setValueAtTime(0,c),o.gain.linearRampToValueAtTime(.4,c+.1),o.gain.exponentialRampToValueAtTime(.2,c+.4),n.connect(o),o.connect(this.voiceInput),n.start(c);const u={osc:n,gain:o,note:e};return this.activeOscillators.has(e)||this.activeOscillators.set(e,new Set),this.activeOscillators.get(e).add(u),u}stopNote(e,t=0){if(!e)return;if(e.patchVoice&&e.patchVoice.release){e.patchVoice.release(t);const n=this.activeOscillators.get(e.note);n&&(n.delete(e),n.size===0&&this.activeOscillators.delete(e.note));return}if(!e.osc)return;const s=this.ctx.currentTime+t;e.gain.gain.cancelScheduledValues(s),e.gain.gain.setValueAtTime(e.gain.gain.value,s),e.gain.gain.exponentialRampToValueAtTime(.001,s+.2),e.osc.stop(s+.2),setTimeout(()=>{e.osc.disconnect(),e.gain.disconnect()},250);const i=this.activeOscillators.get(e.note);i&&(i.delete(e),i.size===0&&this.activeOscillators.delete(e.note))}playBass(e,t=0){this.bassVoice&&this.stopBass(t);const s=I(e),i=this.ctx.createOscillator(),n=this.ctx.createGain(),o=this.ctx.createBiquadFilter();i.type="square",i.frequency.value=s,o.type="lowpass",o.frequency.value=320,o.Q.value=1.2;const r=this.ctx.currentTime+t;n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(.55,r+.03),n.gain.exponentialRampToValueAtTime(.38,r+.22),n.gain.setValueAtTime(.38,r+.22),o.frequency.setValueAtTime(340,r),o.frequency.exponentialRampToValueAtTime(190,r+.24),i.connect(o),o.connect(n),n.connect(this.bassGain),i.start(r),this.bassVoice={osc:i,gain:n,filter:o,note:e}}stopBass(e=0){if(!this.bassVoice)return;const t=this.bassVoice,s=this.ctx.currentTime+e;t.gain.gain.cancelScheduledValues(s),t.gain.gain.setValueAtTime(t.gain.gain.value,s),t.gain.gain.exponentialRampToValueAtTime(.001,s+.1),t.osc.stop(s+.1),setTimeout(()=>{t.osc.disconnect(),t.gain.disconnect(),t.filter.disconnect()},150),this.bassVoice=null}setBassVolume(e){const t=e/100;this.bassGain.gain.setTargetAtTime(t,this.ctx.currentTime,.1)}playChord(e){this.resume();for(const[t,s]of this.liveVoices)e.includes(t)||(this.stopNote(s),this.liveVoices.delete(t));e.forEach(t=>{if(!this.liveVoices.has(t)){const s=this.playNote(t);this.liveVoices.set(t,s)}})}stopAll(){this.stopBass(),this.stopArpNote();for(const e of this.activeOscillators.values())for(const t of e)this.stopNote(t);this.liveVoices.clear(),this.activeOscillators.clear()}playArpNote(e,t=80){const s=this.ctx.currentTime;this.arpVoice&&(this.arpVoice.patchVoice&&this.arpVoice.patchVoice.release?this.arpVoice.patchVoice.release(0):this.arpVoice.gain&&(this.arpVoice.gain.gain.cancelScheduledValues(s),this.arpVoice.gain.gain.setValueAtTime(this.arpVoice.gain.gain.value,s),this.arpVoice.gain.gain.linearRampToValueAtTime(0,s+.01),this.arpVoice.osc&&this.arpVoice.osc.stop(s+.02)),this.arpVoice=null);const i=I(e),n=t/127;if(this.currentPatch&&this.currentPatch.createVoice){const c=this.currentPatch.createVoice(this.ctx,i,n);return c.output.connect(this.voiceInput),this.arpVoice={patchVoice:c,note:e},this.arpVoice}const o=this.ctx.createOscillator(),r=this.ctx.createGain();return o.type="sawtooth",o.frequency.value=i,this.driftGain.connect(o.detune),o.detune.value=Math.random()*10-5,r.gain.setValueAtTime(0,s),r.gain.linearRampToValueAtTime(.3*n,s+.015),o.connect(r),r.connect(this.voiceInput),o.start(s),this.arpVoice={osc:o,gain:r,note:e},this.arpVoice}stopArpNote(){if(!this.arpVoice)return;const e=this.ctx.currentTime,t=this.arpVoice;if(t.patchVoice&&t.patchVoice.release){t.patchVoice.release(0),this.arpVoice=null;return}t.gain&&(t.gain.gain.cancelScheduledValues(e),t.gain.gain.setValueAtTime(t.gain.gain.value,e),t.gain.gain.exponentialRampToValueAtTime(.001,e+.08)),t.osc&&(t.osc.stop(e+.1),setTimeout(()=>{try{t.osc.disconnect(),t.gain&&t.gain.disconnect()}catch{}},150)),this.arpVoice=null}setFilterCutoff(e){if(this.masterFilter){const t=Math.max(20,Math.min(2e4,e));this.masterFilter.frequency.setTargetAtTime(t,this.ctx.currentTime,.1)}}setVolume(e){const t=Math.pow(e/99,2);this.masterGain.gain.setTargetAtTime(t,this.ctx.currentTime,.02)}isRecordingSupported(){return typeof MediaRecorder<"u"&&!!this.recordDestination}startRecording(){if(!this.isRecordingSupported()||this.isRecording)return!1;try{this.resume(),this.recordedChunks=[];const e={},t="audio/webm;codecs=opus";return MediaRecorder.isTypeSupported(t)?e.mimeType=t:MediaRecorder.isTypeSupported("audio/webm")&&(e.mimeType="audio/webm"),this.mediaRecorder=new MediaRecorder(this.recordDestination.stream,e),this.mediaRecorder.ondataavailable=s=>{s.data&&s.data.size>0&&this.recordedChunks.push(s.data)},this.mediaRecorder.start(),this.isRecording=!0,!0}catch(e){return console.error("Failed to start recording",e),this.mediaRecorder=null,this.isRecording=!1,!1}}async stopRecording(){return!this.mediaRecorder||!this.isRecording?null:new Promise(e=>{const t=this.mediaRecorder;t.onstop=()=>{const s=t.mimeType||"audio/webm",i=new Blob(this.recordedChunks,{type:s});this.mediaRecorder=null,this.isRecording=!1,this.recordedChunks=[],e(i)},t.stop()})}createSaturationCurve(e=1){const t=Math.max(.01,e)*12,s=1024,i=new Float32Array(s);for(let n=0;n<s;n++){const o=n*2/s-1;i[n]=(1+t)*o/(1+t*Math.abs(o))}return i}playClick(e,t){const s=this.ctx.createOscillator(),i=this.ctx.createGain();s.connect(i),i.connect(this.masterGain),s.frequency.value=t?1200:800,s.type="square",i.gain.setValueAtTime(.3,e),i.gain.exponentialRampToValueAtTime(.001,e+.05),s.start(e),s.stop(e+.05)}}class ve{constructor(){this.baseOctave=4,this.noteMap={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11},this.intervals={major:[0,4,7],minor:[0,3,7],suspended:[0,5,7],diminished:[0,3,6]},this.extensionIntervals={6:9,7:10,maj7:11,9:14},this.reverseNoteMap=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],this.scaleIntervals={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],dorian:[0,2,3,5,7,9,10],phrygian:[0,1,3,5,7,8,10],lydian:[0,2,4,6,7,9,11],mixolydian:[0,2,4,5,7,9,10],locrian:[0,1,3,5,6,8,10]}}getMidiRoot(e){const t=this.noteMap[e];if(t===void 0)throw new Error(`Invalid note name: ${e}`);return 60+t}getNoteName(e){return this.reverseNoteMap[e%12]}getNotes(e,t="major",s=[]){const i=this.getMidiRoot(e);let o=(this.intervals[t]||this.intervals.major).map(r=>i+r);return s.forEach(r=>{this.extensionIntervals[r]&&o.push(i+this.extensionIntervals[r])}),o.sort((r,c)=>r-c)}getScaleNotes(e,t="major"){const s=this.noteMap[e]||0;return(this.scaleIntervals[t]||this.scaleIntervals.major).map(n=>(s+n)%12)}quantizeToScale(e,t,s="major"){const i=this.getScaleNotes(t,s),n=e%12,o=Math.floor(e/12);if(i.includes(n))return e;let r=12,c=n;for(const h of i){const p=Math.abs(n-h),g=12-p,d=Math.min(p,g);d<r&&(r=d,c=h)}let u=o*12+c;return c>n&&c-n>6?u-=12:n>c&&n-c>6&&(u+=12),u}quantizeRoot(e,t,s="major"){const i=this.getMidiRoot(e),n=this.quantizeToScale(i,t,s);return this.getNoteName(n)}getDiatonicChordType(e,t,s="major"){const i=this.scaleIntervals[s]||this.scaleIntervals.major,n=this.noteMap[e],o=this.noteMap[t]||0;if(n===void 0)return"major";const r=(n-o+12)%12,c=i.indexOf(r);if(c===-1)return"major";const u=["major","minor","minor","major","major","minor","diminished"],p=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"].indexOf(s),g=p===-1?0:p;return[...u.slice(g),...u.slice(0,g)][c]||"major"}}class be{getVoicing(e,t){if(!e||e.length===0)return[];const s=Math.max(24,Math.min(96,t||60)),i=[...e].sort((u,h)=>u-h),n=7;let o=0;for(;o<24;){const u=i[0],h=i[i.length-1];if(u<s-n)i[0]=u+12,i.sort((p,g)=>p-g);else if(h>s+n)i[i.length-1]=h-12,i.sort((p,g)=>p-g);else break;o++}const r=i.reduce((u,h)=>u+h,0)/i.length,c=Math.round((s-r)/12);return i.map(u=>u+c*12).sort((u,h)=>u-h)}}class Te{constructor(e){this.callbacks=e||{},this.access=null,this.inputs=new Map}async init(){if(!navigator.requestMIDIAccess)return console.warn("Web MIDI API not supported in this browser."),!1;try{this.access=await navigator.requestMIDIAccess(),this.access.onstatechange=e=>this.handleStateChange(e);for(const e of this.access.inputs.values())this.bindInput(e);return!0}catch(e){return console.error("Web MIDI Access failed:",e),!1}}bindInput(e){this.inputs.has(e.id)||(console.log(`MIDI Input Connected: ${e.name}`),e.onmidimessage=t=>this.handleMessage(t),this.inputs.set(e.id,e),this.callbacks.onConnection&&this.callbacks.onConnection(e.name,!0))}handleStateChange(e){const t=e.port;t.type==="input"&&(t.state==="connected"?this.bindInput(t):(this.inputs.delete(t.id),this.callbacks.onConnection&&this.callbacks.onConnection(t.name,!1)))}handleMessage(e){const[t,s,i]=e.data;switch(t&240){case 144:i>0?this.callbacks.onNoteOn&&this.callbacks.onNoteOn(s,i):this.callbacks.onNoteOff&&this.callbacks.onNoteOff(s);break;case 128:this.callbacks.onNoteOff&&this.callbacks.onNoteOff(s);break;case 176:this.callbacks.onControlChange&&this.callbacks.onControlChange(s,i);break;case 224:this.callbacks.onPitchBend&&this.callbacks.onPitchBend(s,i);break}}destroy(){for(const e of this.inputs.values())e.onmidimessage=null;this.inputs.clear(),this.access&&(this.access.onstatechange=null)}}class Me{constructor(e,t){this.context=e,this.callbacks=t,this.state="idle",this.layers=[],this.currentLayerIndex=-1,this.activeNotes=new Set,this.startTime=0,this.loopDuration=0,this.loopStartContextTime=0,this.playbackInterval=null,this.lastTickTime=0,this.bpm=120,this.bars=0}setBpm(e){this.bpm=e}record(e=0,t=null){if(this.state==="idle")if(this.state="recording",this.startTime=t||this.context.currentTime,this.layers=[{events:[]}],this.currentLayerIndex=0,this.bars=e,e>0){const s=60/this.bpm,i=e*4*s;if(this.loopDuration=i,this.callbacks.onMetronome)for(let c=0;c<e*4;c++){const u=this.startTime+c*s,h=c%4===0;this.callbacks.onMetronome(u,h)}const n=()=>{if(this.state!=="recording")return;const c=this.context.currentTime;if(c<this.startTime){requestAnimationFrame(n);return}const u=c-this.startTime,h=Math.min(1,u/this.loopDuration),p=this.bars,g=Math.min(p,Math.floor(h*p)+1);this.callbacks.onProgress&&this.callbacks.onProgress(h,g,p),h<1&&requestAnimationFrame(n)};requestAnimationFrame(n);const o=this.context.currentTime,r=(this.startTime+this.loopDuration-o)*1e3;setTimeout(()=>{this.state==="recording"&&this.play()},Math.max(0,r))}else this.loopDuration=0,this.bars=0}play(e=null){if(this.state==="recording"){if(this.loopDuration===0){const t=this.context.currentTime-this.startTime,s=60/this.bpm,i=Math.round(t/s),n=Math.max(1,i);this.loopDuration=n*s}this.state="playing",this.startPlayback(e)}else this.state==="overdubbing"?this.state="playing":this.state==="idle"&&this.layers.length>0?(this.state="playing",this.startPlayback(e)):this.state==="playing"&&this.stop()}overdub(){this.state==="playing"&&(this.state="overdubbing",this.layers.push({events:[]}),this.currentLayerIndex=this.layers.length-1)}stop(){this.state="idle",this.playbackInterval&&(cancelAnimationFrame(this.playbackInterval),this.playbackInterval=null),this.activeNotes.forEach(e=>{this.callbacks.onStop&&this.callbacks.onStop(e)}),this.activeNotes.clear(),this.lastTickTime=0}undo(){this.layers.length>1?(this.layers.pop(),this.currentLayerIndex=this.layers.length-1):this.layers.length===1&&(this.layers=[],this.stop())}addEvent(e){if(this.state!=="recording"&&this.state!=="overdubbing")return;const t=(this.context.currentTime-this.startTime)%(this.loopDuration||1/0);this.layers[this.currentLayerIndex].events.push({...e,time:t})}startPlayback(e=null){const t=this.context.currentTime,s=e||t;if(s>t){setTimeout(()=>{this.state==="playing"&&this.startPlayback(s)},(s-t)*1e3);return}this.loopStartContextTime=s,this.lastTickTime=-Number.EPSILON;const i=()=>{if(this.state!=="playing"&&this.state!=="overdubbing")return;const r=(this.context.currentTime-this.loopStartContextTime)%this.loopDuration;if(r<this.lastTickTime&&(this.tick(this.loopDuration),this.lastTickTime=-.01),this.callbacks.onProgress){const c=this.bars||Math.max(1,Math.round(this.loopDuration/(60/this.bpm*4))),u=Math.floor(r/this.loopDuration*c)+1;this.callbacks.onProgress(r/this.loopDuration,u,c)}this.tick(r),this.lastTickTime=r,this.playbackInterval=requestAnimationFrame(i)};this.playbackInterval=requestAnimationFrame(i)}tick(e){this.layers.forEach(t=>{t.events.forEach(s=>{s.time>this.lastTickTime&&s.time<=e&&this.triggerEvent(s)})})}triggerEvent(e){e.type==="noteOn"?(this.callbacks.onPlay(e.note,e.velocity),this.activeNotes.add(e.note)):e.type==="noteOff"&&(this.callbacks.onStop(e.note),this.activeNotes.delete(e.note))}}class xe{constructor(e){this.context=e,this.bpm=120,this.isPlaying=!1,this.currentBeat=0,this.nextNoteTime=0,this.timerID=null,this.lookahead=25,this.scheduleAheadTime=.1,this.patternName="rock",this.patterns={rock:{length:16,kick:[1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0]},house:{length:16,kick:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0]},hiphop:{length:16,kick:[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1]},techno:{length:16,kick:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],snare:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],hat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0]}},this.output=this.context.createGain(),this.output.gain.value=.6}setBpm(e){this.bpm=e}setPattern(e){this.patterns[e]&&(this.patternName=e)}start(){this.isPlaying||(this.isPlaying=!0,this.currentBeat=0,this.nextNoteTime=this.context.currentTime+.05,this.scheduler())}stop(){this.isPlaying=!1,this.timerID&&(clearTimeout(this.timerID),this.timerID=null)}scheduler(){for(;this.nextNoteTime<this.context.currentTime+this.scheduleAheadTime;)this.scheduleNote(this.currentBeat,this.nextNoteTime),this.nextNote();this.isPlaying&&(this.timerID=setTimeout(()=>this.scheduler(),this.lookahead))}nextNote(){const e=60/this.bpm;this.nextNoteTime+=.25*e,this.currentBeat=(this.currentBeat+1)%16}scheduleNote(e,t){const s=this.patterns[this.patternName];s&&(s.kick[e]&&this.playKick(t),s.snare[e]&&this.playSnare(t),s.hat[e]&&this.playHiHat(t))}playKick(e){const t=this.context.createOscillator(),s=this.context.createGain();t.connect(s),s.connect(this.output),t.frequency.setValueAtTime(150,e),t.frequency.exponentialRampToValueAtTime(.01,e+.5),s.gain.setValueAtTime(1,e),s.gain.exponentialRampToValueAtTime(.01,e+.5),t.start(e),t.stop(e+.5)}playSnare(e){const t=this.createNoiseBuffer(),s=this.context.createBufferSource();s.buffer=t;const i=this.context.createBiquadFilter();i.type="highpass",i.frequency.value=1e3;const n=this.context.createGain();s.connect(i),i.connect(n),n.connect(this.output),n.gain.setValueAtTime(1,e),n.gain.exponentialRampToValueAtTime(.01,e+.2),s.start(e),s.stop(e+.2);const o=this.context.createOscillator(),r=this.context.createGain();o.type="triangle",o.connect(r),r.connect(this.output),o.frequency.setValueAtTime(250,e),r.gain.setValueAtTime(.5,e),r.gain.exponentialRampToValueAtTime(.01,e+.1),o.start(e),o.stop(e+.1)}playHiHat(e){const t=[2,3,4.16,5.43,6.79,8.21],s=this.context.createBiquadFilter();s.type="bandpass",s.frequency.value=1e4;const i=this.context.createBiquadFilter();i.type="highpass",i.frequency.value=7e3;const n=this.context.createGain();t.forEach(o=>{const r=this.context.createOscillator();r.type="square",r.frequency.value=40*o,r.connect(s),r.start(e),r.stop(e+.05)}),s.connect(i),i.connect(n),n.connect(this.output),n.gain.setValueAtTime(.3,e),n.gain.exponentialRampToValueAtTime(.01,e+.05)}createNoiseBuffer(){const e=this.context.sampleRate*2,t=this.context.createBuffer(1,e,this.context.sampleRate),s=t.getChannelData(0);for(let i=0;i<e;i++)s[i]=Math.random()*2-1;return t}getNextNoteTime(){return this.isPlaying?this.nextNoteTime:this.context.currentTime}getNextBarTime(){if(!this.isPlaying)return this.context.currentTime;const e=(16-this.currentBeat)%16,t=60/this.bpm*.25;return this.nextNoteTime+e*t}}class Ee{constructor(e,t={}){this.ctx=e,this.onNoteOn=t.onNoteOn||(()=>{}),this.onNoteOff=t.onNoteOff||(()=>{}),this.bpm=120,this.division="1/8",this.swingAmount=0,this.pattern="up",this.octaveRange=1,this.isRunning=!1,this.currentNotes=[],this.currentIndex=0,this.direction=1,this.lastPlayedNote=null,this.nextNoteTime=0,this.schedulerInterval=null,this.lookahead=25,this.scheduleAheadTime=.1,this.divisions={"1/1":4,"1/2":2,"1/4":1,"1/8":.5,"1/16":.25,"1/32":.125,"1/4T":1/1.5,"1/8T":.5/1.5,"1/16T":.25/1.5,"1/4D":1.5,"1/8D":.75,"1/16D":.375},this.divisionOrder=["1/1","1/2","1/4","1/8","1/16","1/32","1/4T","1/8T","1/16T","1/4D","1/8D","1/16D"]}setBpm(e){this.bpm=Math.max(20,Math.min(300,e))}setDivision(e){this.divisions[e]!==void 0&&(this.division=e)}setOctaveRange(e){this.octaveRange=Math.max(1,Math.min(3,e))}cycleDivision(e=1){const s=(this.divisionOrder.indexOf(this.division)+e+this.divisionOrder.length)%this.divisionOrder.length;return this.division=this.divisionOrder[s],this.division}setPattern(e){["up","down","updown","downup","random","order"].includes(e)&&(this.pattern=e,this.currentIndex=0,this.direction=e==="down"||e==="downup"?-1:1)}cyclePattern(){const e=["up","down","updown","random"],s=(e.indexOf(this.pattern)+1)%e.length;return this.setPattern(e[s]),this.pattern}setNotes(e=[]){if(this.currentNotes=[...e].sort((t,s)=>t-s),this.octaveRange>1){const t=[...this.currentNotes];for(let s=1;s<this.octaveRange;s++)this.currentNotes.forEach(i=>{t.push(i+s*12)});this.currentNotes=t}this.currentIndex>=this.currentNotes.length&&(this.currentIndex=0)}getNextNote(){if(this.currentNotes.length===0)return null;let e;switch(this.pattern){case"up":e=this.currentNotes[this.currentIndex],this.currentIndex=(this.currentIndex+1)%this.currentNotes.length;break;case"down":const t=this.currentNotes.length-1-this.currentIndex;e=this.currentNotes[t],this.currentIndex=(this.currentIndex+1)%this.currentNotes.length;break;case"updown":case"downup":e=this.currentNotes[this.currentIndex],this.currentIndex+=this.direction,this.currentIndex>=this.currentNotes.length-1?(this.currentIndex=this.currentNotes.length-1,this.direction=-1):this.currentIndex<=0&&(this.currentIndex=0,this.direction=1);break;case"random":const s=Math.floor(Math.random()*this.currentNotes.length);e=this.currentNotes[s];break;case"order":e=this.currentNotes[this.currentIndex],this.currentIndex=(this.currentIndex+1)%this.currentNotes.length;break;default:e=this.currentNotes[0]}return e}getStepDuration(){const e=this.divisions[this.division]||.5,t=60/this.bpm;return e*t}scheduleNote(e){this.lastPlayedNote!==null&&this.onNoteOff(this.lastPlayedNote);const t=this.getNextNote();if(t!==null){const i=this.getStepDuration()*.9;this.onNoteOn(t,100,e),this.lastPlayedNote=t,setTimeout(()=>{this.lastPlayedNote===t&&(this.onNoteOff(t),this.lastPlayedNote=null)},i*1e3)}}scheduler(){for(;this.nextNoteTime<this.ctx.currentTime+this.scheduleAheadTime;)this.scheduleNote(this.nextNoteTime),this.nextNoteTime+=this.getStepDuration()}start(e=[],t=null){e.length>0&&this.setNotes(e),this.currentNotes.length!==0&&(this.isRunning=!0,this.currentIndex=0,this.direction=this.pattern==="down"||this.pattern==="downup"?-1:1,this.nextNoteTime=t||this.ctx.currentTime,this.schedulerInterval||(this.schedulerInterval=setInterval(()=>this.scheduler(),this.lookahead)))}stop(){this.isRunning=!1,this.schedulerInterval&&(clearInterval(this.schedulerInterval),this.schedulerInterval=null),this.lastPlayedNote!==null&&(this.onNoteOff(this.lastPlayedNote),this.lastPlayedNote=null)}updateNotes(e){this.setNotes(e)}tapTempo(){const e=performance.now();if(this._tapTimes||(this._tapTimes=[]),this._tapTimes.length>0&&e-this._tapTimes[this._tapTimes.length-1]>2e3&&(this._tapTimes=[]),this._tapTimes.push(e),this._tapTimes.length>4&&this._tapTimes.shift(),this._tapTimes.length>=2){let t=0;for(let n=1;n<this._tapTimes.length;n++)t+=this._tapTimes[n]-this._tapTimes[n-1];const s=t/(this._tapTimes.length-1),i=Math.round(6e4/s);return this.setBpm(i),this.bpm}return this.bpm}}class ke{constructor(e,t={}){this.ctx=e,this.onNoteOn=t.onNoteOn||(()=>{}),this.onNoteOff=t.onNoteOff||(()=>{}),this.bpm=120,this.patterns={straight:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],offbeat:[0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],pulse:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],tresillo:[1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0],clave:[1,0,0,1,0,0,1,0,0,0,1,0,1,0,0,0],shuffle:[1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,0],waltz:[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0],funk:[1,0,0,1,0,1,0,0,1,0,0,1,0,1,0,0]},this.patternOrder=["straight","offbeat","pulse","tresillo","clave","shuffle","waltz","funk"],this.currentPatternName="straight",this.isRunning=!1,this.currentNotes=[],this.stepIndex=0,this.noteIndex=0,this.lastPlayedNote=null,this.nextStepTime=0,this.schedulerInterval=null,this.lookahead=25,this.scheduleAheadTime=.1}setBpm(e){this.bpm=Math.max(20,Math.min(300,e))}get pattern(){return this.patterns[this.currentPatternName]}setPattern(e){this.patterns[e]&&(this.currentPatternName=e,this.stepIndex=0,this.noteIndex=0)}cyclePattern(e=1){const s=(this.patternOrder.indexOf(this.currentPatternName)+e+this.patternOrder.length)%this.patternOrder.length;return this.setPattern(this.patternOrder[s]),this.currentPatternName}getPatternDisplayName(){return{straight:"STRAIGHT",offbeat:"OFFBEAT",pulse:"PULSE",tresillo:"TRESILLO",clave:"CLAVE",shuffle:"SHUFFLE",waltz:"WALTZ",funk:"FUNK"}[this.currentPatternName]||this.currentPatternName.toUpperCase()}setNotes(e){this.currentNotes=[...e].sort((t,s)=>t-s)}getStepDuration(){return 60/this.bpm/4}getNextChordNote(){if(this.currentNotes.length===0)return null;const e=this.currentNotes[this.noteIndex%this.currentNotes.length];return this.noteIndex=(this.noteIndex+1)%this.currentNotes.length,e}scheduleStep(e){const t=this.pattern,s=t[this.stepIndex]===1;if(this.lastPlayedNote!==null&&(this.onNoteOff(this.lastPlayedNote),this.lastPlayedNote=null),s&&this.currentNotes.length>0){const i=this.getNextChordNote();if(i!==null){const n=90+Math.floor(Math.random()*20);this.onNoteOn(i,n,e),this.lastPlayedNote=i;const o=this.getStepDuration();setTimeout(()=>{this.lastPlayedNote===i&&(this.onNoteOff(i),this.lastPlayedNote=null)},o*.8*1e3)}}this.stepIndex=(this.stepIndex+1)%t.length}scheduler(){for(;this.nextStepTime<this.ctx.currentTime+this.scheduleAheadTime;)this.scheduleStep(this.nextStepTime),this.nextStepTime+=this.getStepDuration()}start(e=[],t=null){e.length>0&&this.setNotes(e),this.currentNotes.length!==0&&(this.isRunning=!0,this.stepIndex=0,this.noteIndex=0,this.nextStepTime=t||this.ctx.currentTime,this.schedulerInterval||(this.schedulerInterval=setInterval(()=>this.scheduler(),this.lookahead)))}stop(){this.isRunning=!1,this.schedulerInterval&&(clearInterval(this.schedulerInterval),this.schedulerInterval=null),this.lastPlayedNote!==null&&(this.onNoteOff(this.lastPlayedNote),this.lastPlayedNote=null)}updateNotes(e){this.setNotes(e)}}class Ve{constructor(e={}){this.onNoteOn=e.onNoteOn||(()=>{}),this.onNoteOff=e.onNoteOff||(()=>{}),this.strumTime=50,this.direction="down",this.mode="strum",this.activeNotes=new Set,this.pendingTimers=[]}setSpeed(e){this.strumTime=(99-e)/99*200}setDirection(e){(e==="down"||e==="up")&&(this.direction=e)}setMode(e){["strum","strum2","slop","harp"].includes(e)&&(this.mode=e)}toggleDirection(){return this.direction=this.direction==="down"?"up":"down",this.direction}strum(e,t=100){this.clearPending(),this.release();let s=[...e].sort((n,o)=>n-o);if(this.mode==="strum2"){const n=[...s];s.forEach(o=>n.push(o+12)),s=n}else if(this.mode==="harp"){const n=[...s];s.forEach(o=>n.push(o+12)),s.forEach(o=>n.push(o+24)),s=n}this.direction==="up"&&this.mode!=="harp"&&s.reverse();let i=this.strumTime;this.mode==="harp"&&(i=Math.min(this.strumTime,40)),s.forEach((n,o)=>{let r=o*i;if(this.mode==="slop"){const u=Math.random()*30-15;r=Math.max(0,r+u)}const c=setTimeout(()=>{const u=Math.max(60,t-o*2);this.onNoteOn(n,u),this.activeNotes.add(n)},r);this.pendingTimers.push(c)})}release(){this.clearPending(),this.activeNotes.forEach(e=>{this.onNoteOff(e)}),this.activeNotes.clear()}clearPending(){this.pendingTimers.forEach(e=>clearTimeout(e)),this.pendingTimers=[]}}const B=class B{constructor(e={}){this.state={powered:!0,root:"C",type:"major",extensions:new Set,voicingCenter:60,filterCutoff:2500,midiConnected:!1,activeMidiNotes:new Set,looperState:"idle",loopLength:"free",loopProgress:0,loopBarsRecorded:0,loopMenu:"play",isPlaying:!1,bassEnabled:!1,bassMode:"chords",bassVoicing:0,bassVolume:60,volume:70,flavourEnabled:!0,currentPatch:D,keyEnabled:!1,keyRoot:"C",keyScale:"major",keyAutoChords:!0,performMode:"direct",arpPattern:"up",arpDivision:"1/8",arpOctave:1,strumSpeed:50,rhythmPattern:"straight",playstyle:"advanced",bpm:120,metronomeOn:!1,beatEnabled:!1,beatPattern:"rock",currentEffect:"direct",fxLocked:!1,fxLevels:{reverb:0,delay:0,chorus:0,phaser:0,flanger:0,drive:0,tremolo:0,ensemble:0},recording:!1,...e},this.listeners=new Set}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(e=[]){this.listeners.forEach(t=>t(this.state,e))}get(e){return this.state[e]}setPower(e){this.state.powered!==e&&(this.state.powered=e,this.notify(["powered"]))}setRoot(e){this.state.root!==e&&(this.state.root=e,this.notify(["root"]))}setChordType(e){this.state.type!==e&&(this.state.type=e,this.notify(["type"]))}toggleExtension(e){const t=new Set(this.state.extensions);t.has(e)?t.delete(e):t.add(e),this.state.extensions=t,this.notify(["extensions"])}setExtension(e,t){const s=this.state.extensions.has(e);if(t&&!s){const i=new Set(this.state.extensions);i.add(e),this.state.extensions=i,this.notify(["extensions"])}else if(!t&&s){const i=new Set(this.state.extensions);i.delete(e),this.state.extensions=i,this.notify(["extensions"])}}setVoicingCenter(e){this.state.voicingCenter!==e&&(this.state.voicingCenter=e,this.notify(["voicingCenter"]))}setFilterCutoff(e){this.state.filterCutoff!==e&&(this.state.filterCutoff=e,this.notify(["filterCutoff"]))}setBassVoicing(e){const t=Math.max(-24,Math.min(24,e));this.state.bassVoicing!==t&&(this.state.bassVoicing=t,this.notify(["bassVoicing"]))}setBassVolume(e){const t=Math.max(0,Math.min(99,e));this.state.bassVolume!==t&&(this.state.bassVolume=t,this.notify(["bassVolume"]))}setVolume(e){const t=Math.max(0,Math.min(99,e));this.state.volume!==t&&(this.state.volume=t,this.notify(["volume"]))}setBassMode(e){["direct","chords","unison","single","solo"].includes(e)&&this.state.bassMode!==e&&(this.state.bassMode=e,this.notify(["bassMode"]))}setBassEnabled(e){this.state.bassEnabled!==e&&(this.state.bassEnabled=e,this.notify(["bassEnabled"]))}toggleBass(){const e=this.state.bassEnabled;this.setBassEnabled(!e),!e&&this.state.bassEnabled&&this.setBassVolume(10)}setLooperState(e){this.state.looperState!==e&&(this.state.looperState=e,this.notify(["looperState"]))}setLoopProgress(e){this.state.loopProgress=e,this.notify(["loopProgress"])}setLoopBarsRecorded(e){this.state.loopBarsRecorded!==e&&(this.state.loopBarsRecorded=e,this.notify(["loopBarsRecorded"]))}setMidiConnected(e){this.state.midiConnected!==e&&(this.state.midiConnected=e,this.notify(["midiConnected"]))}setIsPlaying(e){this.state.isPlaying!==e&&(this.state.isPlaying=e,this.notify(["isPlaying"]))}cycleBassMode(){const e=["direct","chords","unison","single","solo"],s=(e.indexOf(this.state.bassMode)+1)%e.length;this.setBassMode(e[s])}setPatch(e){this.state.currentPatch!==e&&(this.state.currentPatch=e,this.notify(["currentPatch"]))}cyclePatch(e=1){const t=re(this.state.currentPatch,e);return this.setPatch(t),t}setKeyEnabled(e){this.state.keyEnabled!==e&&(this.state.keyEnabled=e,this.notify(["keyEnabled"]))}toggleKey(){this.setKeyEnabled(!this.state.keyEnabled)}setKeyAutoChords(e){this.state.keyAutoChords!==e&&(this.state.keyAutoChords=e,this.notify(["keyAutoChords"]))}toggleKeyAutoChords(){this.setKeyAutoChords(!this.state.keyAutoChords)}setKeyRoot(e){["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].includes(e)&&this.state.keyRoot!==e&&(this.state.keyRoot=e,this.notify(["keyRoot"]))}cycleKeyRoot(e=1){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],i=(t.indexOf(this.state.keyRoot)+e+t.length)%t.length;this.setKeyRoot(t[i])}setKeyScale(e){["major","minor","dorian","phrygian","lydian","mixolydian","locrian"].includes(e)&&this.state.keyScale!==e&&(this.state.keyScale=e,this.notify(["keyScale"]))}cycleKeyScale(){const e=["major","minor","dorian","phrygian","lydian","mixolydian","locrian"],s=(e.indexOf(this.state.keyScale)+1)%e.length;this.setKeyScale(e[s])}setPerformMode(e){["direct","arp","strum","strum2","slop","harp","pattern"].includes(e)&&this.state.performMode!==e&&(this.state.performMode=e,this.notify(["performMode"]))}cyclePerformMode(){const e=["direct","arp","strum","strum2","slop","harp","pattern"],s=(e.indexOf(this.state.performMode)+1)%e.length;return this.setPerformMode(e[s]),this.state.performMode}setArpPattern(e){["up","down","updown","random"].includes(e)&&this.state.arpPattern!==e&&(this.state.arpPattern=e,this.notify(["arpPattern"]))}cycleArpPattern(){const e=["up","down","updown","random"],s=(e.indexOf(this.state.arpPattern)+1)%e.length;return this.setArpPattern(e[s]),this.state.arpPattern}setArpDivision(e){["1/1","1/2","1/4","1/8","1/16","1/32","1/4T","1/8T","1/16T","1/4D","1/8D","1/16D"].includes(e)&&this.state.arpDivision!==e&&(this.state.arpDivision=e,this.notify(["arpDivision"]))}cycleArpDivision(){const e=["1/1","1/2","1/4","1/8","1/16","1/32","1/4T","1/8T","1/16T","1/4D","1/8D","1/16D"],s=(e.indexOf(this.state.arpDivision)+1)%e.length;return this.setArpDivision(e[s]),this.state.arpDivision}setArpOctave(e){const t=Math.max(1,Math.min(3,parseInt(e)));this.state.arpOctave!==t&&(this.state.arpOctave=t,this.notify(["arpOctave"]))}cycleArpOctave(){let e=this.state.arpOctave+1;return e>3&&(e=1),this.setArpOctave(e),this.state.arpOctave}setStrumSpeed(e){const t=Math.max(0,Math.min(99,e));this.state.strumSpeed!==t&&(this.state.strumSpeed=t,this.notify(["strumSpeed"]))}setRhythmPattern(e){["straight","offbeat","pulse","tresillo","clave","shuffle","waltz","funk"].includes(e)&&this.state.rhythmPattern!==e&&(this.state.rhythmPattern=e,this.notify(["rhythmPattern"]))}cycleRhythmPattern(e=1){const t=["straight","offbeat","pulse","tresillo","clave","shuffle","waltz","funk"],i=(t.indexOf(this.state.rhythmPattern)+e+t.length)%t.length;return this.setRhythmPattern(t[i]),this.state.rhythmPattern}setBpm(e){const t=Math.max(20,Math.min(300,e));this.state.bpm!==t&&(this.state.bpm=t,this.notify(["bpm"]))}adjustBpm(e){this.setBpm(this.state.bpm+e)}toggleMetronome(){this.state.metronomeOn=!this.state.metronomeOn,this.notify(["metronomeOn"])}setPlaystyle(e){["simple","advanced","free"].includes(e)&&this.state.playstyle!==e&&(this.state.playstyle=e,this.notify(["playstyle"]))}cyclePlaystyle(e=1){const t=["simple","advanced","free"],i=(t.indexOf(this.state.playstyle)+e+t.length)%t.length;return this.setPlaystyle(t[i]),this.state.playstyle}setCurrentEffect(e){B.FX_TYPES.includes(e)&&this.state.currentEffect!==e&&(this.state.currentEffect=e,this.notify(["currentEffect"]))}cycleCurrentEffect(e=1){const t=B.FX_TYPES,i=(t.indexOf(this.state.currentEffect)+e+t.length)%t.length;return this.setCurrentEffect(t[i]),this.state.currentEffect}setFxLevel(e,t){if(!B.FX_TYPES.includes(e))return;const s=Math.max(0,Math.min(99,t));this.state.fxLevels[e]!==s&&(this.state.fxLevels[e]=s,this.notify(["fxLevels",e]))}adjustFxLevel(e,t){const s=this.state.fxLevels[e]||0;this.setFxLevel(e,s+t)}getFxLevel(e){return this.state.fxLevels[e]||0}toggleFxLock(){return this.state.fxLocked=!this.state.fxLocked,this.notify(["fxLocked"]),this.state.fxLocked}setFxLocked(e){this.state.fxLocked!==e&&(this.state.fxLocked=e,this.notify(["fxLocked"]))}setFlavourEnabled(e){this.state.flavourEnabled!==e&&(this.state.flavourEnabled=e,this.notify(["flavourEnabled"]))}toggleFlavour(){this.setFlavourEnabled(!this.state.flavourEnabled)}setRecording(e){this.state.recording!==e&&(this.state.recording=e,this.notify(["recording"]))}toggleRecording(){this.setRecording(!this.state.recording)}setLoopLength(e){["free",1,2,4,8,16].includes(e)&&this.state.loopLength!==e&&(this.state.loopLength=e,this.notify(["loopLength"]))}cycleLoopLength(e=1){const t=["free",1,2,4,8,16],i=(t.indexOf(this.state.loopLength)+e+t.length)%t.length;return this.setLoopLength(t[i]),this.state.loopLength}setLoopMenu(e){["play","overdub","undo","clear","stop"].includes(e)&&this.state.loopMenu!==e&&(this.state.loopMenu=e,this.notify(["loopMenu"]))}cycleLoopMenu(e=1){const t=["play","overdub","undo","clear","stop"],i=(t.indexOf(this.state.loopMenu)+e+t.length)%t.length;return this.setLoopMenu(t[i]),this.state.loopMenu}setBeatEnabled(e){this.state.beatEnabled!==e&&(this.state.beatEnabled=e,this.notify(["beatEnabled"]))}setBeatPattern(e){this.state.beatPattern!==e&&(this.state.beatPattern=e,this.notify(["beatPattern"]))}cycleBeatPattern(e=1){const t=["rock","house","hiphop","techno"],i=(t.indexOf(this.state.beatPattern)+e+t.length)%t.length;return this.setBeatPattern(t[i]),this.state.beatPattern}};_(B,"FX_TYPES",["direct","reverb","delay","chorus","phaser","flanger","drive","tremolo","ensemble"]);let q=B;class Le{constructor(e,t){this.container=e,this.actions=t,this.encoderRotations={},this._bassVolumeFlashUntil=0,this._fxStateSnapshot=null,this._currentBpmValue=36,this._currentPerformValue=50,this.encoderEngaged=new Map([["fx",!1]]),this.state=null,this.attachEvents()}mount(e){this.state=e,this.container.innerHTML=`
      <!-- ROW 1: Configuration & Display -->
      <div class="config-row">
        <!-- Left Encoders -->
        <div class="encoder-group left-encoders">
          <div class="encoder yellow" data-encoder="sound">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Sound</span>
          </div>
          <div class="encoder yellow ${e.performMode!=="direct"?"active":""}" data-encoder="perform" title="Click to cycle mode, rotate for division/speed, hold for pattern">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Perform</span>
          </div>
          <div class="encoder yellow" data-encoder="fx">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">FX</span>
          </div>
          <div class="encoder charcoal ${e.keyEnabled?"active":""}" data-encoder="key" title="Click to toggle key lock, rotate to select key">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Key</span>
          </div>
        </div>

        <!-- OLED Display -->
        <div class="oled-display">
          <div class="oled-screen">
            <!-- Top Bar: Status & Volume -->
            <div class="oled-header">
              <div class="oled-status-icons">
                <span class="status-icon ${e.powered?"active":""}" title="Power">PWR</span>
                <span class="status-icon ${e.midiConnected?"active":""}" title="MIDI">MIDI</span>
                <span class="status-icon ${e.looperState!=="idle"?"active":""}" title="Looper">
                  ${e.looperState==="recording"?`REC ${e.loopBarsRecorded||""}`:e.looperState==="overdubbing"?`DUB ${e.loopBarsRecorded||""}`:e.looperState==="playing"?`PLAY ${e.loopBarsRecorded||""}`:"LOOP"}
                </span>
              </div>
              <span class="oled-volume" data-volume="${e.volume}">VOL ${e.volume}</span>
            </div>

            <!-- Main Content: Patch & Chord -->
            <div class="oled-main-section">
              <div class="oled-patch-name">${this.getPatchDisplayName(e.currentPatch)}</div>
              <div class="oled-chord-display">
                <span class="oled-chord-root">${e.root}</span>
                <span class="oled-chord-type">${e.type}</span>
              </div>
              <div class="oled-extensions">${e.extensions.size>0?Array.from(e.extensions).join(" "):""}</div>
            </div>

            <!-- Bottom Grid: Parameters -->
            <div class="oled-grid">
              <!-- Row 1: Key & Bass -->
              <div class="oled-grid-cell">
                <span class="oled-label">KEY</span>
                <span class="oled-value oled-key-value ${e.keyEnabled?"active":""}">${this.getKeyDisplay(e)}</span>
              </div>
              <div class="oled-grid-cell">
                <span class="oled-label">BASS</span>
                <span class="oled-value oled-bass-value ${e.bassEnabled?"active":""}">${e.bassEnabled?e.bassMode.toUpperCase():"OFF"}</span>
              </div>

              <!-- Row 2: Perform & BPM -->
              <div class="oled-grid-cell">
                <span class="oled-label">MODE</span>
                <span class="oled-value oled-mode-value ${e.performMode!=="direct"?"active":""}">${this.getPerformModeDisplay(e)}</span>
              </div>
              <div class="oled-grid-cell">
                <span class="oled-label">BPM</span>
                <span class="oled-value oled-bpm-value ${e.beatEnabled?"active":""}">${e.beatEnabled?e.beatPattern.toUpperCase():e.bpm}</span>
              </div>

              <!-- Row 3: FX & Style -->
              <div class="oled-grid-cell">
                <span class="oled-label">FX</span>
                <span class="oled-value oled-fx-value ${e.currentEffect!=="direct"?"active":""}">${this.getFxDisplay(e)} ${e.currentEffect!=="direct"?this.getFxLevel(e):""}</span>
              </div>
              <div class="oled-grid-cell">
                <span class="oled-label">STYLE</span>
                <span class="oled-value oled-style-value">${e.playstyle.toUpperCase()}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Encoders -->
        <div class="encoder-group right-encoders">
          <div class="encoder red ${e.bassEnabled?"active":""}" data-encoder="bass" title="Click to toggle bass, hold for mode">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Bass</span>
          </div>
          <div class="encoder charcoal" data-encoder="loop">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Loop</span>
          </div>
          <div class="encoder charcoal ${e.beatEnabled?"yellow active":""}" data-encoder="bpm" title="Click to toggle beats, rotate for BPM/Pattern">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">BPM</span>
          </div>
          <div class="encoder charcoal" data-encoder="options">
            <div class="encoder-knob">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Options</span>
          </div>
          <div class="encoder charcoal" data-encoder="volume">
            <div class="encoder-knob" style="transform: rotate(${e.volume/99*270-135}deg)">
              <div class="encoder-indicator"></div>
            </div>
            <span class="encoder-label">Volume</span>
          </div>
        </div>
      </div>

      <!-- ROW 2: Performance Controls -->
      <div class="performance-row">
        <!-- Left: Chord Type & Extensions -->
        <div class="performance-controls">
          <div class="button-grid">
            <div class="button-row">
              <button class="perf-btn" data-type="diminished" id="btn-dim">Dim</button>
              <button class="perf-btn" data-type="minor" id="btn-min">Min</button>
              <button class="perf-btn" data-type="major" id="btn-maj">Maj</button>
              <button class="perf-btn" data-type="suspended" id="btn-sus">Sus</button>
            </div>
            <div class="button-row">
              <button class="perf-btn" data-ext="6" id="btn-6">6</button>
              <button class="perf-btn" data-ext="7" id="btn-m7">m7</button>
              <button class="perf-btn" data-ext="maj7" id="btn-M7">M7</button>
              <button class="perf-btn" data-ext="9" id="btn-9">9</button>
            </div>
          </div>

          <!-- Voicing & Bass Dials -->
          <div class="dial-stack">
            <div class="stacked-dial voicing-dial">
              <div class="dial-knob" id="voicing-knob" data-value="60">
                <div class="dial-indicator"></div>
              </div>
              <span class="dial-label">Voicing</span>
            </div>
            <div class="stacked-dial bass-dial">
              <div class="dial-knob small" id="bass-knob" data-value="0">
                <div class="dial-indicator"></div>
              </div>
              <span class="dial-label">Bass</span>
            </div>
          </div>
        </div>

        <!-- Right: Keyboard -->
        <div class="keyboard" id="keyboard">
          <!-- Keys generated dynamically -->
        </div>
      </div>
    `,this.renderKeyboard(e.root)}getPatchDisplayName(e){const t=F[e];return t?t.name:e}getVoicingRotation(e){return(Math.max(36,Math.min(84,e||60))-36)/48*270-135}getBassVoicingRotation(e){return(Math.max(-24,Math.min(24,e||0))- -24)/48*270-135}getPerformModeDisplay(e){return e.performMode==="direct"?"DIRECT":e.performMode==="arp"?`ARP ${e.arpPattern.toUpperCase()} ${e.arpDivision}`:["strum","strum2","slop","harp"].includes(e.performMode)?`${e.performMode.toUpperCase()} ${e.strumSpeed}`:e.performMode==="pattern"?`PATTERN ${{straight:"STRAIGHT",offbeat:"OFFBEAT",pulse:"PULSE",tresillo:"TRESILLO",clave:"CLAVE",shuffle:"SHUFFLE",waltz:"WALTZ",funk:"FUNK"}[e.rhythmPattern]||e.rhythmPattern.toUpperCase()}`:e.performMode.toUpperCase()}getKeyDisplay(e){if(!e.keyEnabled)return"KEY: OFF";const t=e.keyAutoChords?e.keyScale.toUpperCase().slice(0,3):{diminished:"DIM",minor:"MIN",major:"MAJ",suspended:"SUS"}[e.type]||e.type.toUpperCase().slice(0,3),s=e.keyAutoChords?"AUTO":"MAN";return`KEY: ${e.keyRoot} ${t} ${s}`}getFxDisplay(e){const t=e.currentEffect||"reverb",s=t.toUpperCase();return t==="direct"?"FX DIRECT":`FX ${s}`}getFxLevel(e){const t=e.currentEffect||"reverb";if(t==="direct")return"";const s=(e.fxLevels&&e.fxLevels[t])??0,i=e.fxLocked?" LOCK":"";return`${s}${i}`}update(e){this.state=e;const t=this.container.querySelector(".oled-patch-name");t&&(t.textContent=this.getPatchDisplayName(e.currentPatch));const s=this.container.querySelector(".oled-chord-root");s&&(s.textContent=e.root);const i=this.container.querySelector(".oled-chord-type");i&&(i.textContent=e.type);const n=this.container.querySelector(".oled-extensions");n&&(n.textContent=e.extensions.size>0?Array.from(e.extensions).join(" "):"");const o=this.container.querySelector(".oled-volume");o&&(Date.now()<this._bassVolumeFlashUntil?o.textContent=`BASS ${e.bassVolume}`:o.textContent=`VOL ${e.volume}`,o.dataset.volume=e.volume);const r=this.container.querySelectorAll(".status-icon");if(r.length>=3){r[0].classList.toggle("active",e.powered),r[1].classList.toggle("active",e.midiConnected);const b=r[2];b.classList.toggle("active",e.looperState!=="idle");let S="LOOP";e.looperState==="idle"?S=e.loopLength==="free"?"FREE":`${e.loopLength}B`:e.looperState==="recording"?S="REC":e.looperState==="overdubbing"?S="DUB":e.looperState==="playing"&&(e.loopMenu!=="play"?S=e.loopMenu.toUpperCase():S="PLAY"),b.textContent=S}const c=this.container.querySelector(".oled-fx-value");if(c){const b=`${this.getFxDisplay(e)} ${e.currentEffect!=="direct"?this.getFxLevel(e):""}`;c.textContent=b,c.classList.toggle("active",e.currentEffect!=="direct")}const u=this.container.querySelector(".oled-bass-value");u&&(u.textContent=e.bassEnabled?e.bassMode.toUpperCase():"OFF",u.classList.toggle("active",e.bassEnabled));const h=this.container.querySelector(".oled-key-value");h&&(h.textContent=this.getKeyDisplay(e),h.classList.toggle("active",e.keyEnabled));const p=this.container.querySelector('.encoder[data-encoder="key"]');p&&p.classList.toggle("active",e.keyEnabled);const g=this.container.querySelector('.encoder[data-encoder="loop"]');if(g){const b=e.looperState!=="idle";g.classList.toggle("active",b),g.classList.remove("charcoal","red","yellow","green"),e.looperState==="recording"?g.classList.add("red"):e.looperState==="overdubbing"?g.classList.add("yellow"):e.looperState==="playing"?g.classList.add("green"):g.classList.add("charcoal")}const d=this.container.querySelector(".oled-style-value");d&&(d.textContent=e.playstyle.toUpperCase());const m=this.container.querySelector(".oled-mode-value");m&&(m.textContent=this.getPerformModeDisplay(e),m.classList.toggle("active",e.performMode!=="direct"));const y=this.container.querySelector(".oled-bpm-value");y&&(e.beatEnabled?(y.textContent=e.beatPattern.toUpperCase(),y.classList.add("active")):(y.textContent=`${e.bpm}`,y.classList.remove("active")));const T=this.container.querySelector('.encoder[data-encoder="bpm"]');T&&(T.classList.toggle("active",e.beatEnabled),e.beatEnabled?(T.classList.remove("charcoal"),T.classList.add("yellow")):(T.classList.remove("yellow"),T.classList.add("charcoal")));const x=this.container.querySelector('.encoder[data-encoder="perform"]');if(x){const b=e.performMode!=="direct";if(this.encoderEngaged.set("perform",b),x.classList.toggle("active",b),e.performMode==="arp"){const N=["1/1","1/2","1/4","1/8","1/16","1/32","1/4T","1/8T","1/16T"].indexOf(e.arpDivision);N!==-1&&(this._currentPerformValue=Math.round(N*11+5))}else if(["strum","strum2","slop","harp"].includes(e.performMode))this._currentPerformValue=e.strumSpeed;else if(e.performMode==="pattern"){const N=["straight","offbeat","pulse","tresillo","clave","shuffle","waltz","funk"].indexOf(e.rhythmPattern);N!==-1&&(this._currentPerformValue=Math.round(N*12.5+6))}const S=x.querySelector(".encoder-knob");if(S){const A=b?this._currentPerformValue/99*270-135:0;S.style.transform=`rotate(${A}deg)`}}const M=this.container.querySelector('.encoder[data-encoder="fx"]');if(M){const b=this.encoderEngaged.get("fx")===!0&&e.currentEffect!=="direct";this.encoderEngaged.set("fx",b),M.classList.toggle("active",b);const S=M.querySelector(".encoder-knob");if(S){this._currentFxValue=e.fxLevels[e.currentEffect]??0;const A=b?this._currentFxValue/99*270-135:0;S.style.transform=`rotate(${A}deg)`}}this._currentBpmValue=Math.round((e.bpm-20)/280*99),this._fxStateSnapshot={currentEffect:e.currentEffect,fxLevels:{...e.fxLevels},fxLocked:e.fxLocked},this._lastFxEffect=e.currentEffect;const V=this.container.querySelector('.encoder[data-encoder="bass"]');if(V){const b=e.bassEnabled&&e.bassMode!=="direct";this.encoderEngaged.set("bass",b),V.classList.toggle("active",b);const S=V.querySelector(".encoder-knob");if(S){const A=b?e.bassVolume/99*270-135:0;S.style.transform=`rotate(${A}deg)`}this._currentBassVolume=e.bassVolume}const k=this.container.querySelector('.encoder[data-encoder="volume"]');if(k){const b=k.querySelector(".encoder-knob");if(b){const A=this.encoderEngaged.get("volume")===!0?e.volume/99*270-135:0;b.style.transform=`rotate(${A}deg)`}this._currentVolume=e.volume}const l=document.getElementById("flavour-toggle");l&&(l.classList.toggle("active",e.flavourEnabled),l.textContent=e.flavourEnabled?"Flavour On":"Flavour Off",l.title=e.flavourEnabled?"Secret flavour chain enabled":"Secret flavour chain bypassed");const f=document.getElementById("record-btn");f&&(f.classList.toggle("active",e.recording),f.textContent=e.recording?"Recording...":"Record",f.title=e.recording?"Recording live output":"Record live output to file");const v=this.container.querySelector("#power-btn");v&&(e.powered?v.classList.add("active"):v.classList.remove("active"),v.textContent=e.powered?"PWR ON":"PWR OFF");const E=this.container.querySelector("#midi-status");E&&(e.midiConnected?E.classList.add("connected"):E.classList.remove("connected")),this.container.querySelectorAll("#type-controls button").forEach(b=>{b.dataset.type===e.type?b.classList.add("active"):b.classList.remove("active")}),this.container.querySelectorAll("#ext-controls button").forEach(b=>{e.extensions.has(b.dataset.ext)?b.classList.add("active"):b.classList.remove("active")}),this.container.querySelectorAll(".perf-btn[data-type]").forEach(b=>{b.classList.toggle("active",b.dataset.type===e.type)}),this.container.querySelectorAll(".perf-btn[data-ext]").forEach(b=>{b.classList.toggle("active",e.extensions.has(b.dataset.ext))});const L=this.container.querySelector("#bass-mode-btn");L&&(L.textContent=`BASS: ${e.bassMode.toUpperCase()}`);const w=this.container.querySelector("#loop-rec-btn");w&&(e.looperState==="recording"||e.looperState==="overdubbing"?w.classList.add("active","recording"):w.classList.remove("active","recording"),w.textContent=e.looperState==="recording"?"REC":e.looperState==="overdubbing"?"DUB":"REC");const C=this.container.querySelector("#loop-play-btn");C&&(e.looperState==="playing"?C.classList.add("active"):C.classList.remove("active"),C.textContent=e.looperState==="playing"?"STOP":"PLAY");const P=(b,S)=>{const A=this.container.querySelector(`#${b}`);A&&document.activeElement!==A&&(A.value=S)};P("voicing-dial",e.voicingCenter),P("filter-dial",e.filterCutoff),P("bass-voicing-dial",e.bassVoicing),P("bass-vol-dial",e.bassVolume);const R=this.container.querySelector("#voicing-knob");if(R){const b=this.getVoicingRotation(e.voicingCenter);R.style.setProperty("--dial-rotation",`${b}deg`),this._voicingDialValue=e.voicingCenter}const G=this.container.querySelector("#bass-knob");if(G){const b=this.getBassVoicingRotation(e.bassVoicing);G.style.setProperty("--dial-rotation",`${b}deg`),this._bassVoicingDialValue=e.bassVoicing}}renderKeyboard(e){const t=[{note:"C",type:"white"},{note:"C#",type:"black"},{note:"D",type:"white"},{note:"D#",type:"black"},{note:"E",type:"white"},{note:"F",type:"white"},{note:"F#",type:"black"},{note:"G",type:"white"},{note:"G#",type:"black"},{note:"A",type:"white"},{note:"A#",type:"black"},{note:"B",type:"white"}],s=document.getElementById("keyboard");s&&(s.innerHTML=t.map(i=>`
        <div class="key ${i.type}" data-note="${i.note}"></div>
      `).join(""))}attachEvents(){let e=null,t=!1,s=null,i=!1,n=null,o=!1,r=null,c=!1,u=null,h=!1,p=!1,g=null;this.container.addEventListener("pointerdown",l=>{const f=l.target.closest("[data-type]");if(f&&(f.classList.contains("perf-btn")||f.closest("#type-controls"))){l.preventDefault(),this.actions.pressChordType(f.dataset.type);return}const v=l.target.closest(".key");if(v){l.preventDefault(),v.hasPointerCapture&&v.hasPointerCapture(l.pointerId)&&v.releasePointerCapture(l.pointerId);const E=v.dataset.note;g!==E&&(this.actions.playNote(E),g=E)}}),this.container.addEventListener("pointerover",l=>{if(l.buttons===1){const f=l.target.closest(".key");if(f){const v=f.dataset.note;g!==v&&(this.actions.playNote(v),g=v)}}}),this.container.addEventListener("pointerup",l=>{const f=l.target.closest("[data-type]");if(f&&(f.classList.contains("perf-btn")||f.closest("#type-controls"))){l.preventDefault(),this.actions.releaseChordType(f.dataset.type);return}const v=l.target.closest(".key");v&&(l.preventDefault(),this.actions.stopNote(v.dataset.note),g===v.dataset.note&&(g=null))}),this.container.addEventListener("pointerout",l=>{const f=l.target.closest(".key");if(f){if(l.preventDefault(),f.contains(l.relatedTarget))return;this.actions.stopNote(f.dataset.note),g===f.dataset.note&&(g=null)}}),this.container.addEventListener("mousedown",l=>{l.target.closest('.encoder[data-encoder="bass"]')&&(t=!1,e=setTimeout(()=>{t=!0,this.actions.cycleBassMode()},500)),l.target.closest('.encoder[data-encoder="key"]')&&(i=!1,s=setTimeout(()=>{i=!0,this.actions.cycleKeyScale()},500)),l.target.closest('.encoder[data-encoder="perform"]')&&(o=!1,n=setTimeout(()=>{o=!0,this.actions.cycleArpPattern()},500)),l.target.closest('.encoder[data-encoder="bpm"]')&&(c=!1,r=setTimeout(()=>{c=!0,this.actions.toggleMetronome()},500)),l.target.closest('.encoder[data-encoder="loop"]')&&(h=!1,u=setTimeout(()=>{h=!0,this.actions.loopStop()},500))}),this.container.addEventListener("mouseup",l=>{e&&(clearTimeout(e),e=null),s&&(clearTimeout(s),s=null),n&&(clearTimeout(n),n=null),r&&(clearTimeout(r),r=null),u&&(clearTimeout(u),u=null),p=!1}),this.container.addEventListener("mouseleave",l=>{e&&(clearTimeout(e),e=null),s&&(clearTimeout(s),s=null),n&&(clearTimeout(n),n=null),r&&(clearTimeout(r),r=null),u&&(clearTimeout(u),u=null)}),this.container.addEventListener("click",l=>{var G;const f=l.target,v=l.target.closest('.encoder[data-encoder="key"]');if(v&&l.shiftKey){this.actions.toggleKeyAutoChords();return}if(v&&!i){this.actions.toggleKey();return}if(l.target.closest('.encoder[data-encoder="bass"]')&&!t){(G=this.state)!=null&&G.bassEnabled?this.actions.cycleBassMode():this.actions.toggleBass(),this.encoderEngaged.set("bass",!0);return}if(l.target.closest('.encoder[data-encoder="perform"]')&&!o){this.actions.cyclePerformMode(),this.encoderEngaged.set("perform",!0);return}if(l.target.closest('.encoder[data-encoder="bpm"]')&&!c){this.actions.toggleBeatEngine(),this.encoderEngaged.set("bpm",!0);return}if(l.target.closest('.encoder[data-encoder="loop"]')&&!h){l.shiftKey?this.actions.undoLoop():this.actions.clickLoopEncoder(),this.encoderEngaged.set("loop",!0);return}if(l.target.closest('.encoder[data-encoder="fx"]')){this.encoderEngaged.set("fx",!0),this._currentFxValue===void 0&&(this._currentFxValue=0),l.shiftKey?this.actions.toggleFxLock():this.actions.cycleFxType();return}if(l.target.closest('.encoder[data-encoder="options"]')){this.actions.cyclePlaystyle();return}if(f.id==="power-btn"&&this.actions.togglePower(),f.closest("#ext-controls button")){const b=f.closest("button").dataset.ext;this.actions.toggleExtension(b)}f.classList.contains("perf-btn")&&f.dataset.ext&&this.actions.toggleExtension(f.dataset.ext),f.id==="loop-rec-btn"&&this.actions.toggleLoopRecord(),f.id==="loop-play-btn"&&this.actions.toggleLoopPlay(),f.id==="loop-undo-btn"&&this.actions.undoLoop(),f.id==="bass-mode-btn"&&this.actions.cycleBassMode()}),this.container.addEventListener("input",l=>{l.target.id==="voicing-dial"&&this.actions.setVoicing(parseInt(l.target.value)),l.target.id==="filter-dial"&&this.actions.setFilter(parseInt(l.target.value)),l.target.id==="bass-voicing-dial"&&this.actions.setBassVoicing(parseInt(l.target.value)),l.target.id==="bass-vol-dial"&&this.actions.setBassVolume(parseInt(l.target.value))});let d=null;const m=(l,f,v,{fine:E=!1}={})=>{const L=E?1:3,w=(P,R,G)=>Math.max(R,Math.min(G,P));if(this.encoderEngaged.set(l,!0),l==="volume")if(p){this._currentBassVolume===void 0&&(this._currentBassVolume=60);const R=w(this._currentBassVolume+f*L,0,99);if(R!==this._currentBassVolume){this._currentBassVolume=R,this._bassVolumeFlashUntil=Date.now()+1200,this.actions.setBassVolume(this._currentBassVolume);const G=this._currentBassVolume/99*270-135,b=v.querySelector(".encoder-knob");b&&(b.style.transform=`rotate(${G}deg)`);const S=this.container.querySelector(".oled-volume");S&&(S.textContent=`BASS ${this._currentBassVolume}`)}return}else{this._currentVolume===void 0&&(this._currentVolume=70);const R=w(this._currentVolume+f*L,0,99);if(R!==this._currentVolume){this._currentVolume=R,this.actions.setVolume(this._currentVolume);const G=this._currentVolume/99*270-135,b=v.querySelector(".encoder-knob");b&&(b.style.transform=`rotate(${G}deg)`)}return}if(l==="bass"){this._currentBassVolume===void 0&&(this._currentBassVolume=60);const P=w(this._currentBassVolume+f*L,0,99);if(P!==this._currentBassVolume){this._currentBassVolume=P,this._bassVolumeFlashUntil=Date.now()+1200,this.actions.setBassVolume(this._currentBassVolume);const R=this._currentBassVolume/99*270-135,G=v.querySelector(".encoder-knob");G&&(G.style.transform=`rotate(${R}deg)`);const b=this.container.querySelector(".oled-volume");b&&(b.textContent=`BASS ${this._currentBassVolume}`)}return}if(l==="fx"){this._currentFxValue===void 0&&(this._currentFxValue=0);const P=w(this._currentFxValue+f*L,0,99);if(P!==this._currentFxValue){this._currentFxValue=P;const R=this._fxStateSnapshot&&this._fxStateSnapshot.currentEffect||this._lastFxEffect||"reverb";R!=="direct"&&this.actions.setFxLevel(R,this._currentFxValue);const G=v.querySelector(".encoder-knob");if(G){const S=this._currentFxValue/99*270-135;G.style.transform=`rotate(${S}deg)`}const b=this.container.querySelector(".oled-fx-value");if(b){const S=this._fxStateSnapshot||{},A={...S.fxLevels||{},[R]:this._currentFxValue},N={currentEffect:R,fxLevels:A,fxLocked:S.fxLocked||!1};b.textContent=`${this.getFxDisplay(N)} ${this.getFxLevel(N)}`}}return}if(l==="perform"){this._currentPerformValue===void 0&&(this._currentPerformValue=50);const P=w(this._currentPerformValue+f*L,0,99);if(P!==this._currentPerformValue){this._currentPerformValue=P,this.actions.setPerformValue(this._currentPerformValue);const R=this._currentPerformValue/99*270-135,G=v.querySelector(".encoder-knob");G&&(G.style.transform=`rotate(${R}deg)`)}return}if(l==="bpm"){if(this.state&&this.state.beatEnabled){this.encoderRotations[l]||(this.encoderRotations[l]=0),this.encoderRotations[l]+=f*3;const R=v.querySelector(".encoder-knob");if(R&&(R.style.transform=`rotate(${this.encoderRotations[l]}deg)`),Math.abs(f)>=1){const G=f>0?1:-1;this.actions.cycleBeatPattern(G)}return}this._currentBpmValue===void 0&&(this._currentBpmValue=36);const P=w(this._currentBpmValue+f*L,0,99);if(P!==this._currentBpmValue){this._currentBpmValue=P;const R=Math.round(20+this._currentBpmValue/99*280);this.actions.setBpm(R);const G=this._currentBpmValue/99*270-135,b=v.querySelector(".encoder-knob");b&&(b.style.transform=`rotate(${G}deg)`)}return}this.encoderRotations[l]||(this.encoderRotations[l]=0),this.encoderRotations[l]+=f*3;const C=v.querySelector(".encoder-knob");if(C&&(C.style.transform=`rotate(${this.encoderRotations[l]}deg)`),Math.abs(f)>=1){const P=f>0?1:-1;l==="sound"&&this.actions.cyclePatch(-P),l==="key"&&this.actions.cycleKeyRoot(P),l==="options"&&this.actions.cyclePlaystyle(P),l==="loop"&&this.actions.cycleLoopEncoder(P)}};this.container.addEventListener("mousedown",l=>{const f=l.target.closest(".encoder[data-encoder]");if(f){const v=f.dataset.encoder;l.preventDefault(),f.classList.add("dragging"),document.body.style.cursor="ns-resize",v==="volume"&&(p=!0),v==="fx"&&this._currentFxValue===void 0&&(this._currentFxValue=0),d={encoder:f,encoderName:v,startY:l.clientY,lastY:l.clientY,fine:l.shiftKey}}}),document.addEventListener("mousemove",l=>{if(!d)return;const E=(d.lastY-l.clientY)/2;Math.abs(E)>=1&&(m(d.encoderName,E,d.encoder,{fine:d.fine}),d.lastY=l.clientY)}),document.addEventListener("mouseup",()=>{d&&(d.encoder.classList.remove("dragging"),document.body.style.cursor="",d=null),p=!1}),this.container.addEventListener("wheel",l=>{const f=l.target.closest(".encoder[data-encoder]");if(f){l.preventDefault();const v=f.dataset.encoder,E=l.deltaY>0?-5:5,L=p;v==="volume"&&(p=l.shiftKey||L),m(v,E,f,{fine:l.shiftKey}),this.encoderEngaged.set(v,!0),p=L}},{passive:!1});const y=(l,f,v)=>Math.max(f,Math.min(v,l)),T=l=>l?1:2,x=(l,f,v)=>{var E,L;if(l==="voicing"){const w=this._voicingDialValue??((E=this.state)==null?void 0:E.voicingCenter)??60,C=y(w+f*T(v),36,84);C!==w&&(this._voicingDialValue=C,this.actions.setVoicing(C))}else if(l==="bassVoicing"){const w=this._bassVoicingDialValue??((L=this.state)==null?void 0:L.bassVoicing)??0,C=y(w+f*T(v),-24,24);C!==w&&(this._bassVoicingDialValue=C,this.actions.setBassVoicing(C))}};let M=null;this.container.addEventListener("mousedown",l=>{const f=l.target.closest("#voicing-knob, #bass-knob");f&&(l.preventDefault(),M={knob:f,type:f.id==="voicing-knob"?"voicing":"bassVoicing",lastY:l.clientY,fine:l.shiftKey},document.body.style.cursor="ns-resize")}),document.addEventListener("mousemove",l=>{if(!M)return;const E=(M.lastY-l.clientY)/3;Math.abs(E)>=1&&(x(M.type,E,M.fine),M.lastY=l.clientY)}),document.addEventListener("mouseup",()=>{M&&(M=null,document.body.style.cursor="")}),this.container.addEventListener("wheel",l=>{const f=l.target.closest("#voicing-knob, #bass-knob");if(f){l.preventDefault();const v=f.id==="voicing-knob"?"voicing":"bassVoicing",E=l.deltaY>0?-1:1;x(v,E,l.shiftKey)}},{passive:!1});const V=document.getElementById("flavour-toggle");V&&V.addEventListener("click",()=>this.actions.toggleFlavour());const k=document.getElementById("record-btn");k&&k.addEventListener("click",()=>this.actions.toggleRecording())}}const $={h:"C",u:"C#",j:"D",i:"D#",k:"E",l:"F",o:"F#",";":"G",p:"G#","'":"A","[":"A#","]":"B"},K={12:"6",14:"7",16:"maj7",17:"9"},j={q:"6",w:"7",e:"maj7",r:"9"},we={a:"major",s:"minor",d:"suspended",f:"diminished"},Se={ArrowUp:1,ArrowDown:-1};class Pe{constructor(){this.audio=new ye,this.logic=new ve,this.voicing=new be,this.stateManager=new q,this.midi=new Te({onNoteOn:(t,s)=>this.handleMidiNoteOn(t,s),onNoteOff:t=>this.handleMidiNoteOff(t),onControlChange:(t,s)=>this.handleMidiControlChange(t,s),onPitchBend:(t,s)=>this.handleMidiPitchBend(t,s),onConnection:(t,s)=>this.stateManager.setMidiConnected(s)}),this.looper=new Me(this.audio.ctx,{onPlay:(t,s)=>this.audio.playNote(t),onStop:t=>this.stopNoteFromLooper(t),onProgress:(t,s,i)=>this.updateLoopProgress(t,s,i),onMetronome:(t,s)=>this.audio.playClick(t,s)}),this.beatEngine=new xe(this.audio.ctx),this.beatEngine.output.connect(this.audio.masterGain),this.arpeggiator=new Ee(this.audio.ctx,{onNoteOn:(t,s)=>this.audio.playArpNote(t,s),onNoteOff:t=>{}}),this.patternPlayer=new ke(this.audio.ctx,{onNoteOn:(t,s)=>this.audio.playArpNote(t,s),onNoteOff:t=>{}}),this.strumVoices=new Map,this.strummer=new Ve({onNoteOn:(t,s)=>{const i=this.audio.playNote(t,s/127);this.strumVoices.set(t,i)},onNoteOff:t=>{const s=this.strumVoices.get(t);s&&(this.audio.stopNote(s),this.strumVoices.delete(t))}}),this.currentRecordedNotes=new Set,this.heldChordType=null,this.playstyleForceSingle=!1,this.playstyleOverrideType=null,this._boundKeyDown=t=>this.handleKeyDown(t),this._boundKeyUp=t=>this.handleKeyUp(t);const e=document.querySelector("#synth-interface");this.ui=new Le(e,{togglePower:()=>this.stateManager.setPower(!this.stateManager.get("powered")),setChordType:t=>this.stateManager.setChordType(t),toggleExtension:t=>this.stateManager.toggleExtension(t),setRoot:t=>this.stateManager.setRoot(t),setVoicing:t=>this.stateManager.setVoicingCenter(t),setFilter:t=>this.stateManager.setFilterCutoff(t),setBassVoicing:t=>this.stateManager.setBassVoicing(t),setBassVolume:t=>this.stateManager.setBassVolume(t),setVolume:t=>this.stateManager.setVolume(t),toggleFlavour:()=>this.stateManager.toggleFlavour(),toggleBass:()=>this.stateManager.toggleBass(),cycleBassMode:()=>this.stateManager.cycleBassMode(),cyclePatch:t=>this.stateManager.cyclePatch(t),toggleRecording:()=>this.toggleRecording(),toggleKey:()=>this.stateManager.toggleKey(),toggleKeyAutoChords:()=>this.stateManager.toggleKeyAutoChords(),cycleKeyRoot:t=>this.stateManager.cycleKeyRoot(t),cycleKeyScale:()=>this.stateManager.cycleKeyScale(),setPlaystyle:t=>this.stateManager.setPlaystyle(t),cyclePlaystyle:()=>this.stateManager.cyclePlaystyle(),pressChordType:t=>this.handleChordTypePress(t),releaseChordType:t=>this.handleChordTypeRelease(t),playNote:t=>{const s=this.logic.getMidiRoot(t);this.handleMidiNoteOn(s,100)},stopNote:t=>{const s=this.logic.getMidiRoot(t);this.handleMidiNoteOff(s)},cyclePerformMode:()=>this.stateManager.cyclePerformMode(),cycleArpPattern:()=>this.stateManager.cycleArpPattern(),setPerformValue:t=>this.setPerformValue(t),setBpm:t=>this.stateManager.setBpm(t),tapTempo:()=>this.tapTempo(),toggleMetronome:()=>this.stateManager.toggleMetronome(),toggleBeatEngine:()=>{const t=!this.stateManager.get("beatEnabled");this.stateManager.setBeatEnabled(t)},cycleBeatPattern:t=>this.stateManager.cycleBeatPattern(t),cycleFxType:()=>this.stateManager.cycleCurrentEffect(),setFxLevel:(t,s)=>this.stateManager.setFxLevel(t,s),adjustFxLevel:(t,s)=>this.stateManager.adjustFxLevel(t,s),toggleFxLock:()=>this.stateManager.toggleFxLock(),toggleLoopRecord:()=>this.toggleLoopRecord(),toggleLoopPlay:()=>this.toggleLoopPlay(),loopRecord:()=>{if(this.looper.state==="idle"){const t=this.stateManager.state.loopLength==="free"?0:this.stateManager.state.loopLength;let s=null;this.stateManager.state.beatEnabled&&t!==0&&(s=this.beatEngine.getNextBarTime()),this.looper.record(t,s)}this.stateManager.setLooperState(this.looper.state)},loopOverdub:()=>{this.looper.state==="playing"&&this.looper.overdub(),this.stateManager.setLooperState(this.looper.state)},loopStop:()=>{this.looper.stop(),this.stateManager.setLooperState(this.looper.state)},loopClear:()=>{this.looper.stop(),this.looper.layers=[],this.stateManager.setLooperState(this.looper.state)},undoLoop:()=>{this.looper.undo(),this.stateManager.setLooperState(this.looper.state)},cycleLoopEncoder:t=>{this.looper.state==="idle"?this.stateManager.cycleLoopLength(t):this.stateManager.cycleLoopMenu(t)},clickLoopEncoder:()=>this.handleClickLoopEncoder()}),this.init()}get state(){return this.stateManager.state}async init(){this.ui.mount(this.stateManager.state),this.audio.setVolume(this.stateManager.state.volume),this.audio.setBassVolume(this.stateManager.state.bassVolume),this.audio.setFilterCutoff(this.stateManager.state.filterCutoff),this.audio.setFxLevels(this.stateManager.state.fxLevels),this.audio.setFxBpm(this.stateManager.state.bpm),this.audio.setFxBypass(this.stateManager.state.currentEffect==="direct"),this.audio.setFlavourEnabled(this.stateManager.state.flavourEnabled),this.stateManager.subscribe((e,t)=>{this.ui.update(e),this.handleStateChange(e,t)}),window.addEventListener("keydown",this._boundKeyDown),window.addEventListener("keyup",this._boundKeyUp),await this.midi.init()}destroy(){window.removeEventListener("keydown",this._boundKeyDown),window.removeEventListener("keyup",this._boundKeyUp),this.midi.destroy(),this.looper.stop(),this.audio.stopAll()}setKeyPressed(e,t){const s=document.querySelector(`.key[data-note="${e}"]`);s&&s.classList.toggle("pressed",t)}getPlaybackOptions(){const e=this.stateManager.state,t=e.keyEnabled&&e.keyAutoChords;return{forceSingle:t?!1:this.playstyleForceSingle,overrideType:t?null:this.playstyleOverrideType}}handleChordTypePress(e){this.stateManager.get("keyEnabled")&&this.stateManager.get("keyAutoChords")&&this.stateManager.setKeyAutoChords(!1),this.heldChordType=e;const t=this.stateManager.get("playstyle"),s=this.stateManager.state.activeMidiNotes.size>0;t==="simple"&&s||(this.stateManager.setChordType(e),(t==="advanced"||t==="free")&&s&&(this.playstyleForceSingle=!1,this.playstyleOverrideType=e,this.playCurrentChord({forceSingle:!1,overrideType:e})))}handleChordTypeRelease(e){this.heldChordType===e&&(this.heldChordType=null);const t=this.stateManager.get("playstyle");this.stateManager.state.activeMidiNotes.size>0&&(t==="free"||t==="advanced"?(this.playstyleForceSingle=!1,this.playstyleOverrideType=null,this.playCurrentChord({forceSingle:!1})):t==="simple"&&(this.playstyleForceSingle=!0,this.playstyleOverrideType=null,this.playCurrentChord({forceSingle:!0})))}handleStateChange(e,t){const s=["powered","root","type","extensions","voicingCenter","filterCutoff","midiConnected","activeMidiNotes","looperState","isPlaying","bassEnabled","bassMode","bassVoicing","bassVolume","volume","flavourEnabled","currentPatch","keyEnabled","keyRoot","keyScale","keyAutoChords","performMode","arpPattern","arpDivision","arpOctave","strumSpeed","rhythmPattern","playstyle","bpm","metronomeOn","currentEffect","fxLocked","fxLevels","recording"];for(const n of t)s.includes(n)||console.warn(`[Poorchid] Unknown state key changed: '${n}'`);if(t.includes("filterCutoff")&&this.audio.setFilterCutoff(e.filterCutoff),t.includes("bassVolume")&&this.audio.setBassVolume(e.bassVolume),t.includes("volume")&&this.audio.setVolume(e.volume),t.includes("flavourEnabled")&&this.audio.setFlavourEnabled(e.flavourEnabled),t.includes("currentPatch")&&this.audio.setPatch(e.currentPatch),t.includes("bpm")&&(this.arpeggiator.setBpm(e.bpm),this.patternPlayer.setBpm(e.bpm),this.audio.setFxBpm(e.bpm),this.looper.setBpm(e.bpm)),t.includes("arpPattern")&&this.arpeggiator.setPattern(e.arpPattern),t.includes("arpDivision")&&this.arpeggiator.setDivision(e.arpDivision),t.includes("arpOctave")&&this.arpeggiator.setOctaveRange(e.arpOctave),t.includes("strumSpeed")&&this.strummer.setSpeed(e.strumSpeed),t.includes("rhythmPattern")&&this.patternPlayer.setPattern(e.rhythmPattern),t.includes("performMode")&&(e.performMode!=="arp"&&this.arpeggiator.stop(),e.performMode!=="pattern"&&this.patternPlayer.stop(),["strum","strum2","slop","harp"].includes(e.performMode)?this.strummer.setMode(e.performMode):this.strummer.release()),t.includes("fxLevels")&&this.audio.setFxLevels(e.fxLevels),t.includes("currentEffect")){const n=e.currentEffect==="direct";this.audio.setFxBypass(n)}t.includes("fxLocked"),t.includes("playstyle")&&(e.playstyle==="simple"&&!this.heldChordType&&(this.playstyleForceSingle=!0,this.playstyleOverrideType=null),e.isPlaying&&this.playCurrentChord(this.getPlaybackOptions())),t.includes("powered")&&(e.powered?this.audio.resume():(this.audio.stopAll(),this.arpeggiator.stop(),this.strummer.release(),this.stateManager.setIsPlaying(!1))),t.includes("bassEnabled")&&!e.bassEnabled&&this.audio.stopBass(),t.includes("bassMode")&&e.bassMode==="direct"&&this.audio.stopBass();const i=["type","extensions","voicingCenter","bassMode","bassVoicing","bassEnabled","keyAutoChords"];e.powered&&(t.includes("root")?this.playCurrentChord(this.getPlaybackOptions()):e.isPlaying&&t.some(n=>i.includes(n))&&this.playCurrentChord(this.getPlaybackOptions())),t.includes("beatEnabled")&&(e.beatEnabled?this.beatEngine.start():this.beatEngine.stop()),t.includes("beatPattern")&&this.beatEngine.setPattern(e.beatPattern),t.includes("bpm")&&this.beatEngine.setBpm(e.bpm)}playCurrentChord(e={}){const t=this.stateManager.state;let s=t.root,i=0;if(t.activeMidiNotes.size>0){const d=Array.from(t.activeMidiNotes);let m=null;for(let y=d.length-1;y>=0;y--)if(this.logic.getNoteName(d[y])===t.root){m=d[y];break}if(m!==null){const y=this.logic.getMidiRoot(t.root);i=m-y}}let n=e.overrideType||t.type,o=!!e.forceSingle;["strum","strum2","slop","harp"].includes(t.performMode)&&(o=!1),t.keyEnabled&&t.keyAutoChords&&(s=this.logic.quantizeRoot(s,t.keyRoot,t.keyScale),n=this.logic.getDiatonicChordType(s,t.keyRoot,t.keyScale),o=!1);const c=o?[this.logic.getMidiRoot(s)]:this.logic.getNotes(s,n,Array.from(t.extensions)),u=Math.max(0,Math.min(127,t.voicingCenter+i)),h=this.voicing.getVoicing(c,u),g=this.logic.getMidiRoot(t.root)+i-24+t.bassVoicing;if(t.performMode==="arp"){if(this.arpeggiator.updateNotes(h),!this.arpeggiator.isRunning){let d=null;t.beatEnabled&&(d=this.beatEngine.getNextNoteTime()),this.arpeggiator.start(h,d)}t.bassEnabled&&this.audio.playBass(g),this.stateManager.setIsPlaying(!0);return}else if(["strum","strum2","slop","harp"].includes(t.performMode)){this.strummer.release(),this.strummer.setMode(t.performMode),this.strummer.strum(h),t.bassEnabled&&this.audio.playBass(g),this.stateManager.setIsPlaying(!0);return}else if(t.performMode==="pattern"){if(this.patternPlayer.updateNotes(h),!this.patternPlayer.isRunning){let d=null;t.beatEnabled&&(d=this.beatEngine.getNextNoteTime()),this.patternPlayer.start(h,d)}t.bassEnabled&&this.audio.playBass(g),this.stateManager.setIsPlaying(!0);return}if(this.arpeggiator.isRunning&&this.arpeggiator.stop(),this.patternPlayer.isRunning&&this.patternPlayer.stop(),!t.bassEnabled)this.audio.playChord(h),this.audio.stopBass();else switch(t.bassMode){case"direct":this.audio.playChord(h),this.audio.stopBass();break;case"solo":this.audio.playChord([]),this.audio.playBass(g);break;case"unison":if(this.audio.playChord(h),h.length>0){const d=Math.min(...h);this.audio.playBass(d-12+t.bassVoicing)}break;case"single":this.audio.playChord(h),this.audio.playBass(g);break;case"chords":default:this.audio.playChord(h),h.length>0?this.audio.playBass(g):this.audio.stopBass();break}if(this.stateManager.setIsPlaying(!0),this.looper.state==="recording"||this.looper.state==="overdubbing"){for(const d of this.currentRecordedNotes)h.includes(d)||(this.looper.addEvent({type:"noteOff",note:d}),this.currentRecordedNotes.delete(d));for(const d of h)this.currentRecordedNotes.has(d)||(this.looper.addEvent({type:"noteOn",note:d,velocity:100}),this.currentRecordedNotes.add(d))}}handleClickLoopEncoder(){const e=this.stateManager.state;if(this.looper.state==="idle"){const t=e.loopLength==="free"?0:e.loopLength;let s=null;e.beatEnabled&&t!==0&&(s=this.beatEngine.getNextBarTime()),this.looper.record(t,s)}else if(this.looper.state==="recording")this.looper.play();else switch(e.loopMenu){case"play":if(this.looper.state!=="playing"){let t=null;e.beatEnabled&&(t=this.beatEngine.getNextBarTime()),this.looper.play(t)}break;case"overdub":if(this.looper.state==="playing")this.looper.overdub();else{let t=null;e.beatEnabled&&(t=this.beatEngine.getNextBarTime()),this.looper.play(t)}break;case"stop":this.looper.stop();break;case"undo":this.looper.undo();break;case"clear":this.looper.stop(),this.looper.layers=[];break}this.stateManager.setLooperState(this.looper.state)}toggleLoopRecord(){if(this.looper.state==="idle"){const e=this.stateManager.state.loopLength==="free"?0:this.stateManager.state.loopLength;let t=null;this.stateManager.state.beatEnabled&&e!==0&&(t=this.beatEngine.getNextBarTime()),this.looper.record(e,t)}else this.looper.state==="recording"?this.looper.play():this.looper.state==="playing"?this.looper.overdub():this.looper.state==="overdubbing"&&this.looper.play();this.stateManager.setLooperState(this.looper.state)}toggleLoopPlay(){if(this.looper.state==="playing"||this.looper.state==="overdubbing")this.looper.stop();else{let e=null;this.stateManager.state.beatEnabled&&(e=this.beatEngine.getNextBarTime()),this.looper.play(e)}this.stateManager.setLooperState(this.looper.state)}async toggleRecording(){if(!this.audio.isRecordingSupported()){alert("Recording is not supported in this browser.");return}if(!this.stateManager.get("recording"))this.audio.startRecording()?this.stateManager.setRecording(!0):alert("Could not start recording.");else{this.stateManager.setRecording(!1);const t=await this.audio.stopRecording();t&&this.saveRecording(t)}}saveRecording(e){const t=new Date().toISOString().replace(/[:.]/g,"-"),s=e.type.includes("wav")?"wav":e.type.includes("ogg")?"ogg":"webm",i=`poorchid-${t}.${s}`,n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=i,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(n),1e3)}stopNoteFromLooper(e){const t=this.audio.activeOscillators.get(e);t&&Array.from(t).forEach(s=>this.audio.stopNote(s))}updateLoopProgress(e,t,s){const i=document.querySelector(".reel-progress");if(i){i.style.strokeDashoffset=1-e;const n=document.querySelector(".tape-reel svg");n&&(n.style.transform=`rotate(${e*360}deg)`)}t!==void 0&&s!==void 0&&this.stateManager.setLoopBarsRecorded(`${t}/${s}`)}handleMidiNoteOn(e,t){if(!this.stateManager.get("powered"))return;const s=K[e];if(s){this.stateManager.setExtension(s,!0);return}const i=this.logic.getNoteName(e);if(!i)return;const n=this.stateManager.get("playstyle"),o=this.stateManager.get("keyEnabled")&&this.stateManager.get("keyAutoChords"),r=!!this.heldChordType;let c=o||(n==="simple"?r:!0),u=r?this.heldChordType:null;!c&&n==="advanced"&&this.playstyleOverrideType&&this.stateManager.state.activeMidiNotes.size>0&&(c=!0,u=this.playstyleOverrideType),this.playstyleForceSingle=!c,this.playstyleOverrideType=c?u:null,c&&u&&this.stateManager.setChordType(u),this.stateManager.state.activeMidiNotes.add(e);const h=this.stateManager.get("root")!==i;this.stateManager.setRoot(i),h||this.playCurrentChord(this.getPlaybackOptions()),this.setKeyPressed(i,!0)}handleMidiNoteOff(e){if(!this.stateManager.get("powered"))return;const t=K[e];if(t){this.stateManager.setExtension(t,!1);return}const s=this.logic.getNoteName(e);if(s&&this.setKeyPressed(s,!1),this.stateManager.state.activeMidiNotes.delete(e),this.stateManager.state.activeMidiNotes.size===0){if(this.audio.stopAll(),this.arpeggiator.stop(),this.patternPlayer.stop(),this.strummer.release(),this.stateManager.setIsPlaying(!1),this.playstyleForceSingle=!1,this.playstyleOverrideType=null,this.currentRecordedNotes){for(const i of this.currentRecordedNotes)this.looper.addEvent({type:"noteOff",note:i});this.currentRecordedNotes.clear()}}else if(this.logic.getNoteName(e)===this.stateManager.get("root")&&this.stateManager.state.activeMidiNotes.size>0){const n=Array.from(this.stateManager.state.activeMidiNotes).pop(),o=this.logic.getNoteName(n);this.stateManager.setRoot(o)}}handleMidiControlChange(e,t){if(e===1){const n=100*Math.pow(100,t/127);this.stateManager.setFilterCutoff(Math.round(n))}}handleMidiPitchBend(e,t){}handleKeyDown(e){if(e.repeat||e.ctrlKey||e.metaKey||e.altKey)return;const t=e.key.toLowerCase(),s=j[t];if(s){this.stateManager.setExtension(s,!0);return}const i=we[t];if(i){this.stateManager.get("keyEnabled")&&this.stateManager.get("keyAutoChords")&&this.stateManager.setKeyAutoChords(!1),this.stateManager.setChordType(i);return}const n=Se[t];if(n){const r=this.stateManager.get("voicingCenter"),c=Math.max(36,Math.min(84,r+n));this.stateManager.setVoicingCenter(c);return}const o=$[t];if(o){const r=this.logic.getMidiRoot(o);this.handleMidiNoteOn(r,100)}}handleKeyUp(e){const t=e.key.toLowerCase(),s=j[t];if(s){this.stateManager.setExtension(s,!1);return}const i=$[t];if(i){const n=this.logic.getMidiRoot(i);this.handleMidiNoteOff(n)}}setPerformValue(e){const t=this.stateManager.get("performMode");if(t==="arp"){const s=["1/1","1/2","1/4","1/8","1/16","1/32","1/4T","1/8T","1/16T"],i=Math.min(8,Math.floor(e/11));this.stateManager.setArpDivision(s[i])}else if(["strum","strum2","slop","harp"].includes(t))this.stateManager.setStrumSpeed(e),this.strummer.setSpeed(e);else if(t==="pattern"){const s=["straight","offbeat","pulse","tresillo","clave","shuffle","waltz","funk"],i=Math.min(7,Math.floor(e/12.5));this.stateManager.setRhythmPattern(s[i])}}tapTempo(){const e=this.arpeggiator.tapTempo();this.stateManager.setBpm(e)}}document.querySelector("#synth-interface")&&new Pe;
